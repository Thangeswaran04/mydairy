<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyDiary — My Personal World</title>
    <!-- Supabase SDK -->
    <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
    <style>
        /* ── Login Page ── */
        #loginPage {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: linear-gradient(135deg, #1a1a2e 0%, #0f0f1a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }
        #loginPage.hidden { display: none; }

        .login-card {
            background: rgba(28, 28, 45, 0.95);
            border: 1px solid rgba(255, 215, 140, 0.2);
            border-radius: 20px;
            padding: 2.5rem 2rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 24px 80px rgba(0,0,0,0.5);
            animation: loginFadeIn 0.4s ease;
        }

        @keyframes loginFadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .login-icon {
            width: 72px; height: 72px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd78c, #ffb84d);
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem;
            margin: 0 auto 1.5rem;
            box-shadow: 0 8px 24px rgba(255, 184, 77, 0.3);
        }

        .login-card h2 {
            text-align: center;
            font-size: 1.4rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ffd78c, #ffb84d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.4rem;
        }

        .login-card .subtitle {
            text-align: center;
            color: #7a7a8c;
            font-size: 0.85rem;
            margin-bottom: 2rem;
        }

        .field-group { margin-bottom: 1.1rem; }

        .field-group label {
            display: block;
            font-size: 0.78rem;
            color: #a0a0b0;
            margin-bottom: 0.4rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .field-wrap { position: relative; }

        .field-wrap input {
            width: 100%;
            background: rgba(40, 40, 58, 0.8);
            border: 1.5px solid rgba(255, 215, 140, 0.15);
            border-radius: 10px;
            padding: 0.8rem 2.8rem 0.8rem 1rem;
            color: #e8e8e8;
            font-size: 0.95rem;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .field-wrap input:focus {
            border-color: rgba(255, 215, 140, 0.5);
            box-shadow: 0 0 0 3px rgba(255, 215, 140, 0.08);
        }

        .toggle-eye {
            position: absolute;
            right: 0.75rem; top: 50%;
            transform: translateY(-50%);
            cursor: pointer; font-size: 1rem;
            color: #7a7a8c; user-select: none; padding: 4px;
        }

        .login-btn {
            width: 100%; padding: 0.9rem;
            background: linear-gradient(135deg, #ffd78c, #ffb84d);
            color: #1a1a2e; border: none; border-radius: 10px;
            font-size: 1rem; font-weight: 700; cursor: pointer;
            margin-top: 0.5rem;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(255,184,77,0.35); }
        .login-btn:active { transform: translateY(0); }

        .login-error {
            background: rgba(255,69,58,0.12);
            border: 1px solid rgba(255,69,58,0.3);
            color: #ff6b6b; border-radius: 8px;
            padding: 0.65rem 1rem; font-size: 0.85rem;
            margin-bottom: 1rem; display: none; text-align: center;
        }
        .login-error.show { display: block; }

        .login-attempts { text-align: center; font-size: 0.75rem; color: #7a7a8c; margin-top: 1rem; }

        .lock-msg {
            text-align: center; color: #ff6b6b; font-size: 0.85rem;
            padding: 1rem; background: rgba(255,69,58,0.1);
            border-radius: 8px; border: 1px solid rgba(255,69,58,0.25); display: none;
        }
        .lock-msg.show { display: block; }

        .setup-note {
            background: rgba(255,215,140,0.08);
            border: 1px solid rgba(255,215,140,0.2);
            border-radius: 8px; padding: 0.65rem 1rem;
            font-size: 0.8rem; color: #ffd78c;
            margin-bottom: 1.25rem; text-align: center; display: none;
        }
        .setup-note.show { display: block; }

        .logout-btn {
            background: rgba(255,69,58,0.12) !important;
            border-color: rgba(255,69,58,0.3) !important;
            color: #ff6b6b !important;
        }

        #appWrapper { display: none; }
        #appWrapper.visible { display: block; }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e8e8e8;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .header {
            background: rgba(15, 15, 25, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 215, 140, 0.2);
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            background: linear-gradient(135deg, #ffd78c 0%, #ffb84d 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 1.75rem;
            margin: 0;
        }
        
        .status {
            color: #34c759;
            font-size: 0.9rem;
        }
        
        .buttons {
            display: flex;
            gap: 0.75rem;
        }
        
        button {
            background: rgba(255, 215, 140, 0.15);
            border: 1px solid rgba(255, 215, 140, 0.3);
            color: #ffd78c;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        button:hover {
            background: rgba(255, 215, 140, 0.25);
            transform: translateY(-1px);
        }
        
        button.danger {
            background: rgba(255, 69, 58, 0.15);
            border-color: rgba(255, 69, 58, 0.3);
            color: #ff6b6b;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .chat-container {
            background: rgba(30, 30, 45, 0.6);
            border-radius: 16px;
            border: 1px solid rgba(255, 215, 140, 0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 200px);
        }
        
        .filter-bar {
            padding: 1rem 2rem;
            background: rgba(20, 20, 30, 0.6);
            border-bottom: 1px solid rgba(255, 215, 140, 0.15);
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .filter-bar select {
            background: rgba(40, 40, 55, 0.6);
            border: 1px solid rgba(255, 215, 140, 0.2);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            color: #e8e8e8;
            font-size: 0.875rem;
            outline: none;
        }
        
        .filter-bar input[type="date"] {
            background: rgba(40, 40, 55, 0.6);
            border: 1px solid rgba(255, 215, 140, 0.2);
            border-radius: 8px;
            padding: 0.5rem 1rem;
            color: #e8e8e8;
            font-size: 0.875rem;
            outline: none;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .message {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .avatar.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .avatar.assistant {
            background: linear-gradient(135deg, #ffd78c 0%, #ffb84d 100%);
        }
        
        .message-content {
            flex: 1;
        }
        
        .bubble {
            padding: 1rem 1.25rem;
            border-radius: 12px;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .bubble.user {
            background: rgba(102, 126, 234, 0.15);
            border: 1px solid rgba(102, 126, 234, 0.3);
        }
        
        .bubble.assistant {
            background: rgba(255, 215, 140, 0.1);
            border: 1px solid rgba(255, 215, 140, 0.2);
        }
        
        .timestamp {
            font-size: 0.75rem;
            color: #6a6a7c;
            margin-top: 0.5rem;
        }
        
        .input-area {
            padding: 1.5rem 2rem;
            background: rgba(20, 20, 30, 0.6);
            border-top: 1px solid rgba(255, 215, 140, 0.15);
        }
        
        .input-wrapper {
            display: flex;
            gap: 1rem;
        }
        
        input[type="text"] {
            flex: 1;
            background: rgba(40, 40, 55, 0.6);
            border: 1px solid rgba(255, 215, 140, 0.2);
            border-radius: 10px;
            padding: 0.875rem 1.25rem;
            color: #e8e8e8;
            font-size: 0.95rem;
            outline: none;
        }
        
        button.send {
            background: linear-gradient(135deg, #ffd78c 0%, #ffb84d 100%);
            color: #1a1a2e;
            border: none;
            font-weight: 600;
            padding: 0.875rem 1.5rem;
        }
        
        button.send:disabled {
            background: rgba(100, 100, 115, 0.3);
            color: #6a6a7c;
            cursor: not-allowed;
        }
        
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .stats-card, .memories-card {
            background: rgba(30, 30, 45, 0.6);
            border-radius: 16px;
            border: 1px solid rgba(255, 215, 140, 0.15);
            padding: 1.5rem;
        }
        
        .stats-card h3, .memories-card h3 {
            color: #ffd78c;
            font-size: 1.1rem;
            margin-bottom: 1rem;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255, 215, 140, 0.1);
        }
        
        .stat-item:last-child {
            border-bottom: none;
        }
        
        .stat-label {
            color: #a0a0b0;
            font-size: 0.875rem;
        }
        
        .stat-value {
            color: #ffd78c;
            font-weight: 600;
        }
        
        .memory-item {
            background: rgba(40, 40, 55, 0.4);
            border: 1px solid rgba(255, 215, 140, 0.15);
            border-radius: 8px;
            padding: 0.875rem;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
        }
        
        .memory-item:hover {
            background: rgba(40, 40, 55, 0.6);
        }
        
        .memory-text {
            color: #e8e8e8;
            margin-bottom: 0.5rem;
        }
        
        .memory-time {
            font-size: 0.7rem;
            color: #7a7a8c;
        }
        
        .memories-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #7a7a8c;
        }
        
        .loading {
            display: flex;
            gap: 0.5rem;
        }
        
        .dot {
            width: 8px;
            height: 8px;
            background: #ffd78c;
            border-radius: 50%;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: rgba(30, 30, 45, 0.95);
            border-radius: 16px;
            border: 1px solid rgba(255, 215, 140, 0.2);
            padding: 2rem;
            max-width: 500px;
            width: 90%;
        }
        
        .modal h2 {
            color: #ffd78c;
            margin-bottom: 1rem;
        }
        
        .modal-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .modal-buttons button {
            flex: 1;
        }
        /* ── Personal Info & Documents Modals ── */
        .big-modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 5000;
            background: rgba(0,0,0,0.75);
            backdrop-filter: blur(6px);
            align-items: flex-start;
            justify-content: center;
            padding: 1.5rem;
            overflow-y: auto;
        }
        .big-modal.show { display: flex; }

        .big-modal-box {
            background: linear-gradient(160deg, #1c1c30 0%, #161625 100%);
            border: 1px solid rgba(255,215,140,0.2);
            border-radius: 20px;
            width: 100%;
            max-width: 820px;
            margin: auto;
            box-shadow: 0 32px 80px rgba(0,0,0,0.6);
            overflow: hidden;
            animation: modalSlideUp 0.3s ease;
        }
        @keyframes modalSlideUp {
            from { opacity:0; transform: translateY(30px); }
            to   { opacity:1; transform: translateY(0); }
        }

        .big-modal-header {
            padding: 1.5rem 1.75rem;
            border-bottom: 1px solid rgba(255,215,140,0.12);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }
        .big-modal-header h2 {
            font-size: 1.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ffd78c, #ffb84d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
        }
        .close-modal-btn {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.1);
            color: #aaa;
            width: 32px; height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .close-modal-btn:hover { background: rgba(255,69,58,0.2); color: #ff6b6b; }

        /* ── Personal Info ── */
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            padding: 1.5rem;
        }
        @media(max-width:600px){ .info-grid { grid-template-columns: 1fr; } }

        .info-field {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
        }
        .info-field label {
            font-size: 0.72rem;
            color: #a0a0b0;
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }
        .info-field input, .info-field textarea, .info-field select {
            background: rgba(40,40,58,0.7);
            border: 1.5px solid rgba(255,215,140,0.15);
            border-radius: 8px;
            padding: 0.65rem 0.9rem;
            color: #e8e8e8;
            font-size: 0.9rem;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
            resize: vertical;
        }
        .info-field input:focus, .info-field textarea:focus {
            border-color: rgba(255,215,140,0.45);
        }
        .info-full { grid-column: 1 / -1; }

        .info-actions {
            padding: 1rem 1.5rem 1.5rem;
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            border-top: 1px solid rgba(255,215,140,0.1);
        }
        .save-btn {
            background: linear-gradient(135deg, #ffd78c, #ffb84d);
            color: #1a1a2e; border: none;
            border-radius: 9px; padding: 0.7rem 1.75rem;
            font-weight: 700; font-size: 0.9rem; cursor: pointer;
        }
        .save-btn:hover { opacity: 0.9; transform: translateY(-1px); }

        .info-saved-toast {
            background: rgba(52,199,89,0.15);
            border: 1px solid rgba(52,199,89,0.3);
            color: #34c759;
            border-radius: 8px; padding: 0.5rem 1rem;
            font-size: 0.82rem; display: none;
            align-items: center; gap: 0.4rem;
        }
        .info-saved-toast.show { display: flex; }

        .lock-note {
            background: rgba(255,215,140,0.07);
            border: 1px solid rgba(255,215,140,0.15);
            border-radius: 8px;
            padding: 0.6rem 1rem;
            font-size: 0.78rem;
            color: #c0a060;
            margin: 0 1.5rem 0;
            display: flex; align-items: center; gap: 0.4rem;
        }

        /* ── Documents ── */
        .doc-toolbar {
            padding: 1rem 1.5rem;
            display: flex;
            gap: 0.75rem;
            align-items: center;
            border-bottom: 1px solid rgba(255,215,140,0.1);
            flex-wrap: wrap;
        }
        .upload-doc-btn {
            background: linear-gradient(135deg, #68d391, #48bb78);
            color: #1a2e1a; border: none;
            border-radius: 8px; padding: 0.6rem 1.2rem;
            font-weight: 700; font-size: 0.875rem; cursor: pointer;
            display: flex; align-items: center; gap: 0.4rem;
        }
        .doc-search {
            flex: 1;
            background: rgba(40,40,58,0.7);
            border: 1px solid rgba(255,215,140,0.15);
            border-radius: 8px;
            padding: 0.55rem 1rem;
            color: #e8e8e8; font-size: 0.875rem;
            outline: none; min-width: 160px;
        }

        .doc-list {
            padding: 1rem 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.65rem;
            max-height: 55vh;
            overflow-y: auto;
        }
        .doc-list::-webkit-scrollbar { width: 5px; }
        .doc-list::-webkit-scrollbar-thumb { background: rgba(255,215,140,0.2); border-radius: 4px; }

        .doc-card {
            background: rgba(40,40,58,0.5);
            border: 1px solid rgba(255,215,140,0.12);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .doc-card:hover { border-color: rgba(255,215,140,0.25); }

        .doc-icon {
            width: 44px; height: 44px;
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }
        .doc-meta { flex: 1; min-width: 0; }
        .doc-name {
            font-weight: 600; font-size: 0.9rem;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            color: #e8e8e8;
        }
        .doc-info { font-size: 0.72rem; color: #7a7a8c; margin-top: 3px; }

        .doc-btns { display: flex; gap: 0.5rem; flex-shrink: 0; }
        .doc-btn {
            background: rgba(255,215,140,0.1);
            border: 1px solid rgba(255,215,140,0.2);
            color: #ffd78c;
            padding: 0.4rem 0.8rem;
            border-radius: 7px; font-size: 0.78rem; cursor: pointer;
            transition: all 0.15s;
        }
        .doc-btn:hover { background: rgba(255,215,140,0.2); }
        .doc-btn.del {
            background: rgba(255,69,58,0.1);
            border-color: rgba(255,69,58,0.25);
            color: #ff6b6b;
        }
        .doc-btn.del:hover { background: rgba(255,69,58,0.2); }

        .doc-viewer {
            position: fixed;
            inset: 0;
            z-index: 6000;
            background: rgba(0,0,0,0.9);
            display: none;
            flex-direction: column;
        }
        .doc-viewer.show { display: flex; }
        .doc-viewer-bar {
            background: rgba(15,15,25,0.95);
            border-bottom: 1px solid rgba(255,215,140,0.15);
            padding: 0.9rem 1.5rem;
            display: flex; align-items: center; gap: 1rem;
        }
        .doc-viewer-title { flex: 1; font-weight: 600; color: #ffd78c; font-size: 0.95rem; }
        .doc-viewer-body { flex: 1; overflow: auto; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .doc-viewer-body iframe { width: 100%; height: 100%; border: none; border-radius: 8px; }
        .doc-viewer-body img { max-width: 100%; max-height: 100%; border-radius: 8px; object-fit: contain; }
        .doc-viewer-body .text-view {
            background: rgba(30,30,45,0.9); border: 1px solid rgba(255,215,140,0.15);
            border-radius: 12px; padding: 1.5rem; max-width: 800px; width: 100%;
            color: #e8e8e8; font-family: monospace; font-size: 0.875rem;
            line-height: 1.7; white-space: pre-wrap; overflow-y: auto; max-height: 80vh;
        }
        .no-docs {
            text-align: center; padding: 3rem 1rem; color: #7a7a8c;
        }
        .no-docs .emoji { font-size: 3rem; margin-bottom: 0.75rem; }

        /* ── Bank Details ── */
        .bank-card {
            background: rgba(40,40,60,0.55);
            border: 1px solid rgba(255,215,140,0.15);
            border-radius: 14px;
            padding: 1.25rem 1.5rem;
            margin-bottom: 1rem;
            position: relative;
        }
        .bank-card-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 1rem;
            cursor: pointer;
        }
        .bank-card-title {
            font-weight: 700; font-size: 1rem;
            background: linear-gradient(135deg,#ffd78c,#ffb84d);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .bank-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.85rem; }
        @media(max-width:600px){ .bank-grid { grid-template-columns: 1fr; } }
        .bank-field { display: flex; flex-direction: column; gap: 0.3rem; }
        .bank-field label { font-size: 0.7rem; color: #a0a0b0; text-transform: uppercase; letter-spacing: 0.05em; }
        .bank-field input {
            background: rgba(30,30,48,0.8);
            border: 1.5px solid rgba(255,215,140,0.12);
            border-radius: 7px; padding: 0.55rem 0.85rem;
            color: #e8e8e8; font-size: 0.875rem; font-family: inherit; outline: none;
        }
        .bank-field input:focus { border-color: rgba(255,215,140,0.4); }
        .bank-full { grid-column: 1 / -1; }
        .atm-preview {
            width: 100%; max-width: 320px; border-radius: 12px;
            margin-top: 0.5rem; display: block;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        }
        .add-bank-btn {
            width: 100%; padding: 0.8rem;
            background: rgba(99,179,237,0.1);
            border: 2px dashed rgba(99,179,237,0.35);
            border-radius: 12px; color: #63b3ed;
            font-size: 0.9rem; font-weight: 600; cursor: pointer;
            transition: all 0.2s; margin-top: 0.5rem;
        }
        .add-bank-btn:hover { background: rgba(99,179,237,0.18); }
        .del-bank-btn {
            background: rgba(255,69,58,0.1); border: 1px solid rgba(255,69,58,0.25);
            color: #ff6b6b; padding: 0.35rem 0.75rem; border-radius: 7px;
            font-size: 0.78rem; cursor: pointer;
        }
        .pin-toggle { cursor: pointer; color: #7a7a8c; font-size: 0.8rem; margin-left: 6px; }
        .bank-scroll { max-height: 70vh; overflow-y: auto; padding: 1.25rem 1.5rem; }
        .bank-scroll::-webkit-scrollbar { width: 5px; }
        .bank-scroll::-webkit-scrollbar-thumb { background: rgba(255,215,140,0.2); border-radius: 4px; }

        /* ── Family Tree ── */
        .family-scroll { max-height: 72vh; overflow-y: auto; padding: 1rem 1.5rem; }
        .family-scroll::-webkit-scrollbar { width: 5px; }
        .family-scroll::-webkit-scrollbar-thumb { background: rgba(255,215,140,0.2); border-radius: 4px; }
        .gen-section { margin-bottom: 1.5rem; }
        .gen-label {
            font-size: 0.72rem; font-weight: 700; color: #ffd78c;
            text-transform: uppercase; letter-spacing: 0.1em;
            margin-bottom: 0.65rem; display: flex; align-items: center; gap: 0.5rem;
        }
        .gen-label::after { content:''; flex:1; height:1px; background:rgba(255,215,140,0.12); }
        .member-cards { display: grid; grid-template-columns: repeat(auto-fill,minmax(180px,1fr)); gap: 0.85rem; }
        .member-card {
            background: rgba(40,40,60,0.55);
            border: 1px solid rgba(255,215,140,0.12);
            border-radius: 14px; padding: 1rem; text-align: center;
            position: relative; transition: border-color 0.2s;
        }
        .member-card:hover { border-color: rgba(255,215,140,0.3); }
        .member-photo {
            width: 72px; height: 72px; border-radius: 50%;
            object-fit: cover; border: 3px solid rgba(255,215,140,0.3);
            cursor: pointer; margin: 0 auto 0.6rem;
            background: rgba(60,60,80,0.7);
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem; overflow: hidden;
        }
        .member-photo img { width:100%; height:100%; object-fit:cover; }
        .member-name-input {
            background: rgba(30,30,48,0.8); border: 1px solid rgba(255,215,140,0.12);
            border-radius: 6px; padding: 0.4rem 0.5rem; color: #e8e8e8;
            font-size: 0.82rem; width: 100%; outline: none; text-align: center; margin-bottom: 0.4rem;
        }
        .member-edu-input {
            background: rgba(30,30,48,0.8); border: 1px solid rgba(255,215,140,0.1);
            border-radius: 6px; padding: 0.35rem 0.5rem; color: #a0a0b0;
            font-size: 0.75rem; width: 100%; outline: none; text-align: center; margin-bottom: 0.4rem;
            resize: none;
        }
        .add-member-btn {
            background: rgba(255,215,140,0.06);
            border: 2px dashed rgba(255,215,140,0.2);
            border-radius: 14px; padding: 1.5rem; color: #7a7a8c;
            cursor: pointer; font-size: 1.5rem; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .add-member-btn:hover { background: rgba(255,215,140,0.1); color: #ffd78c; }
        .del-member-btn {
            position: absolute; top: 6px; right: 6px;
            background: rgba(255,69,58,0.12); border: none; color: #ff6b6b;
            border-radius: 5px; font-size: 0.65rem; cursor: pointer; padding: 2px 6px;
        }
        .my-gen-badge {
            background: linear-gradient(135deg,#ffd78c,#ffb84d);
            color: #1a1a2e; font-size: 0.68rem; font-weight: 700;
            padding: 2px 8px; border-radius: 999px; display: inline-block; margin-top: 2px;
        }
        .family-save-bar {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255,215,140,0.1);
            display: flex; justify-content: flex-end; gap: 0.75rem; align-items: center;
        }
        .family-toast { font-size:0.8rem; color:#34c759; display:none; }
        .family-toast.show { display:block; }

        /* ── Life Graph ── */
        .life-graph-body { padding: 1.25rem 1.5rem; }
        .add-event-row {
            display: flex; gap: 0.75rem; margin-bottom: 1.25rem; flex-wrap: wrap;
        }
        .add-event-row input, .add-event-row select, .add-event-row textarea {
            background: rgba(40,40,58,0.7);
            border: 1.5px solid rgba(255,215,140,0.15);
            border-radius: 8px; padding: 0.6rem 0.9rem;
            color: #e8e8e8; font-size: 0.875rem; font-family: inherit; outline: none;
        }
        .add-event-row input[type="date"] { flex: 0 0 auto; }
        .add-event-row select { flex: 0 0 130px; }
        .add-event-row textarea { flex: 1; min-width: 200px; resize: none; }
        .score-input { flex: 0 0 80px; }
        .add-event-btn {
            background: linear-gradient(135deg,#ffd78c,#ffb84d);
            border: none; border-radius: 8px; color: #1a1a2e;
            font-weight: 700; font-size: 0.875rem; padding: 0.6rem 1.2rem; cursor: pointer;
        }
        .graph-wrap { position: relative; height: 400px; margin-bottom: 1.25rem; background: rgba(15,15,25,0.6); border-radius: 12px; border: 1px solid rgba(255,215,140,0.1); padding: 0.5rem; }
        .graph-toolbar {
            display: flex; gap: 0.5rem; margin-bottom: 0.75rem; flex-wrap: wrap; align-items: center;
        }
        .gtool-btn {
            background: rgba(40,40,58,0.8); border: 1px solid rgba(255,215,140,0.2);
            color: #ffd78c; border-radius: 7px; padding: 0.35rem 0.75rem;
            font-size: 0.78rem; cursor: pointer; transition: all 0.15s;
        }
        .gtool-btn:hover { background: rgba(255,215,140,0.15); }
        .gtool-btn.active { background: rgba(255,215,140,0.25); font-weight: 700; }
        .gtool-sep { width: 1px; height: 20px; background: rgba(255,215,140,0.15); margin: 0 2px; }
        .graph-stats {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.75rem; margin-bottom: 1.25rem;
        }
        .gstat {
            background: rgba(40,40,60,0.55); border: 1px solid rgba(255,215,140,0.12);
            border-radius: 10px; padding: 0.75rem 1rem; text-align: center;
        }
        .gstat-label { font-size: 0.7rem; color: #7a7a8c; text-transform: uppercase; margin-bottom: 0.25rem; }
        .gstat-val { font-size: 1.1rem; font-weight: 700; }
        .events-list-wrap { max-height: 220px; overflow-y: auto; }
        .events-list-wrap::-webkit-scrollbar { width: 5px; }
        .events-list-wrap::-webkit-scrollbar-thumb { background: rgba(255,215,140,0.2); border-radius: 4px; }
        .event-row {
            display: flex; align-items: center; gap: 0.75rem;
            padding: 0.6rem 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.85rem;
        }
        .event-dot { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
        .event-date { color: #7a7a8c; font-size: 0.75rem; flex-shrink: 0; min-width: 80px; }
        .event-score { font-weight: 700; min-width: 36px; text-align: right; flex-shrink: 0; }
        .event-del { margin-left: auto; background:none; border:none; color:#ff6b6b; cursor:pointer; font-size:0.8rem; flex-shrink:0; }
        /* ══════════════════════════════════════════
           MYDIARY NEW UI
           ══════════════════════════════════════════ */
        * { scroll-behavior: smooth; }

        /* ── Navbar ── */
        .diary-nav {
            position: sticky; top: 0; z-index: 200;
            background: rgba(8,8,18,0.97);
            border-bottom: 1px solid rgba(255,215,140,0.15);
            backdrop-filter: blur(20px);
            display: flex; align-items: center; gap: 1.5rem;
            padding: 0.75rem 1.75rem;
            box-shadow: 0 4px 30px rgba(0,0,0,0.4);
        }
        .nav-logo { display:flex; align-items:center; gap:0.5rem; flex-shrink:0; }
        .nav-logo-icon { font-size:1.6rem; }
        .nav-logo-text {
            font-size:1.4rem; font-weight:800; letter-spacing:-0.02em;
            background: linear-gradient(135deg, #ffd78c 0%, #ff9a3c 50%, #ff6b9d 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .nav-links { display:flex; gap:0.25rem; flex:1; justify-content:center; }
        .nav-link {
            padding:0.5rem 1.1rem; border-radius:10px; color:#a0a0b0;
            font-size:0.875rem; font-weight:500; cursor:pointer;
            transition: all 0.2s; text-decoration:none; white-space:nowrap;
        }
        .nav-link:hover { background:rgba(255,215,140,0.1); color:#ffd78c; }
        .nav-link.active { background:rgba(255,215,140,0.15); color:#ffd78c; font-weight:700; }
        .nav-right { display:flex; align-items:center; gap:0.75rem; flex-shrink:0; }
        .nav-profile { display:flex; align-items:center; gap:0.6rem; cursor:pointer; }
        .nav-avatar {
            width:36px; height:36px; border-radius:50%;
            border:2px solid rgba(255,215,140,0.4);
            object-fit:cover; overflow:hidden;
            display:flex; align-items:center; justify-content:center; font-size:1.1rem;
            background: linear-gradient(135deg,#2a2a40,#1a1a2e);
        }
        .nav-avatar img { width:100%; height:100%; object-fit:cover; }
        .nav-username { font-size:0.82rem; color:#ffd78c; font-weight:600; }
        .nav-tools { display:flex; gap:0.35rem; }
        .nav-tool-btn {
            width:34px; height:34px; border-radius:8px; font-size:1rem;
            background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.08);
            cursor:pointer; display:flex; align-items:center; justify-content:center;
            transition:all 0.15s; color:#e8e8e8;
        }
        .nav-tool-btn:hover { background:rgba(255,215,140,0.15); }
        .danger-tool:hover { background:rgba(255,69,58,0.2) !important; }

        /* ── Tab pages ── */
        .tab-page { display:none; min-height:calc(100vh - 60px); }
        .tab-page.active-tab { display:block; }

        /* ── Hero Section ── */
        .hero-section {
            position: relative; overflow: hidden;
            background: radial-gradient(ellipse at 30% 50%, rgba(255,215,140,0.08) 0%, transparent 60%),
                        radial-gradient(ellipse at 70% 50%, rgba(154,117,234,0.08) 0%, transparent 60%),
                        linear-gradient(180deg, #0d0d1a 0%, #1a1a2e 100%);
            padding: 3rem 2rem 2.5rem;
            display: flex; flex-direction:column; align-items:center; gap:2rem;
        }
        .hero-bg-glow {
            position:absolute; top:-50%; left:50%; transform:translateX(-50%);
            width:600px; height:600px; border-radius:50%;
            background: radial-gradient(circle, rgba(255,215,140,0.06) 0%, transparent 70%);
            pointer-events:none; animation: glowPulse 4s ease-in-out infinite;
        }
        @keyframes glowPulse { 0%,100%{opacity:0.5;} 50%{opacity:1;} }

        .live-clock { text-align:center; z-index:1; }
        .clock-time {
            font-size:3.5rem; font-weight:800; letter-spacing:-0.03em;
            background: linear-gradient(135deg, #ffd78c, #ff9a3c);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            font-variant-numeric: tabular-nums;
        }
        .clock-date { color:#a0a0b0; font-size:0.95rem; margin-top:0.25rem; }

        .quote-stage {
            max-width:680px; text-align:center; z-index:1; position:relative;
        }
        .quote-marks {
            font-size:5rem; color:rgba(255,215,140,0.15); font-family:Georgia,serif;
            line-height:0.5; margin-bottom:0.5rem;
        }
        .quote-text {
            font-size:1.2rem; color:#e8e8e8; line-height:1.7; font-style:italic;
            font-weight:300; min-height:60px;
            animation: quoteFade 0.6s ease;
        }
        @keyframes quoteFade { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
        .quote-author { color:#ffd78c; font-size:0.85rem; font-weight:600; margin-top:0.75rem; }
        .quote-dots { display:flex; gap:0.4rem; justify-content:center; margin-top:1rem; }
        .qdot { width:7px; height:7px; border-radius:50%; background:rgba(255,215,140,0.25); cursor:pointer; transition:all 0.2s; }
        .qdot.active { background:#ffd78c; transform:scale(1.3); }

        /* ── Dashboard grid ── */
        .dash-grid {
            display:grid;
            grid-template-columns: repeat(auto-fit, minmax(240px,1fr));
            gap:1.25rem; padding:1.5rem 2rem;
        }
        .dash-card {
            background: rgba(22,22,36,0.8);
            border:1px solid rgba(255,215,140,0.1);
            border-radius:16px; padding:1.25rem;
            backdrop-filter:blur(10px);
            transition: border-color 0.2s, transform 0.2s;
        }
        .dash-card:hover { border-color:rgba(255,215,140,0.25); transform:translateY(-2px); }
        .dash-card-title { font-size:0.78rem; color:#a0a0b0; text-transform:uppercase; letter-spacing:0.08em; margin-bottom:1rem; font-weight:600; }

        /* Mood card */
        .mood-emojis { display:flex; gap:0.5rem; justify-content:center; margin-bottom:0.75rem; flex-wrap:wrap; }
        .mood-btn { font-size:1.8rem; cursor:pointer; transition:transform 0.15s; border-radius:50%; padding:4px; }
        .mood-btn:hover { transform:scale(1.3); }
        .mood-btn.selected { background:rgba(255,215,140,0.15); }
        .mood-selected { text-align:center; font-size:0.82rem; color:#ffd78c; margin-bottom:0.75rem; min-height:1.2em; }
        .streak-row { display:flex; align-items:center; gap:0.4rem; justify-content:center; }
        .streak-fire { font-size:1.3rem; }
        .streak-count { font-size:1.6rem; font-weight:800; color:#ffd78c; }
        .streak-label { font-size:0.78rem; color:#7a7a8c; }

        /* Stats dash */
        .stat-row { display:flex; justify-content:space-between; padding:0.5rem 0; border-bottom:1px solid rgba(255,255,255,0.05); font-size:0.84rem; color:#a0a0b0; }
        .stat-row:last-child { border-bottom:none; }
        .sval { color:#ffd78c; font-weight:700; }

        /* Word of day */
        .wotd-word { font-size:1.6rem; font-weight:800; color:#ffd78c; margin-bottom:0.2rem; }
        .wotd-pos { font-size:0.72rem; color:#9a75ea; text-transform:uppercase; letter-spacing:0.06em; margin-bottom:0.5rem; font-style:italic; }
        .wotd-def { font-size:0.84rem; color:#a0a0b0; line-height:1.5; margin-bottom:0.75rem; min-height:3em; }
        .wotd-btn { background:rgba(154,117,234,0.15); border:1px solid rgba(154,117,234,0.3); color:#9a75ea; border-radius:8px; padding:0.4rem 0.9rem; font-size:0.78rem; cursor:pointer; }

        /* Quick note */
        .quick-note-input {
            width:100%; background:rgba(30,30,48,0.6); border:1.5px solid rgba(255,215,140,0.12);
            border-radius:10px; padding:0.75rem; color:#e8e8e8; font-family:inherit;
            font-size:0.875rem; resize:none; outline:none; min-height:100px;
            line-height:1.6; transition:border-color 0.2s;
        }
        .quick-note-input:focus { border-color:rgba(255,215,140,0.35); }
        .quick-note-saved { font-size:0.72rem; color:#34c759; margin-top:0.35rem; min-height:1em; }

        /* ── Slideshow ── */
        .slideshow-section { padding:1.5rem 2rem 2rem; }
        .section-header { display:flex; align-items:center; gap:1rem; margin-bottom:1.25rem; flex-wrap:wrap; }
        .section-title { font-size:1.2rem; font-weight:700; color:#ffd78c; }
        .slide-upload-btn {
            background:linear-gradient(135deg,#ffd78c,#ffb84d); color:#1a1a2e;
            border:none; border-radius:9px; padding:0.55rem 1.2rem;
            font-weight:700; font-size:0.85rem; cursor:pointer;
        }
        .slideshow-wrap { position:relative; display:none; }
        .slides-track {
            display:flex; gap:1rem; overflow:hidden;
            scroll-behavior:smooth; border-radius:14px;
        }
        .slide-item {
            flex-shrink:0; width:300px; height:200px;
            border-radius:12px; overflow:hidden; position:relative;
            cursor:pointer; border:2px solid rgba(255,215,140,0.1);
            transition:border-color 0.2s, transform 0.2s;
        }
        .slide-item:hover { border-color:rgba(255,215,140,0.4); transform:scale(1.02); }
        .slide-item img { width:100%; height:100%; object-fit:cover; }
        .slide-item .slide-caption {
            position:absolute; bottom:0; left:0; right:0;
            background:linear-gradient(transparent,rgba(0,0,0,0.75));
            padding:0.75rem; font-size:0.75rem; color:#fff;
        }
        .slide-del-btn {
            position:absolute; top:6px; right:6px;
            background:rgba(255,69,58,0.8); border:none; border-radius:6px;
            color:#fff; width:24px; height:24px; font-size:0.7rem; cursor:pointer;
            display:none; align-items:center; justify-content:center;
        }
        .slide-item:hover .slide-del-btn { display:flex; }
        .slide-arrow {
            position:absolute; top:50%; transform:translateY(-50%);
            width:40px; height:40px; border-radius:50%;
            background:rgba(15,15,25,0.8); border:1px solid rgba(255,215,140,0.2);
            color:#ffd78c; font-size:1.5rem; cursor:pointer; z-index:10;
            display:flex; align-items:center; justify-content:center; transition:all 0.2s;
        }
        .slide-arrow:hover { background:rgba(255,215,140,0.2); }
        .left-arrow { left:-20px; }
        .right-arrow { right:-20px; }
        .slide-indicators { display:flex; gap:0.4rem; justify-content:center; margin-top:0.75rem; }
        .slide-ind { width:8px; height:8px; border-radius:50%; background:rgba(255,215,140,0.25); cursor:pointer; transition:all 0.2s; }
        .slide-ind.active { background:#ffd78c; width:20px; border-radius:4px; }
        .empty-slides { text-align:center; padding:2.5rem; color:#7a7a8c; border:2px dashed rgba(255,215,140,0.15); border-radius:14px; }
        .empty-slides span { font-size:2.5rem; display:block; margin-bottom:0.5rem; }

        /* ── Biography Tab ── */
        .bio-page { max-width:900px; margin:0 auto; padding:2rem; }
        .bio-hero {
            background:linear-gradient(135deg,rgba(22,22,36,0.9),rgba(30,30,50,0.9));
            border:1px solid rgba(255,215,140,0.15); border-radius:20px;
            padding:2rem; display:flex; gap:2rem; align-items:center; margin-bottom:1.5rem;
            flex-wrap:wrap;
        }
        .bio-avatar-wrap { position:relative; cursor:pointer; flex-shrink:0; }
        .bio-avatar {
            width:120px; height:120px; border-radius:50%;
            border:4px solid rgba(255,215,140,0.4);
            background:rgba(40,40,60,0.8);
            display:flex; align-items:center; justify-content:center;
            font-size:3.5rem; overflow:hidden;
            box-shadow:0 0 30px rgba(255,215,140,0.2);
            transition:border-color 0.2s;
        }
        .bio-avatar:hover { border-color:rgba(255,215,140,0.7); }
        .bio-avatar img { width:100%; height:100%; object-fit:cover; }
        .bio-avatar-edit {
            position:absolute; bottom:4px; left:50%; transform:translateX(-50%);
            background:rgba(0,0,0,0.75); color:#ffd78c; font-size:0.65rem;
            border-radius:6px; padding:2px 8px; white-space:nowrap; pointer-events:none;
        }
        .bio-hero-info { flex:1; min-width:200px; }
        .bio-name { font-size:2rem; font-weight:800; color:#e8e8e8; margin-bottom:0.3rem; }
        .bio-tagline { color:#ffd78c; font-size:1rem; font-style:italic; margin-bottom:0.75rem; }
        .bio-badges { display:flex; gap:0.5rem; flex-wrap:wrap; }
        .bio-badge {
            background:rgba(154,117,234,0.15); border:1px solid rgba(154,117,234,0.3);
            color:#9a75ea; border-radius:999px; padding:0.25rem 0.75rem; font-size:0.75rem;
        }
        .bio-editor {
            background:rgba(22,22,36,0.8); border:1px solid rgba(255,215,140,0.1);
            border-radius:16px; padding:1.5rem;
        }
        .bio-section-grid { display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-bottom:1rem; }
        @media(max-width:600px){ .bio-section-grid{grid-template-columns:1fr;} }
        .bio-field-block { display:flex; flex-direction:column; gap:0.3rem; }
        .bio-label { font-size:0.72rem; color:#a0a0b0; text-transform:uppercase; letter-spacing:0.05em; }
        .bio-input, .bio-textarea {
            background:rgba(40,40,58,0.7); border:1.5px solid rgba(255,215,140,0.12);
            border-radius:8px; padding:0.65rem 0.9rem; color:#e8e8e8;
            font-size:0.9rem; font-family:inherit; outline:none; transition:border-color 0.2s;
        }
        .bio-input:focus, .bio-textarea:focus { border-color:rgba(255,215,140,0.4); }
        .bio-textarea { resize:vertical; }
        .bio-save-row { display:flex; align-items:center; justify-content:flex-end; gap:1rem; }
        .bio-saved-msg { font-size:0.82rem; color:#34c759; }

        /* ── Journal Tab ── */
        .journal-layout {
            display:grid;
            grid-template-columns:1fr 280px;
            grid-template-rows:auto 1fr auto;
            height:calc(100vh - 61px);
        }
        .journal-topbar {
            grid-column:1/-1; display:flex; gap:0.6rem; align-items:center;
            padding:0.75rem 1.25rem; background:rgba(10,10,20,0.8);
            border-bottom:1px solid rgba(255,215,140,0.1); flex-wrap:wrap;
        }
        .journal-filter-sel {
            background:rgba(40,40,58,0.7); border:1px solid rgba(255,215,140,0.15);
            border-radius:8px; padding:0.45rem 0.8rem; color:#e8e8e8; font-size:0.82rem; outline:none;
        }
        .messages { grid-row:2; grid-column:1; }
        .journal-write-bar {
            grid-row:3; grid-column:1;
            padding:1rem 1.25rem; background:rgba(10,10,20,0.9);
            border-top:1px solid rgba(255,215,140,0.12);
        }
        .journal-entry-wrap { display:flex; gap:0.75rem; align-items:center; }
        .entry-mood-pick { font-size:1.5rem; cursor:pointer; flex-shrink:0; }
        .journal-entry-input {
            flex:1; background:rgba(40,40,58,0.7); border:1.5px solid rgba(255,215,140,0.15);
            border-radius:12px; padding:0.75rem 1rem; color:#e8e8e8; font-size:0.95rem;
            font-family:inherit; outline:none; transition:border-color 0.2s;
        }
        .journal-entry-input:focus { border-color:rgba(255,215,140,0.4); }
        .journal-send-btn {
            background:linear-gradient(135deg,#ffd78c,#ffb84d); border:none;
            border-radius:10px; padding:0.75rem 1.25rem; color:#1a1a2e;
            font-weight:700; cursor:pointer; white-space:nowrap; font-size:0.875rem;
        }
        .journal-hint { font-size:0.72rem; color:#5a5a6c; margin-top:0.4rem; text-align:center; }
        .memories-sidebar {
            grid-row:2/4; grid-column:2;
            padding:1rem; background:rgba(15,15,25,0.6);
            border-left:1px solid rgba(255,215,140,0.1); overflow-y:auto;
        }

        /* ── Gallery Tab ── */
        .gallery-page { padding:1.5rem 2rem; }
        .gallery-header { display:flex; align-items:center; gap:1rem; margin-bottom:1.5rem; }
        .gallery-grid {
            display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
            gap:1rem;
        }
        .gallery-item {
            border-radius:12px; overflow:hidden; aspect-ratio:1;
            border:2px solid rgba(255,215,140,0.1); cursor:pointer;
            position:relative; transition:all 0.2s;
        }
        .gallery-item:hover { border-color:rgba(255,215,140,0.4); transform:scale(1.02); }
        .gallery-item img { width:100%; height:100%; object-fit:cover; }
        .gallery-item .gal-del {
            position:absolute; top:6px; right:6px;
            background:rgba(255,69,58,0.85); border:none; color:#fff;
            border-radius:6px; width:26px; height:26px; font-size:0.7rem;
            cursor:pointer; display:none; align-items:center; justify-content:center;
        }
        .gallery-item:hover .gal-del { display:flex; }
        .gallery-empty { grid-column:1/-1; text-align:center; padding:3rem; color:#7a7a8c; border:2px dashed rgba(255,215,140,0.12); border-radius:14px; }

        /* ── Journal message style update ── */
        .message .bubble.user {
            background:linear-gradient(135deg,rgba(102,126,234,0.15),rgba(154,117,234,0.1));
            border:1px solid rgba(102,126,234,0.25);
        }

        /* ── Fullscreen image viewer ── */
        .img-fullscreen {
            display:none; position:fixed; inset:0; z-index:9000;
            background:rgba(0,0,0,0.92); align-items:center; justify-content:center;
        }
        .img-fullscreen.show { display:flex; }
        .img-fullscreen img { max-width:90vw; max-height:90vh; border-radius:8px; object-fit:contain; }
        .img-fullscreen-close { position:absolute; top:1rem; right:1rem; background:rgba(255,69,58,0.8); border:none; color:#fff; border-radius:50%; width:40px; height:40px; font-size:1.2rem; cursor:pointer; }

    </style>
</head>
<body>

  <!-- Fullscreen image viewer -->
  <div class="img-fullscreen" id="imgFullscreen" onclick="this.classList.remove('show')">
    <img id="imgFullscreenSrc" src="" alt="">
    <button class="img-fullscreen-close">✕</button>
  </div>

    <!-- ══ PERSONAL INFO MODAL ══════════════════════════════ -->
    <div class="big-modal" id="personalInfoModal">
        <div class="big-modal-box">
            <div class="big-modal-header">
                <h2>🗂️ Personal Information</h2>
                <button class="close-modal-btn" onclick="closePersonalInfo()">✕</button>
            </div>
            <div class="lock-note">🔒 This data is permanently stored and cannot be cleared by the Clear All button.</div>
            <div class="info-grid">
                <div class="info-field">
                    <label>Full Name</label>
                    <input type="text" id="pi_name" placeholder="Your full name">
                </div>
                <div class="info-field">
                    <label>Date of Birth</label>
                    <input type="date" id="pi_dob">
                </div>
                <div class="info-field">
                    <label>Phone Number</label>
                    <input type="tel" id="pi_phone" placeholder="+91 xxxxx xxxxx">
                </div>
                <div class="info-field">
                    <label>Email Address</label>
                    <input type="email" id="pi_email" placeholder="you@example.com">
                </div>
                <div class="info-field">
                    <label>Aadhar / National ID</label>
                    <input type="text" id="pi_aadhar" placeholder="XXXX XXXX XXXX">
                </div>
                <div class="info-field">
                    <label>PAN / Tax ID</label>
                    <input type="text" id="pi_pan" placeholder="ABCDE1234F">
                </div>
                <div class="info-field">
                    <label>Blood Group</label>
                    <input type="text" id="pi_blood" placeholder="e.g. O+">
                </div>
                <div class="info-field">
                    <label>Emergency Contact</label>
                    <input type="text" id="pi_emergency" placeholder="Name & phone number">
                </div>
                <div class="info-field info-full">
                    <label>Home Address</label>
                    <textarea id="pi_address" rows="2" placeholder="Your full address"></textarea>
                </div>
                <div class="info-field">
                    <label>Passport Number</label>
                    <input type="text" id="pi_passport" placeholder="XXXXXXXX">
                </div>
                <div class="info-field">
                    <label>Driving Licence No.</label>
                    <input type="text" id="pi_licence" placeholder="DL number">
                </div>
                <div class="info-field">
                    <label>Bank Account No.</label>
                    <input type="text" id="pi_bank" placeholder="Account number">
                </div>
                <div class="info-field">
                    <label>IFSC / Bank Code</label>
                    <input type="text" id="pi_ifsc" placeholder="IFSC code">
                </div>
                <div class="info-field info-full">
                    <label>Additional Notes</label>
                    <textarea id="pi_notes" rows="3" placeholder="Any other important personal info…"></textarea>
                </div>
            </div>
            <div class="info-actions">
                <div class="info-saved-toast" id="infoSavedToast">✅ Saved permanently!</div>
                <button class="save-btn" onclick="savePersonalInfo()">💾 Save Info</button>
            </div>
        </div>
    </div>

    <!-- ══ DOCUMENTS MODAL ══════════════════════════════════ -->
    <div class="big-modal" id="documentsModal">
        <div class="big-modal-box">
            <div class="big-modal-header">
                <h2>📁 Personal Documents</h2>
                <button class="close-modal-btn" onclick="closeDocuments()">✕</button>
            </div>
            <div class="doc-toolbar">
                <button class="upload-doc-btn" onclick="document.getElementById('docUploadInput').click()">
                    ➕ Upload Document
                </button>
                <input type="file" id="docUploadInput" multiple style="display:none"
                    accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.jpg,.jpeg,.png,.gif,.mp4,.zip"
                    onchange="handleDocUpload(event)">
                <input class="doc-search" type="text" id="docSearch" placeholder="🔍 Search documents…" oninput="renderDocList()">
            </div>
            <div class="lock-note" style="margin-bottom:1rem;">🔒 Documents stored permanently — cannot be deleted by Clear All.</div>
            <div class="doc-list" id="docList"></div>
        </div>
    </div>

    <!-- ══ DOCUMENT VIEWER ════════════════════════════════== -->
    <div class="doc-viewer" id="docViewer">
        <div class="doc-viewer-bar">
            <span class="doc-viewer-title" id="viewerTitle">Document</span>
            <button class="doc-btn" id="viewerDownloadBtn">⬇️ Download</button>
            <button class="close-modal-btn" onclick="closeViewer()" style="background:rgba(255,69,58,0.15);border-color:rgba(255,69,58,0.3);color:#ff6b6b;">✕</button>
        </div>
        <div class="doc-viewer-body" id="viewerBody"></div>
    </div>

    <!-- ══ BANK DETAILS MODAL ════════════════════════════════ -->
    <div class="big-modal" id="bankModal">
      <div class="big-modal-box" style="max-width:900px">
        <div class="big-modal-header">
          <h2>🏦 Bank & Card Details</h2>
          <div style="display:flex;gap:0.5rem">
            <button class="save-btn" onclick="saveBanks()">💾 Save</button>
            <button class="close-modal-btn" onclick="document.getElementById('bankModal').classList.remove('show')">✕</button>
          </div>
        </div>
        <div class="lock-note">🔒 Permanently stored. Not affected by Clear All.</div>
        <div class="bank-scroll" id="bankScroll"></div>
        <div style="padding:0 1.5rem 1.5rem">
          <button class="add-bank-btn" onclick="addBankCard()">＋ Add Another Bank Account</button>
        </div>
      </div>
    </div>

    <!-- ══ FAMILY TREE MODAL ══════════════════════════════════ -->
    <div class="big-modal" id="familyModal">
      <div class="big-modal-box" style="max-width:960px">
        <div class="big-modal-header">
          <h2>👨‍👩‍👧‍👦 Family Tree</h2>
          <button class="close-modal-btn" onclick="document.getElementById('familyModal').classList.remove('show')">✕</button>
        </div>
        <div class="lock-note">🔒 Family data stored permanently. Photos cannot be deleted.</div>
        <div class="family-scroll" id="familyScroll"></div>
        <div class="family-save-bar">
          <span class="family-toast" id="familyToast">✅ Saved!</span>
          <button class="save-btn" onclick="saveFamily()">💾 Save Family</button>
        </div>
      </div>
    </div>

    <!-- ══ LIFE GRAPH MODAL ═══════════════════════════════════ -->
    <div class="big-modal" id="lifeGraphModal">
      <div class="big-modal-box" style="max-width:900px">
        <div class="big-modal-header">
          <h2>📈 My Life Graph</h2>
          <button class="close-modal-btn" onclick="document.getElementById('lifeGraphModal').classList.remove('show')">✕</button>
        </div>
        <div class="life-graph-body">
          <!-- Add Event Row -->
          <div class="add-event-row">
            <input type="date" id="lg_date">
            <select id="lg_type">
              <option value="positive">😊 Positive</option>
              <option value="negative">😔 Negative</option>
            </select>
            <input type="number" class="score-input" id="lg_score" min="1" max="250" placeholder="1-250">
            <textarea rows="1" id="lg_desc" placeholder="Describe what happened…"></textarea>
            <button class="add-event-btn" onclick="addLifeEvent()">Add</button>
          </div>
          <!-- Zoom Toolbar -->
          <div class="graph-toolbar">
            <button class="gtool-btn" onclick="zoomLifeChart('in')">🔍＋ Zoom In</button>
            <button class="gtool-btn" onclick="zoomLifeChart('out')">🔍－ Zoom Out</button>
            <button class="gtool-btn" onclick="resetLifeZoom()">⟳ Reset View</button>
            <div class="gtool-sep"></div>
            <button class="gtool-btn" onclick="panLifeChart('left')">← Pan Left</button>
            <button class="gtool-btn" onclick="panLifeChart('right')">Pan Right →</button>
            <div class="gtool-sep"></div>
            <span style="color:#7a7a8c;font-size:0.75rem">🖱️ Scroll to zoom · Drag to pan</span>
          </div>
          <!-- Graph -->
          <div class="graph-wrap">
            <canvas id="lifeChart"></canvas>
          </div>
          <!-- Stats -->
          <div class="graph-stats">
            <div class="gstat">
              <div class="gstat-label">All-Time High</div>
              <div class="gstat-val" id="gs_high" style="color:#34c759">—</div>
            </div>
            <div class="gstat">
              <div class="gstat-label">All-Time Low</div>
              <div class="gstat-val" id="gs_low" style="color:#ff6b6b">—</div>
            </div>
            <div class="gstat">
              <div class="gstat-label">Current Trend</div>
              <div class="gstat-val" id="gs_trend">—</div>
            </div>
            <div class="gstat">
              <div class="gstat-label">Total Events</div>
              <div class="gstat-val" id="gs_total" style="color:#ffd78c">0</div>
            </div>
          </div>
          <!-- Events list -->
          <h3 style="color:#ffd78c;font-size:0.9rem;margin-bottom:0.6rem">📋 All Events</h3>
          <div class="events-list-wrap" id="eventsList"></div>
        </div>
      </div>
    </div>
    <div id="loginPage">
        <div class="login-card">
            <div class="login-icon">📔</div>
            <h2>MyDiary</h2>
            <p class="subtitle">Enter your email & password</p>

            <div class="login-error" id="loginError"></div>

            <div id="loginForm">
                <div class="field-group">
                    <label>Email</label>
                    <div class="field-wrap">
                        <input type="email" id="loginUser" placeholder="your@email.com"
                            autocomplete="email" autocapitalize="none"
                            onkeydown="if(event.key==='Enter') document.getElementById('loginPass').focus()">
                    </div>
                </div>

                <div class="field-group">
                    <label>Password (min 6 characters)</label>
                    <div class="field-wrap">
                        <input type="password" id="loginPass" placeholder="Enter your password"
                            autocomplete="current-password"
                            onkeydown="if(event.key==='Enter') doLogin()">
                        <span class="toggle-eye" onclick="toggleEye()">👁️</span>
                    </div>
                </div>

                <!-- Two clear buttons: Sign In OR Create Account -->
                <button class="login-btn" id="loginBtn" onclick="doLogin(false)" style="margin-bottom:0.6rem">Sign In →</button>
                <button class="login-btn" id="signupBtn" onclick="doLogin(true)" style="background:rgba(255,215,140,0.15);color:#ffd78c;border:1px solid rgba(255,215,140,0.4)">Create Account →</button>

                <div id="loginSpinner" style="display:none;text-align:center;margin-top:1rem;color:#ffd78c">⏳ Please wait…</div>
                <p style="color:#7a7a8c;font-size:0.75rem;text-align:center;margin-top:1rem">
                    First time here? Click <strong style="color:#ffd78c">Create Account</strong>.<br>
                    Already have an account? Click <strong style="color:#ffd78c">Sign In</strong>.
                </p>
            </div>
        </div>
    </div>

    <!-- ══ APP (hidden until login) ════════════════════════════ -->
    <div id="appWrapper">

    <!-- ══ NAVBAR ══════════════════════════════════════════════ -->
    <nav class="diary-nav">
      <div class="nav-logo">
        <span class="nav-logo-icon">📔</span>
        <span class="nav-logo-text">MyDiary</span>
      </div>
      <div class="nav-links">
        <a class="nav-link active" onclick="showTab('home')" data-tab="home">🏠 Home</a>
        <a class="nav-link" onclick="showTab('bio')" data-tab="bio">👤 Biography</a>
        <a class="nav-link" onclick="showTab('journal')" data-tab="journal">📝 Journal</a>
        <a class="nav-link" onclick="showTab('gallery')" data-tab="gallery">🖼️ Gallery</a>
      </div>
      <div class="nav-right">
        <div class="nav-profile" onclick="openPersonalInfo()">
          <div class="nav-avatar" id="navAvatar">👤</div>
          <span class="nav-username" id="navUsername">My Diary</span>
        </div>
        <div class="nav-tools">
          <button class="nav-tool-btn" onclick="openBankModal()" title="Banks">🏦</button>
          <button class="nav-tool-btn" onclick="openFamilyModal()" title="Family">👨‍👩‍👧‍👦</button>
          <button class="nav-tool-btn" onclick="openLifeGraph()" title="Life Graph">📈</button>
          <button class="nav-tool-btn" onclick="openDocuments()" title="Documents">📁</button>
          <button class="nav-tool-btn" onclick="openDailyTracker()" title="Daily Tracker" style="color:#68d391;">✅</button>
          <button class="nav-tool-btn" onclick="openFinance()" title="Finance" style="color:#f6ad55;">💰</button>
          <div class="nav-more-wrap">
            <button class="nav-tool-btn nav-more-btn" onclick="toggleMoreMenu()" title="More Tools">⋮</button>
            <div class="nav-more-menu" id="navMoreMenu">
              <button onclick="openModal('ideaBankModal');closeMoreMenu()">💡 Idea Bank</button>
              <button onclick="openModal('healthInsModal');closeMoreMenu()">🏥 Health Insurance</button>
              <button onclick="openModal('groceryModal');closeMoreMenu()">🛒 Grocery History</button>
              <button onclick="openModal('decisionModal');closeMoreMenu()">🧠 Decision Journal</button>
              <button onclick="openModal('timeLeaksModal');closeMoreMenu()">⏱️ Time Tracker</button>
              <button onclick="openModal('knowledgeModal');closeMoreMenu()">🧩 Knowledge Graph</button>
              <button onclick="openModal('projectsModal');closeMoreMenu()">🏗️ Life Projects</button>
              <button onclick="openModal('emergencyModal');closeMoreMenu()">🚨 Emergency Contacts</button>
              <button onclick="openModal('coachModal');closeMoreMenu()">🎯 AI Coach</button>
              <button onclick="openModal('reviewModal');closeMoreMenu()">📆 Review System</button>
              <button onclick="openModal('reportModal');closeMoreMenu()">📊 Monthly Report</button>
            </div>
          </div>
          <button class="nav-tool-btn danger-tool" onclick="doLogout()" title="Logout">🔒</button>
        </div>
      </div>
    </nav>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">

    <!-- ══ HOME TAB ══════════════════════════════════════════════ -->
    <div id="tab-home" class="tab-page active-tab">

      <!-- Hero: Quote + Clock -->
      <div class="hero-section">
        <div class="hero-bg-glow"></div>

        <!-- Live Clock -->
        <div class="live-clock" id="liveClock">
          <div class="clock-time" id="clockTime">00:00:00</div>
          <div class="clock-date" id="clockDate">Loading...</div>
        </div>

        <!-- Quote Slideshow -->
        <div class="quote-stage">
          <div class="quote-marks">"</div>
          <div class="quote-text" id="quoteText">Loading...</div>
          <div class="quote-author" id="quoteAuthor">— Loading</div>
          <div class="quote-dots" id="quoteDots"></div>
        </div>
      </div>

      <!-- Dashboard Grid -->
      <div class="dash-grid">

        <!-- Streak & Mood -->
        <div class="dash-card mood-card">
          <div class="dash-card-title">🌤️ Today's Mood</div>
          <div class="mood-emojis">
            <span class="mood-btn" onclick="setMood('😄','Excellent')" title="Excellent">😄</span>
            <span class="mood-btn" onclick="setMood('😊','Good')" title="Good">😊</span>
            <span class="mood-btn" onclick="setMood('😐','Neutral')" title="Neutral">😐</span>
            <span class="mood-btn" onclick="setMood('😔','Low')" title="Low">😔</span>
            <span class="mood-btn" onclick="setMood('😢','Sad')" title="Sad">😢</span>
          </div>
          <div class="mood-selected" id="moodSelected">Not set today</div>
          <div class="streak-row">
            <span class="streak-fire">🔥</span>
            <span class="streak-count" id="streakCount">0</span>
            <span class="streak-label">day streak</span>
          </div>
        </div>

        <!-- Stats card -->
        <div class="dash-card stats-dash">
          <div class="dash-card-title">📊 My Stats</div>
          <div class="stat-row"><span>📝 Journal Entries</span><span class="sval" id="totalMessages">0</span></div>
          <div class="stat-row"><span>🧠 Memories</span><span class="sval" id="totalMemories">0</span></div>
          <div class="stat-row"><span>📁 Documents</span><span class="sval" id="docCount">0</span></div>
          <div class="stat-row"><span>📅 Since</span><span class="sval" id="firstMessage">—</span></div>
          <div class="stat-row"><span>⏱ Last Entry</span><span class="sval" id="lastActivity">—</span></div>
        </div>

        <!-- Word of the day -->
        <div class="dash-card word-card">
          <div class="dash-card-title">📚 Word of the Day</div>
          <div class="wotd-word" id="wotdWord">—</div>
          <div class="wotd-pos" id="wotdPos"></div>
          <div class="wotd-def" id="wotdDef">Refresh to load</div>
          <button class="wotd-btn" onclick="loadWotd()">🔄 New Word</button>
        </div>

        <!-- Quick Note -->
        <div class="dash-card quick-note-card">
          <div class="dash-card-title">⚡ Quick Note</div>
          <textarea class="quick-note-input" id="quickNoteInput" placeholder="Jot something down…" oninput="autoSaveNote()"></textarea>
          <div class="quick-note-saved" id="quickNoteSaved"></div>
        </div>

      </div>

      <!-- Certificates / Photos Slideshow -->
      <div class="slideshow-section">
        <div class="section-header">
          <h2 class="section-title">🏆 My Achievements & Memories</h2>
          <button class="slide-upload-btn" onclick="document.getElementById('slideUploadInput').click()">➕ Add Photo / Certificate</button>
          <input type="file" id="slideUploadInput" multiple accept="image/*" style="display:none" onchange="handleSlideUpload(event)">
        </div>
        <div class="slideshow-wrap" id="slideshowWrap">
          <button class="slide-arrow left-arrow" onclick="slideMove(-1)">&#8249;</button>
          <div class="slides-track" id="slidesTrack"></div>
          <button class="slide-arrow right-arrow" onclick="slideMove(1)">&#8250;</button>
        </div>
        <div class="slide-indicators" id="slideIndicators"></div>
        <div class="empty-slides" id="emptySlides">
          <span>📷</span>
          <p>Upload certificates, photos, or memories to display here</p>
        </div>
      </div>

    </div><!-- end home tab -->

    <!-- ══ BIOGRAPHY TAB ═════════════════════════════════════ -->
    <div id="tab-bio" class="tab-page">
      <div class="bio-page">

        <!-- Profile Hero -->
        <div class="bio-hero">
          <div class="bio-avatar-wrap" onclick="pickProfilePic()">
            <div class="bio-avatar" id="bioAvatar">
              <img id="bioAvatarImg" src="" style="display:none" alt="Profile">
              <span id="bioAvatarEmoji">👤</span>
            </div>
            <div class="bio-avatar-edit">📷 Change</div>
          </div>
          <div class="bio-hero-info">
            <div class="bio-name" id="bioName">Your Name</div>
            <div class="bio-tagline" id="bioTaglineDisplay">Add your tagline...</div>
            <div class="bio-badges" id="bioBadges"></div>
          </div>
        </div>

        <!-- Bio Editor -->
        <div class="bio-editor">
          <div class="bio-section-grid">
            <div class="bio-field-block">
              <label class="bio-label">Your Name</label>
              <input class="bio-input" id="bioNameInput" placeholder="Full name">
            </div>
            <div class="bio-field-block">
              <label class="bio-label">Tagline / Motto</label>
              <input class="bio-input" id="bioTagline" placeholder="e.g. Dreamer. Coder. Explorer.">
            </div>
            <div class="bio-field-block">
              <label class="bio-label">Profession / Role</label>
              <input class="bio-input" id="bioProfession" placeholder="e.g. Software Engineer">
            </div>
            <div class="bio-field-block">
              <label class="bio-label">Location</label>
              <input class="bio-input" id="bioLocation" placeholder="City, Country">
            </div>
            <div class="bio-field-block" style="grid-column:1/-1">
              <label class="bio-label">About Me</label>
              <textarea class="bio-textarea" id="bioAbout" rows="4" placeholder="Write something about yourself — your story, dreams, values..."></textarea>
            </div>
            <div class="bio-field-block">
              <label class="bio-label">Hobbies & Interests</label>
              <input class="bio-input" id="bioHobbies" placeholder="e.g. Reading, Music, Travel">
            </div>
            <div class="bio-field-block">
              <label class="bio-label">Life Goal</label>
              <input class="bio-input" id="bioGoal" placeholder="Your biggest dream">
            </div>
            <div class="bio-field-block" style="grid-column:1/-1">
              <label class="bio-label">Achievements / Milestones</label>
              <textarea class="bio-textarea" id="bioAchievements" rows="3" placeholder="List your proudest achievements..."></textarea>
            </div>
          </div>
          <div class="bio-save-row">
            <span class="bio-saved-msg" id="bioSavedMsg"></span>
            <button class="save-btn" onclick="saveBio()">💾 Save Biography</button>
          </div>
        </div>

      </div>
    </div>

    <!-- ══ JOURNAL TAB ═══════════════════════════════════════ -->
    <div id="tab-journal" class="tab-page">
      <div class="journal-layout">

        <!-- Journal Filter Bar -->
        <div class="journal-topbar">
          <select id="dateFilter" onchange="applyDateFilter()" class="journal-filter-sel">
            <option value="all">📅 All Time</option>
            <option value="today">Today</option>
            <option value="yesterday">Yesterday</option>
            <option value="2days">Last 2 Days</option>
            <option value="7days">Last 7 Days</option>
            <option value="30days">Last 30 Days</option>
            <option value="custom">Custom Range</option>
          </select>
          <div id="customDateRange" style="display:none;gap:0.5rem;align-items:center">
            <input type="date" id="startDate" class="journal-filter-sel" style="flex:1">
            <span style="color:#7a7a8c">→</span>
            <input type="date" id="endDate" class="journal-filter-sel" style="flex:1">
            <button onclick="applyCustomDateFilter()" class="add-event-btn" style="padding:0.4rem 0.8rem">Go</button>
          </div>
          <span id="filterInfo" style="color:#7a7a8c;font-size:0.75rem;margin-left:auto"></span>
          <button onclick="showExportModal()" class="nav-tool-btn" title="Export">💾</button>
          <button onclick="document.getElementById('importFile').click()" class="nav-tool-btn" title="Import">📥</button>
          <button onclick="clearAll()" class="nav-tool-btn danger-tool" title="Clear All" style="font-size:0.8rem">🗑️</button>
        </div>

        <!-- Messages -->
        <div class="messages" id="messages" style="flex:1;overflow-y:auto;padding:1.25rem">
          <div class="empty-state">
            <div style="font-size:3rem;margin-bottom:1rem">📔</div>
            <h2>Your journal is empty</h2>
            <p>Start writing your first entry below!</p>
          </div>
        </div>

        <!-- Write entry -->
        <div class="journal-write-bar">
          <div class="journal-entry-wrap">
            <div class="entry-mood-pick" id="entryMoodIcon">😊</div>
            <input type="text" id="userInput" placeholder="Write your diary entry… what happened today?" onkeypress="if(event.key==='Enter') sendMessage()" class="journal-entry-input">
            <button class="send journal-send-btn" onclick="sendMessage()">✍️ Save</button>
          </div>
          <div class="journal-hint">Press Enter or click Save — entries are stored with timestamp 📅</div>
        </div>

        <!-- Memory sidebar -->
        <div class="memories-sidebar">
          <div class="memories-card" style="margin:0">
            <h3>🧠 Memories</h3>
            <div class="memories-list" id="memoriesList">
              <p style="text-align:center;color:#7a7a8c;font-size:0.875rem">No memories yet</p>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- ══ GALLERY TAB ═══════════════════════════════════════ -->
    <div id="tab-gallery" class="tab-page">
      <div class="gallery-page">
        <div class="gallery-header">
          <h2 style="color:#ffd78c;font-size:1.3rem">🖼️ My Gallery</h2>
          <button class="slide-upload-btn" onclick="document.getElementById('galleryUploadInput').click()">➕ Add Images</button>
          <input type="file" id="galleryUploadInput" multiple accept="image/*" style="display:none" onchange="handleGalleryUpload(event)">
        </div>
        <div class="gallery-grid" id="galleryGrid">
          <div class="gallery-empty">
            <span style="font-size:3rem">📷</span>
            <p>Add your photos, certificates, and memories</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <h2>Export Data</h2>
            <p style="color: #a0a0b0; margin-bottom: 1rem;">Choose what to export:</p>
            <div style="margin-bottom: 1rem;">
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                    <input type="radio" name="exportType" value="all" checked>
                    <span>All data (messages + memories)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                    <input type="radio" name="exportType" value="filtered">
                    <span>Only filtered data (current view)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="radio" name="exportType" value="memories">
                    <span>Memories only</span>
                </label>
            </div>
            <div class="modal-buttons">
                <button onclick="closeExportModal()">Cancel</button>
                <button onclick="executeExport()" style="background: linear-gradient(135deg, #ffd78c 0%, #ffb84d 100%); color: #1a1a2e;">Export</button>
            </div>
        </div>
    </div>
    </div><!-- end appWrapper -->

    <!-- ══ DAILY TRACKER MODAL ═══════════════════════════════ -->
    <div class="big-modal" id="dailyTrackerModal">
      <div class="big-modal-box" style="max-width:820px">
        <div class="big-modal-header">
          <h2>✅ Daily Tracker</h2>
          <div style="display:flex;gap:0.5rem;align-items:center">
            <span id="dtDate" style="font-size:0.82rem;color:#a0a0b0"></span>
            <button class="save-btn" onclick="saveDailyTracker()" style="padding:0.5rem 1rem;font-size:0.82rem">💾 Save Day</button>
            <button class="close-modal-btn" onclick="document.getElementById('dailyTrackerModal').classList.remove('show')">✕</button>
          </div>
        </div>
        <div class="dt-body">
          <div class="dt-progress-wrap">
            <div class="dt-progress-bar"><div class="dt-progress-fill" id="dtProgressFill" style="width:0%"></div></div>
            <span class="dt-progress-label" id="dtProgressLabel">0 / 0 done</span>
          </div>
          <div class="dt-streak-nav">
            <button class="dt-nav-btn" onclick="dtNavigate(-1)">← Yesterday</button>
            <div class="dt-streak-badge">🔥 <span id="dtStreak">0</span> day streak</div>
            <button class="dt-nav-btn" onclick="dtNavigate(1)">Tomorrow →</button>
          </div>
          <div class="dt-sections" id="dtSections"></div>
          <div class="dt-add-row">
            <input class="dt-add-input" id="dtNewTask" placeholder="Add custom task…" onkeydown="if(event.key==='Enter')addCustomTask()">
            <select class="dt-add-sel" id="dtNewSection">
              <option value="Morning">🌅 Morning</option>
              <option value="Day">☀️ Day</option>
              <option value="Evening">🌆 Evening</option>
              <option value="Night">🌙 Night</option>
              <option value="Custom">⚙️ Custom</option>
            </select>
            <button class="add-event-btn" onclick="addCustomTask()">＋ Add</button>
          </div>
          <div class="dt-history-wrap">
            <div class="dt-history-title">📅 Last 30 Days</div>
            <div class="dt-heatmap" id="dtHeatmap"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ══ FINANCE MODAL ══════════════════════════════════════ -->
    <div class="big-modal" id="financeModal">
      <div class="big-modal-box" style="max-width:1000px">
        <div class="big-modal-header">
          <h2>💰 Money Manager</h2>
          <button class="close-modal-btn" onclick="document.getElementById('financeModal').classList.remove('show')">✕</button>
        </div>
        <div class="fin-tabs">
          <button class="fin-tab active" onclick="switchFinTab('dashboard')" data-ft="dashboard">📊 Dashboard</button>
          <button class="fin-tab" onclick="switchFinTab('transactions')" data-ft="transactions">💳 Transactions</button>
          <button class="fin-tab" onclick="switchFinTab('networth')" data-ft="networth">🏛️ Net Worth</button>
          <button class="fin-tab" onclick="switchFinTab('loans')" data-ft="loans">🏦 Loans</button>
          <button class="fin-tab" onclick="switchFinTab('export')" data-ft="export">📥 Export Excel</button>
        </div>
        <div class="fin-page active-fin" id="fp-dashboard">
          <div class="fin-summary-cards">
            <div class="fin-card green-card"><div class="fin-card-label">Cash in Hand</div><div class="fin-card-val" id="fc_cash">₹0</div><div class="fin-card-sub" id="fc_cash_sub">Capital + income − expenses</div></div>
            <div class="fin-card blue-card"><div class="fin-card-label">This Month Income</div><div class="fin-card-val" id="fc_income">₹0</div></div>
            <div class="fin-card red-card"><div class="fin-card-label">This Month Expenses</div><div class="fin-card-val" id="fc_expense">₹0</div></div>
            <div class="fin-card gold-card"><div class="fin-card-label">Net This Month</div><div class="fin-card-val" id="fc_net">₹0</div></div>
          </div>
          <div class="fin-init-row">
            <span style="color:#a0a0b0;font-size:0.85rem">💡 Initial Capital:</span>
            <input type="number" id="finInitCapital" placeholder="Starting amount (₹)" class="fin-input-sm" style="width:180px">
            <button class="fin-set-btn" onclick="setInitCapital()">Set Capital</button>
            <span style="color:#34c759;font-size:0.75rem" id="finInitSet"></span>
          </div>
          <div class="fin-quick-add">
            <div class="fin-qa-title">⚡ Quick Add Transaction</div>
            <div class="fin-qa-row">
              <select class="fin-sel" id="qa_type"><option value="income">💚 Income</option><option value="expense">❤️ Expense</option></select>
              <input type="number" class="fin-input-sm" id="qa_amount" placeholder="Amount (₹)" style="flex:0 0 130px">
              <input type="text" class="fin-input-sm" id="qa_desc" placeholder="Description" style="flex:1;min-width:120px">
              <select class="fin-sel" id="qa_cat">
                <option>Food</option><option>Transport</option><option>Salary</option><option>Freelance</option>
                <option>Shopping</option><option>Medical</option><option>Rent</option><option>Bills</option>
                <option>Investment</option><option>Gift</option><option>Other</option>
              </select>
              <button class="add-event-btn" onclick="addTransaction()">Add</button>
            </div>
          </div>
          <div class="fin-recent-title">📋 Recent Transactions</div>
          <div class="fin-recent-list" id="finRecentList"></div>
          <div class="fin-month-title">📆 Monthly Summary</div>
          <div class="fin-month-grid" id="finMonthGrid"></div>
        </div>
        <div class="fin-page" id="fp-transactions">
          <div class="fin-tx-filters">
            <select class="fin-sel" id="tx_filter_type" onchange="renderTransactions()"><option value="all">All</option><option value="income">Income Only</option><option value="expense">Expense Only</option></select>
            <select class="fin-sel" id="tx_filter_month" onchange="renderTransactions()"></select>
            <input type="text" class="fin-input-sm" id="tx_search" placeholder="🔍 Search…" oninput="renderTransactions()" style="flex:1">
          </div>
          <div class="fin-tx-list" id="finTxList"></div>
        </div>
        <div class="fin-page" id="fp-networth">
          <div class="fin-nw-summary">
            <div class="fin-nw-big" id="nw_total">₹0 Net Worth</div>
            <div style="display:flex;gap:1rem;flex-wrap:wrap;margin-top:0.75rem">
              <div class="fin-card green-card" style="flex:1;min-width:140px"><div class="fin-card-label">Total Assets</div><div class="fin-card-val" id="nw_assets">₹0</div></div>
              <div class="fin-card red-card" style="flex:1;min-width:140px"><div class="fin-card-label">Total Liabilities</div><div class="fin-card-val" id="nw_liabilities">₹0</div></div>
            </div>
          </div>
          <div class="fin-nw-add-row">
            <select class="fin-sel" id="nw_kind"><option value="asset">✅ Asset</option><option value="liability">❌ Liability</option></select>
            <select class="fin-sel" id="nw_cat"><option>💵 Cash/FD</option><option>📈 Stocks</option><option>🏠 Property</option><option>🚗 Vehicle</option><option>💍 Jewellery</option><option>📦 Other Asset</option><option>🏦 Loan</option><option>💳 Credit Card</option><option>📋 Other Liability</option></select>
            <input type="text" class="fin-input-sm" id="nw_name" placeholder="Name (e.g. SBI FD)" style="flex:1;min-width:120px">
            <input type="number" class="fin-input-sm" id="nw_value" placeholder="Value (₹)" style="flex:0 0 130px">
            <button class="add-event-btn" onclick="addNetWorthItem()">Add</button>
          </div>
          <div class="fin-nw-list" id="finNwList"></div>
        </div>
        <div class="fin-page" id="fp-loans">
          <div class="fin-loan-add">
            <div class="fin-qa-title">➕ Add Loan / EMI</div>
            <div class="fin-qa-row" style="flex-wrap:wrap">
              <input type="text" class="fin-input-sm" id="loan_name" placeholder="Loan name" style="flex:1;min-width:130px">
              <input type="number" class="fin-input-sm" id="loan_principal" placeholder="Total (₹)" style="flex:0 0 130px">
              <input type="number" class="fin-input-sm" id="loan_emi" placeholder="EMI/month (₹)" style="flex:0 0 140px">
              <input type="number" class="fin-input-sm" id="loan_remaining" placeholder="Months left" style="flex:0 0 110px">
              <input type="date" class="fin-input-sm" id="loan_date" style="flex:0 0 145px">
              <button class="add-event-btn" onclick="addLoan()">Add</button>
            </div>
          </div>
          <div class="fin-loan-list" id="finLoanList"></div>
        </div>

        <!-- ── Export Excel Tab ── -->
        <div class="fin-page" id="fp-export">
          <div style="padding:1.5rem">
            <div style="font-size:1rem;font-weight:700;color:#ffd78c;margin-bottom:0.4rem">📥 Export Finance Data to Excel</div>
            <div style="font-size:0.82rem;color:#7a7a8c;margin-bottom:1.5rem">Download monthly or yearly income, expense & balance — covers all data from day 1 up to 10+ years</div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.5rem">
              <!-- Monthly export -->
              <div style="background:rgba(30,30,48,0.7);border:1px solid rgba(255,215,140,0.15);border-radius:14px;padding:1.25rem">
                <div style="font-size:0.95rem;font-weight:700;color:#e8e8e8;margin-bottom:0.75rem">📅 Monthly Export</div>
                <div style="font-size:0.8rem;color:#a0a0b0;margin-bottom:0.75rem">All transactions for one specific month with full details</div>
                <select id="exp_month_sel" class="fin-sel" style="width:100%;margin-bottom:0.75rem"></select>
                <button class="add-event-btn" style="width:100%" onclick="exportMonthlyExcel()">⬇️ Download Month Excel</button>
              </div>

              <!-- Yearly export -->
              <div style="background:rgba(30,30,48,0.7);border:1px solid rgba(255,215,140,0.15);border-radius:14px;padding:1.25rem">
                <div style="font-size:0.95rem;font-weight:700;color:#e8e8e8;margin-bottom:0.75rem">📆 Yearly Export</div>
                <div style="font-size:0.8rem;color:#a0a0b0;margin-bottom:0.75rem">Month-by-month summary for a full year</div>
                <select id="exp_year_sel" class="fin-sel" style="width:100%;margin-bottom:0.75rem"></select>
                <button class="add-event-btn" style="width:100%" onclick="exportYearlyExcel()">⬇️ Download Year Excel</button>
              </div>
            </div>

            <!-- Full history export -->
            <div style="background:rgba(30,30,48,0.7);border:1px solid rgba(38,166,154,0.3);border-radius:14px;padding:1.25rem;margin-bottom:1rem">
              <div style="font-size:0.95rem;font-weight:700;color:#26a69a;margin-bottom:0.5rem">📊 Complete History Export (1–10+ Years)</div>
              <div style="font-size:0.8rem;color:#a0a0b0;margin-bottom:1rem">Every transaction ever recorded — all years, all months, with monthly totals sheet included</div>
              <div style="display:flex;gap:1rem;align-items:center;flex-wrap:wrap">
                <button class="add-event-btn" style="background:linear-gradient(135deg,#26a69a,#00796b)" onclick="exportAllHistoryExcel()">⬇️ Download Complete History Excel</button>
                <button class="add-event-btn" style="background:rgba(255,215,140,0.12);color:#ffd78c;border:1px solid rgba(255,215,140,0.3)" onclick="exportMonthlySummaryExcel()">📋 Monthly Summary Only</button>
              </div>
            </div>

            <!-- Preview -->
            <div id="exp_preview" style="font-size:0.8rem;color:#7a7a8c;padding:0.5rem"></div>
          </div>
        </div>
      </div>
    </div>

    <style>
      .dt-body{padding:1.25rem 1.5rem;max-height:80vh;overflow-y:auto;}
      .dt-body::-webkit-scrollbar{width:5px;} .dt-body::-webkit-scrollbar-thumb{background:rgba(255,215,140,0.2);border-radius:4px;}
      .dt-progress-wrap{display:flex;align-items:center;gap:1rem;margin-bottom:1rem;}
      .dt-progress-bar{flex:1;height:10px;background:rgba(255,255,255,0.08);border-radius:999px;overflow:hidden;}
      .dt-progress-fill{height:100%;border-radius:999px;background:linear-gradient(90deg,#34c759,#ffd78c);transition:width 0.4s;}
      .dt-progress-label{font-size:0.82rem;color:#ffd78c;font-weight:700;white-space:nowrap;}
      .dt-streak-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:1.25rem;}
      .dt-nav-btn{background:rgba(40,40,58,0.7);border:1px solid rgba(255,215,140,0.15);color:#ffd78c;border-radius:8px;padding:0.4rem 1rem;font-size:0.8rem;cursor:pointer;}
      .dt-nav-btn:hover{background:rgba(255,215,140,0.15);}
      .dt-streak-badge{font-size:1rem;font-weight:700;color:#ffd78c;}
      .dt-sections{display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.25rem;}
      @media(max-width:600px){.dt-sections{grid-template-columns:1fr;}}
      .dt-section{background:rgba(30,30,48,0.6);border:1px solid rgba(255,215,140,0.1);border-radius:14px;padding:1rem;}
      .dt-section-title{font-size:0.8rem;font-weight:700;color:#ffd78c;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:0.75rem;}
      .dt-task{display:flex;align-items:center;gap:0.65rem;padding:0.45rem 0;border-bottom:1px solid rgba(255,255,255,0.04);cursor:pointer;}
      .dt-task:last-child{border-bottom:none;}
      .dt-task input[type=checkbox]{width:16px;height:16px;accent-color:#34c759;cursor:pointer;flex-shrink:0;}
      .dt-task-label{font-size:0.875rem;color:#e8e8e8;flex:1;}
      .dt-task.done .dt-task-label{text-decoration:line-through;color:#5a5a6c;}
      .dt-task-del{background:none;border:none;color:#ff6b6b;cursor:pointer;font-size:0.75rem;opacity:0;}
      .dt-task:hover .dt-task-del{opacity:1;}
      .dt-add-row{display:flex;gap:0.6rem;margin-bottom:1.25rem;flex-wrap:wrap;}
      .dt-add-input{flex:1;min-width:180px;background:rgba(40,40,58,0.7);border:1.5px solid rgba(255,215,140,0.15);border-radius:8px;padding:0.6rem 0.9rem;color:#e8e8e8;font-size:0.875rem;outline:none;}
      .dt-add-sel{background:rgba(40,40,58,0.7);border:1px solid rgba(255,215,140,0.15);border-radius:8px;padding:0.6rem 0.8rem;color:#e8e8e8;font-size:0.82rem;outline:none;}
      .dt-history-wrap{margin-top:0.5rem;}
      .dt-history-title{font-size:0.78rem;color:#a0a0b0;margin-bottom:0.5rem;font-weight:600;}
      .dt-heatmap{display:flex;gap:3px;flex-wrap:wrap;}
      .dt-hm-cell{width:18px;height:18px;border-radius:4px;cursor:pointer;}
      /* ── Nav More Menu ── */
      .nav-more-wrap{position:relative;}
      .nav-more-menu{display:none;position:absolute;top:calc(100% + 8px);right:0;background:rgba(12,12,22,0.98);border:1px solid rgba(255,215,140,0.2);border-radius:12px;padding:0.5rem;min-width:200px;z-index:9000;box-shadow:0 16px 48px rgba(0,0,0,0.6);backdrop-filter:blur(20px);}
      .nav-more-menu.show{display:block;}
      .nav-more-menu button{display:flex;width:100%;background:none;border:none;color:#e8e8e8;padding:0.6rem 0.9rem;border-radius:8px;font-size:0.85rem;cursor:pointer;text-align:left;gap:0.5rem;transition:background 0.15s;}
      .nav-more-menu button:hover{background:rgba(255,215,140,0.1);color:#ffd78c;}
      /* ── Universal window scroll ── */
      .win-body{padding:1.25rem 1.5rem;max-height:78vh;overflow-y:auto;}
      .win-body::-webkit-scrollbar{width:5px;}.win-body::-webkit-scrollbar-thumb{background:rgba(255,215,140,0.2);border-radius:4px;}
      /* ── Shared tab nav inside modal ── */
      .win-tabs{display:flex;gap:0;border-bottom:1px solid rgba(255,215,140,0.1);flex-wrap:wrap;}
      .win-tab{background:none;border:none;border-bottom:2px solid transparent;color:#7a7a8c;padding:0.7rem 1.1rem;font-size:0.82rem;cursor:pointer;transition:all 0.2s;white-space:nowrap;}
      .win-tab:hover{color:#ffd78c;}.win-tab.wt-active{color:#ffd78c;border-bottom-color:#ffd78c;font-weight:700;}
      .win-page{display:none;}.win-page.wp-active{display:block;}
      /* ── Card grid ── */
      .card-grid-2{display:grid;grid-template-columns:1fr 1fr;gap:1rem;}
      @media(max-width:600px){.card-grid-2{grid-template-columns:1fr;}}
      /* ── Idea Bank ── */
      .idea-card{background:rgba(30,30,48,0.6);border:1px solid rgba(255,215,140,0.12);border-radius:14px;padding:1rem;position:relative;transition:border-color 0.2s;}
      .idea-card:hover{border-color:rgba(255,215,140,0.3);}
      .idea-title{font-size:0.95rem;font-weight:700;color:#e8e8e8;margin-bottom:0.4rem;}
      .idea-tag{font-size:0.68rem;padding:2px 8px;border-radius:999px;font-weight:600;display:inline-block;margin-right:4px;}
      .idea-tag.business{background:rgba(246,173,85,0.15);color:#f6ad55;border:1px solid rgba(246,173,85,0.3);}
      .idea-tag.life{background:rgba(154,117,234,0.15);color:#9a75ea;border:1px solid rgba(154,117,234,0.3);}
      .idea-tag.tech{background:rgba(99,179,237,0.15);color:#63b3ed;border:1px solid rgba(99,179,237,0.3);}
      .idea-tag.creative{background:rgba(252,129,74,0.15);color:#fc814a;border:1px solid rgba(252,129,74,0.3);}
      .idea-body{font-size:0.82rem;color:#a0a0b0;margin-top:0.35rem;line-height:1.6;}
      .idea-footer{font-size:0.7rem;color:#5a5a6c;margin-top:0.5rem;}
      .idea-del{position:absolute;top:8px;right:8px;background:none;border:none;color:#ff6b6b;cursor:pointer;opacity:0;font-size:0.8rem;}
      .idea-card:hover .idea-del{opacity:1;}
      /* ── Decision Journal ── */
      .dj-card{background:rgba(30,30,48,0.6);border:1px solid rgba(255,215,140,0.1);border-radius:14px;padding:1.1rem;margin-bottom:0.85rem;}
      .dj-q-score{font-size:1.5rem;font-weight:800;}
      .dj-label{font-size:0.7rem;color:#a0a0b0;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.2rem;}
      .dj-value{font-size:0.85rem;color:#e8e8e8;line-height:1.5;}
      /* ── Time Tracker ── */
      .tt-app-row{display:flex;align-items:center;gap:0.75rem;padding:0.65rem 0;border-bottom:1px solid rgba(255,255,255,0.05);}
      .tt-app-icon{font-size:1.3rem;flex-shrink:0;}
      .tt-app-name{flex:1;font-size:0.875rem;color:#e8e8e8;}
      .tt-bar-wrap{flex:2;height:8px;background:rgba(255,255,255,0.08);border-radius:999px;overflow:hidden;}
      .tt-bar{height:100%;border-radius:999px;transition:width 0.4s;}
      .tt-time{font-size:0.78rem;color:#ffd78c;font-weight:700;min-width:60px;text-align:right;}
      .focus-mode-btn{background:linear-gradient(135deg,#34c759,#1a9e3f);border:none;border-radius:10px;padding:0.75rem 1.5rem;color:#fff;font-weight:700;font-size:0.9rem;cursor:pointer;transition:all 0.2s;}
      .focus-mode-btn.active{background:linear-gradient(135deg,#ef5350,#c62828);}
      /* ── Knowledge Graph ── */
      .note-card{background:rgba(30,30,48,0.6);border:1px solid rgba(154,117,234,0.15);border-radius:12px;padding:1rem;margin-bottom:0.75rem;cursor:pointer;transition:border-color 0.2s;}
      .note-card:hover{border-color:rgba(154,117,234,0.4);}
      .note-title{font-size:0.9rem;font-weight:700;color:#9a75ea;margin-bottom:0.3rem;}
      .note-links{display:flex;gap:0.4rem;flex-wrap:wrap;margin-top:0.5rem;}
      .note-link-tag{font-size:0.7rem;background:rgba(154,117,234,0.1);border:1px solid rgba(154,117,234,0.2);color:#9a75ea;padding:2px 8px;border-radius:999px;cursor:pointer;}
      .note-link-tag:hover{background:rgba(154,117,234,0.25);}
      /* ── Projects ── */
      .proj-card{background:rgba(30,30,48,0.6);border:1px solid rgba(255,215,140,0.12);border-radius:14px;padding:1.1rem;margin-bottom:0.85rem;}
      .proj-title{font-size:1rem;font-weight:700;color:#ffd78c;margin-bottom:0.4rem;}
      .proj-progress-bar{height:8px;background:rgba(255,255,255,0.08);border-radius:999px;overflow:hidden;margin:0.5rem 0;}
      .proj-fill{height:100%;border-radius:999px;background:linear-gradient(90deg,#63b3ed,#ffd78c);transition:width 0.4s;}
      .milestone-item{display:flex;align-items:center;gap:0.5rem;padding:0.35rem 0;font-size:0.82rem;color:#a0a0b0;}
      .milestone-item input[type=checkbox]{accent-color:#34c759;}
      /* ── Emergency ── */
      .ec-card{background:rgba(30,30,48,0.6);border:1px solid rgba(239,83,80,0.15);border-radius:14px;padding:1rem;position:relative;text-align:center;}
      .ec-avatar{width:56px;height:56px;border-radius:50%;background:rgba(239,83,80,0.15);border:2px solid rgba(239,83,80,0.3);display:flex;align-items:center;justify-content:center;font-size:1.5rem;margin:0 auto 0.5rem;}
      .ec-name{font-size:0.9rem;font-weight:700;color:#e8e8e8;}
      .ec-phone{font-size:0.82rem;color:#ef5350;margin-top:3px;}
      .ec-detail{font-size:0.75rem;color:#7a7a8c;margin-top:2px;}
      /* ── Coach ── */
      .coach-card{background:rgba(30,30,48,0.6);border:1px solid rgba(255,215,140,0.12);border-radius:16px;padding:1.25rem;cursor:pointer;text-align:center;transition:all 0.2s;}
      .coach-card:hover{border-color:rgba(255,215,140,0.4);transform:translateY(-3px);}
      .coach-icon{font-size:2.5rem;margin-bottom:0.5rem;}
      .coach-name{font-size:0.9rem;font-weight:700;color:#ffd78c;}
      .coach-desc{font-size:0.75rem;color:#7a7a8c;margin-top:0.25rem;}
      .coach-chat-body{max-height:55vh;overflow-y:auto;padding:1rem;display:flex;flex-direction:column;gap:0.6rem;}
      .coach-chat-body::-webkit-scrollbar{width:5px;}.coach-chat-body::-webkit-scrollbar-thumb{background:rgba(255,215,140,0.15);border-radius:4px;}
      .coach-msg{padding:0.65rem 1rem;border-radius:12px;max-width:85%;font-size:0.875rem;line-height:1.6;}
      .coach-msg.user{background:rgba(255,215,140,0.12);border:1px solid rgba(255,215,140,0.2);align-self:flex-end;color:#e8e8e8;}
      .coach-msg.ai{background:rgba(30,30,48,0.8);border:1px solid rgba(255,255,255,0.08);align-self:flex-start;color:#e8e8e8;}
      .coach-input-row{display:flex;gap:0.6rem;padding:0.75rem 1rem;border-top:1px solid rgba(255,215,140,0.1);}
      /* ── Review System ── */
      .review-section{margin-bottom:1.25rem;}
      .review-q{font-size:0.78rem;color:#a0a0b0;margin-bottom:0.25rem;font-weight:600;}
      .review-textarea{width:100%;background:rgba(40,40,58,0.7);border:1.5px solid rgba(255,215,140,0.12);border-radius:8px;padding:0.65rem 0.9rem;color:#e8e8e8;font-size:0.875rem;resize:vertical;outline:none;font-family:inherit;min-height:60px;}
      .review-textarea:focus{border-color:rgba(255,215,140,0.4);}
      .rating-stars{display:flex;gap:0.3rem;font-size:1.4rem;cursor:pointer;}
      .rating-star{opacity:0.3;transition:opacity 0.15s;}
      .rating-star.lit{opacity:1;}
      /* ── Report ── */
      .report-section{background:rgba(30,30,48,0.6);border:1px solid rgba(255,215,140,0.1);border-radius:14px;padding:1rem;margin-bottom:1rem;}
      .report-section-title{font-size:0.8rem;font-weight:700;color:#ffd78c;text-transform:uppercase;margin-bottom:0.75rem;display:flex;align-items:center;gap:0.4rem;}
      .report-row{display:flex;justify-content:space-between;padding:0.4rem 0;border-bottom:1px solid rgba(255,255,255,0.04);font-size:0.82rem;}
      .report-row:last-child{border-bottom:none;}
      .report-lbl{color:#a0a0b0;} .report-val{color:#e8e8e8;font-weight:600;}
      .download-btns{display:flex;gap:0.75rem;margin-top:1rem;flex-wrap:wrap;}
      .dl-btn{flex:1;min-width:120px;padding:0.7rem 1rem;border:none;border-radius:10px;font-weight:700;font-size:0.875rem;cursor:pointer;transition:all 0.2s;}
      .dl-pdf{background:linear-gradient(135deg,#ef5350,#c62828);color:#fff;}
      .dl-excel{background:linear-gradient(135deg,#26a69a,#00695c);color:#fff;}
      .dl-btn:hover{transform:translateY(-2px);opacity:0.9;}
      /* ── Health Insurance ── */
      .hi-policy-card{background:rgba(30,30,48,0.6);border:1px solid rgba(38,166,154,0.2);border-radius:14px;padding:1.1rem;margin-bottom:0.85rem;position:relative;}
      .hi-policy-name{font-size:0.95rem;font-weight:700;color:#26a69a;margin-bottom:0.5rem;}
      /* ── Grocery ── */
      .groc-item{display:flex;align-items:center;gap:0.75rem;background:rgba(30,30,48,0.6);border:1px solid rgba(255,215,140,0.08);border-radius:12px;padding:0.85rem;margin-bottom:0.65rem;}
      .groc-img{width:56px;height:56px;border-radius:10px;object-fit:cover;flex-shrink:0;background:rgba(60,60,80,0.5);display:flex;align-items:center;justify-content:center;font-size:1.5rem;cursor:pointer;}
      .groc-img img{width:100%;height:100%;object-fit:cover;border-radius:10px;}
      .fin-tabs{display:flex;gap:0;border-bottom:1px solid rgba(255,215,140,0.12);background:rgba(12,12,22,0.5);}
      .fin-tab{background:none;border:none;border-bottom:2px solid transparent;color:#7a7a8c;padding:0.85rem 1.4rem;font-size:0.875rem;cursor:pointer;transition:all 0.2s;font-weight:500;}
      .fin-tab:hover{color:#ffd78c;} .fin-tab.active{color:#ffd78c;border-bottom-color:#ffd78c;font-weight:700;}
      .fin-page{display:none;padding:1.25rem 1.5rem;max-height:75vh;overflow-y:auto;}
      .fin-page::-webkit-scrollbar{width:5px;} .fin-page::-webkit-scrollbar-thumb{background:rgba(255,215,140,0.2);border-radius:4px;}
      .fin-page.active-fin{display:block;}
      .fin-summary-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin-bottom:1.25rem;}
      .fin-card{border-radius:14px;padding:1.1rem;border:1px solid rgba(255,255,255,0.08);}
      .green-card{background:rgba(38,166,154,0.12);border-color:rgba(38,166,154,0.25);}
      .blue-card{background:rgba(99,179,237,0.12);border-color:rgba(99,179,237,0.25);}
      .red-card{background:rgba(239,83,80,0.12);border-color:rgba(239,83,80,0.25);}
      .gold-card{background:rgba(255,215,140,0.1);border-color:rgba(255,215,140,0.2);}
      .fin-card-label{font-size:0.7rem;color:#a0a0b0;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.4rem;}
      .fin-card-val{font-size:1.4rem;font-weight:800;}
      .fin-card-sub{font-size:0.7rem;color:#7a7a8c;margin-top:0.2rem;}
      .green-card .fin-card-val{color:#26a69a;} .blue-card .fin-card-val{color:#63b3ed;} .red-card .fin-card-val{color:#ef5350;} .gold-card .fin-card-val{color:#ffd78c;}
      .fin-init-row{display:flex;align-items:center;gap:0.75rem;background:rgba(255,215,140,0.06);border:1px solid rgba(255,215,140,0.15);border-radius:10px;padding:0.75rem 1rem;margin-bottom:1rem;flex-wrap:wrap;}
      .fin-input-sm{background:rgba(40,40,58,0.7);border:1.5px solid rgba(255,215,140,0.15);border-radius:8px;padding:0.55rem 0.85rem;color:#e8e8e8;font-size:0.875rem;outline:none;font-family:inherit;}
      .fin-sel{background:rgba(40,40,58,0.7);border:1px solid rgba(255,215,140,0.15);border-radius:8px;padding:0.55rem 0.8rem;color:#e8e8e8;font-size:0.82rem;outline:none;}
      .fin-set-btn{background:linear-gradient(135deg,#ffd78c,#ffb84d);border:none;border-radius:8px;padding:0.55rem 1.1rem;color:#1a1a2e;font-weight:700;font-size:0.82rem;cursor:pointer;}
      .fin-quick-add{background:rgba(30,30,48,0.5);border:1px solid rgba(255,215,140,0.1);border-radius:12px;padding:1rem;margin-bottom:1.25rem;}
      .fin-qa-title{font-size:0.75rem;font-weight:700;color:#ffd78c;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:0.75rem;}
      .fin-qa-row{display:flex;gap:0.6rem;flex-wrap:wrap;}
      .fin-recent-title,.fin-month-title{font-size:0.82rem;font-weight:700;color:#a0a0b0;text-transform:uppercase;letter-spacing:0.05em;margin:1rem 0 0.6rem;}
      .fin-tx-item{display:flex;align-items:center;gap:0.75rem;padding:0.7rem 0.75rem;border-radius:10px;margin-bottom:0.4rem;}
      .fin-tx-item:hover{background:rgba(255,255,255,0.04);}
      .fin-tx-icon{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;}
      .fin-tx-desc{flex:1;min-width:0;}
      .fin-tx-name{font-size:0.875rem;color:#e8e8e8;font-weight:500;}
      .fin-tx-meta{font-size:0.72rem;color:#7a7a8c;margin-top:2px;}
      .fin-tx-amt{font-size:1rem;font-weight:700;white-space:nowrap;}
      .fin-tx-del{background:none;border:none;color:#ff6b6b;cursor:pointer;font-size:0.8rem;opacity:0;flex-shrink:0;}
      .fin-tx-item:hover .fin-tx-del{opacity:1;}
      .fin-month-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:0.75rem;}
      .fin-month-card{background:rgba(30,30,48,0.5);border:1px solid rgba(255,255,255,0.07);border-radius:10px;padding:0.85rem;}
      .fin-mc-month{font-size:0.78rem;color:#a0a0b0;margin-bottom:0.35rem;}
      .fin-mc-net{font-size:1.1rem;font-weight:800;}
      .fin-tx-filters{display:flex;gap:0.6rem;margin-bottom:1rem;flex-wrap:wrap;}
      .fin-tx-list{max-height:55vh;overflow-y:auto;}
      .fin-nw-big{font-size:2rem;font-weight:800;color:#ffd78c;}
      .fin-nw-summary{margin-bottom:1.25rem;}
      .fin-nw-add-row{display:flex;gap:0.6rem;flex-wrap:wrap;margin-bottom:1rem;background:rgba(30,30,48,0.5);border:1px solid rgba(255,215,140,0.1);border-radius:12px;padding:1rem;}
      .fin-nw-item{display:flex;align-items:center;gap:0.75rem;padding:0.65rem 0.75rem;border-radius:10px;margin-bottom:0.4rem;}
      .fin-nw-item:hover{background:rgba(255,255,255,0.04);}
      .fin-nw-cat{font-size:0.78rem;color:#7a7a8c;min-width:80px;}
      .fin-nw-name{flex:1;font-size:0.875rem;color:#e8e8e8;}
      .fin-nw-val{font-size:0.95rem;font-weight:700;}
      .fin-nw-date{font-size:0.7rem;color:#5a5a6c;white-space:nowrap;}
      .fin-nw-del{background:none;border:none;color:#ff6b6b;cursor:pointer;font-size:0.8rem;opacity:0;}
      .fin-nw-item:hover .fin-nw-del{opacity:1;}
      .fin-loan-add{background:rgba(30,30,48,0.5);border:1px solid rgba(255,215,140,0.1);border-radius:12px;padding:1rem;margin-bottom:1.25rem;}
      .fin-loan-card{background:rgba(40,40,60,0.55);border:1px solid rgba(239,83,80,0.2);border-radius:12px;padding:1rem;margin-bottom:0.75rem;display:flex;gap:1rem;align-items:center;flex-wrap:wrap;}
      .fin-loan-info{flex:1;}
      .fin-loan-name{font-size:0.95rem;font-weight:700;color:#e8e8e8;margin-bottom:0.3rem;}
      .fin-loan-detail{font-size:0.78rem;color:#a0a0b0;}
      .fin-loan-progress{height:6px;background:rgba(255,255,255,0.08);border-radius:999px;margin-top:0.5rem;overflow:hidden;}
      .fin-loan-fill{height:100%;background:linear-gradient(90deg,#ef5350,#ffd78c);border-radius:999px;}
      .fin-loan-del{background:rgba(255,69,58,0.12);border:1px solid rgba(255,69,58,0.25);color:#ff6b6b;border-radius:7px;padding:0.35rem 0.75rem;font-size:0.78rem;cursor:pointer;}
    </style>

    <!-- ══ IDEA BANK ══════════════════════════════════════════ -->
    <div class="big-modal" id="ideaBankModal"><div class="big-modal-box" style="max-width:900px">
      <div class="big-modal-header"><h2>💡 Idea Bank</h2><button class="close-modal-btn" onclick="closeModal('ideaBankModal')">✕</button></div>
      <div class="win-body">
        <div style="display:flex;gap:0.75rem;margin-bottom:1rem;flex-wrap:wrap">
          <select class="fin-sel" id="idea_type"><option value="business">💼 Business</option><option value="life">🌱 Life</option><option value="tech">💻 Tech</option><option value="creative">🎨 Creative</option></select>
          <input class="fin-input-sm" id="idea_title" placeholder="Idea title…" style="flex:1;min-width:150px">
          <input class="fin-input-sm" id="idea_desc" placeholder="Describe the idea…" style="flex:2;min-width:200px">
          <select class="fin-sel" id="idea_status"><option value="new">🆕 New</option><option value="exploring">🔍 Exploring</option><option value="active">🚀 Active</option><option value="done">✅ Done</option><option value="dropped">❌ Dropped</option></select>
          <button class="add-event-btn" onclick="addIdea()">Add Idea</button>
        </div>
        <div style="display:flex;gap:0.5rem;margin-bottom:1rem;flex-wrap:wrap">
          <button class="gtool-btn active" id="ideaFilterAll" onclick="filterIdeas('all')">All</button>
          <button class="gtool-btn" id="ideaFilterBusiness" onclick="filterIdeas('business')">💼 Business</button>
          <button class="gtool-btn" id="ideaFilterLife" onclick="filterIdeas('life')">🌱 Life</button>
          <button class="gtool-btn" id="ideaFilterTech" onclick="filterIdeas('tech')">💻 Tech</button>
          <button class="gtool-btn" id="ideaFilterCreative" onclick="filterIdeas('creative')">🎨 Creative</button>
        </div>
        <div class="card-grid-2" id="ideaGrid"></div>
      </div>
    </div></div>

    <!-- ══ HEALTH INSURANCE ═══════════════════════════════════ -->
    <div class="big-modal" id="healthInsModal"><div class="big-modal-box" style="max-width:860px">
      <div class="big-modal-header"><h2>🏥 Health Insurance</h2><button class="close-modal-btn" onclick="closeModal('healthInsModal')">✕</button></div>
      <div class="win-body">
        <div class="fin-quick-add">
          <div class="fin-qa-title">➕ Add Policy</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem">
            <div><label class="dj-label">Policy Name</label><input class="fin-input-sm" id="hi_name" placeholder="e.g. Star Health" style="width:100%"></div>
            <div><label class="dj-label">Insurer / Company</label><input class="fin-input-sm" id="hi_company" placeholder="Insurance company" style="width:100%"></div>
            <div><label class="dj-label">Policy Number</label><input class="fin-input-sm" id="hi_polno" placeholder="Policy No." style="width:100%"></div>
            <div><label class="dj-label">Sum Insured (₹)</label><input type="number" class="fin-input-sm" id="hi_sum" placeholder="e.g. 500000" style="width:100%"></div>
            <div><label class="dj-label">Premium / Year (₹)</label><input type="number" class="fin-input-sm" id="hi_premium" placeholder="Annual premium" style="width:100%"></div>
            <div><label class="dj-label">Renewal Date</label><input type="date" class="fin-input-sm" id="hi_renewal" style="width:100%"></div>
            <div><label class="dj-label">Members Covered</label><input class="fin-input-sm" id="hi_members" placeholder="Self, Spouse, Parents…" style="width:100%"></div>
            <div><label class="dj-label">Agent Name & Phone</label><input class="fin-input-sm" id="hi_agent" placeholder="Agent contact" style="width:100%"></div>
            <div style="grid-column:1/-1"><label class="dj-label">Coverage Details / Notes</label><textarea class="fin-input-sm" id="hi_notes" rows="2" placeholder="Hospitalisation, OPD, critical illness…" style="width:100%;resize:vertical"></textarea></div>
          </div>
          <button class="add-event-btn" style="margin-top:0.75rem" onclick="addHiPolicy()">Add Policy</button>
        </div>
        <div id="hiPoliciesList"></div>
      </div>
    </div></div>

    <!-- ══ GROCERY HISTORY ════════════════════════════════════ -->
    <div class="big-modal" id="groceryModal"><div class="big-modal-box" style="max-width:860px">
      <div class="big-modal-header"><h2>🛒 Grocery Purchase History</h2><button class="close-modal-btn" onclick="closeModal('groceryModal')">✕</button></div>
      <div class="win-body">
        <div class="fin-quick-add">
          <div class="fin-qa-title">➕ Add Purchase</div>
          <div style="display:flex;gap:0.75rem;flex-wrap:wrap">
            <input class="fin-input-sm" id="groc_store" placeholder="Store name" style="flex:1;min-width:120px">
            <input type="number" class="fin-input-sm" id="groc_amount" placeholder="Amount (₹)" style="flex:0 0 130px">
            <input type="date" class="fin-input-sm" id="groc_date" style="flex:0 0 145px">
            <input class="fin-input-sm" id="groc_items" placeholder="Items bought…" style="flex:2;min-width:180px">
            <label class="add-event-btn" style="cursor:pointer">📷 Receipt<input type="file" accept="image/*" id="groc_img" style="display:none" onchange="previewGrocImg()"></label>
            <button class="add-event-btn" onclick="addGrocery()">Add</button>
          </div>
          <img id="groc_img_preview" src="" style="display:none;max-height:80px;border-radius:8px;margin-top:0.5rem">
        </div>
        <div class="lock-note" style="margin-bottom:0.75rem">🔒 Grocery history permanently stored</div>
        <div id="groceryList"></div>
      </div>
    </div></div>

    <!-- ══ DECISION JOURNAL ═══════════════════════════════════ -->
    <div class="big-modal" id="decisionModal"><div class="big-modal-box" style="max-width:860px">
      <div class="big-modal-header"><h2>🧠 Decision Journal</h2><button class="close-modal-btn" onclick="closeModal('decisionModal')">✕</button></div>
      <div class="win-body">
        <div class="fin-quick-add">
          <div class="fin-qa-title">➕ Log a Decision</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem">
            <div style="grid-column:1/-1"><label class="dj-label">🧠 Decision Taken</label><input class="fin-input-sm" id="dj_decision" placeholder="What did you decide?" style="width:100%"></div>
            <div><label class="dj-label">🎯 Expected Outcome</label><textarea class="review-textarea" id="dj_expected" rows="2" placeholder="What do you expect to happen?"></textarea></div>
            <div><label class="dj-label">⚖️ Why you chose this</label><textarea class="review-textarea" id="dj_why" rows="2" placeholder="Reasoning behind the decision…"></textarea></div>
            <div><label class="dj-label">📊 Decision Quality Score (1–10)</label><input type="number" class="fin-input-sm" id="dj_score" min="1" max="10" placeholder="1-10" style="width:100%"></div>
            <div><label class="dj-label">📅 Review Date</label><input type="date" class="fin-input-sm" id="dj_review_date" style="width:100%"></div>
          </div>
          <button class="add-event-btn" style="margin-top:0.75rem" onclick="addDecision()">Log Decision</button>
        </div>
        <div id="decisionList"></div>
      </div>
    </div></div>

    <!-- ══ TIME TRACKER ════════════════════════════════════════ -->
    <div class="big-modal" id="timeLeaksModal"><div class="big-modal-box" style="max-width:860px">
      <div class="big-modal-header"><h2>⏱️ Time Leaks & Attention Tracker</h2><button class="close-modal-btn" onclick="closeModal('timeLeaksModal')">✕</button></div>
      <div class="win-body">
        <div style="display:flex;gap:1rem;align-items:center;margin-bottom:1.25rem;flex-wrap:wrap">
          <button class="focus-mode-btn" id="focusModeBtn" onclick="toggleFocusMode()">🎯 Start Focus Mode</button>
          <div id="focusTimer" style="font-size:1.5rem;font-weight:800;color:#ffd78c;display:none">25:00</div>
          <div id="focusStatus" style="font-size:0.82rem;color:#7a7a8c"></div>
        </div>
        <div class="fin-quick-add">
          <div class="fin-qa-title">➕ Log Time Usage</div>
          <div style="display:flex;gap:0.75rem;flex-wrap:wrap">
            <select class="fin-sel" id="tt_app_icon">
              <option value="📱">📱 Phone</option><option value="💻">💻 Laptop</option><option value="📺">📺 TV/YouTube</option>
              <option value="🎮">🎮 Gaming</option><option value="📖">📖 Reading</option><option value="🏃">🏃 Exercise</option>
              <option value="💤">💤 Sleep</option><option value="🎵">🎵 Music</option><option value="🌐">🌐 Browsing</option>
            </select>
            <input class="fin-input-sm" id="tt_app" placeholder="App/Activity name" style="flex:1;min-width:140px">
            <input type="number" class="fin-input-sm" id="tt_mins" placeholder="Minutes" style="flex:0 0 100px">
            <select class="fin-sel" id="tt_type"><option value="productive">✅ Productive</option><option value="neutral">😐 Neutral</option><option value="leak">⚠️ Time Leak</option></select>
            <input type="date" class="fin-input-sm" id="tt_date" style="flex:0 0 145px">
            <button class="add-event-btn" onclick="addTimeLog()">Log</button>
          </div>
        </div>
        <div id="ttReport" style="margin-top:1rem"></div>
        <div id="ttList"></div>
      </div>
    </div></div>

    <!-- ══ KNOWLEDGE GRAPH ════════════════════════════════════ -->
    <div class="big-modal" id="knowledgeModal"><div class="big-modal-box" style="max-width:900px">
      <div class="big-modal-header"><h2>🧩 Personal Knowledge Graph</h2><button class="close-modal-btn" onclick="closeModal('knowledgeModal')">✕</button></div>
      <div class="win-body">
        <div style="display:flex;gap:0.6rem;margin-bottom:1rem">
          <input class="fin-input-sm" id="kg_search" placeholder="🔎 Search notes, topics, links…" style="flex:1" oninput="renderKnowledge()">
          <button class="add-event-btn" onclick="document.getElementById('kgAddForm').style.display=document.getElementById('kgAddForm').style.display==='none'?'block':'none'">➕ New Note</button>
        </div>
        <div id="kgAddForm" style="display:none" class="fin-quick-add">
          <div class="fin-qa-title">➕ Add Knowledge Note</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem">
            <div style="grid-column:1/-1"><label class="dj-label">📌 Title</label><input class="fin-input-sm" id="kg_title" placeholder="Note title" style="width:100%"></div>
            <div><label class="dj-label">🏷️ Topic / Category</label><input class="fin-input-sm" id="kg_topic" placeholder="e.g. SQL, Python, Finance" style="width:100%"></div>
            <div><label class="dj-label">🔗 Links To (comma separated)</label><input class="fin-input-sm" id="kg_links" placeholder="e.g. SQL, Backend, PHP" style="width:100%"></div>
            <div style="grid-column:1/-1"><label class="dj-label">📝 Note Content</label><textarea class="review-textarea" id="kg_content" rows="3" placeholder="Write your knowledge note…"></textarea></div>
            <div><label class="dj-label">🌟 Insight Level (1–5)</label><input type="number" class="fin-input-sm" id="kg_level" min="1" max="5" placeholder="1-5" style="width:100%"></div>
          </div>
          <button class="add-event-btn" style="margin-top:0.75rem" onclick="addKnowledge()">Save Note</button>
        </div>
        <div id="knowledgeGrid" style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem"></div>
      </div>
    </div></div>

    <!-- ══ LIFE PROJECTS ══════════════════════════════════════ -->
    <div class="big-modal" id="projectsModal"><div class="big-modal-box" style="max-width:900px">
      <div class="big-modal-header"><h2>🏗️ Life Projects Manager</h2><button class="close-modal-btn" onclick="closeModal('projectsModal')">✕</button></div>
      <div class="win-body">
        <div class="fin-quick-add" style="margin-bottom:1rem">
          <div class="fin-qa-title">➕ New Project</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem">
            <div><label class="dj-label">Project Name</label><input class="fin-input-sm" id="proj_name" placeholder="e.g. Get IT Job" style="width:100%"></div>
            <div><label class="dj-label">Category</label>
              <select class="fin-sel" id="proj_cat" style="width:100%"><option>Career</option><option>Business</option><option>Health</option><option>Education</option><option>Personal</option><option>Finance</option><option>Tech</option></select></div>
            <div><label class="dj-label">Target Date</label><input type="date" class="fin-input-sm" id="proj_date" style="width:100%"></div>
            <div><label class="dj-label">Priority</label>
              <select class="fin-sel" id="proj_priority" style="width:100%"><option value="high">🔴 High</option><option value="medium">🟡 Medium</option><option value="low">🟢 Low</option></select></div>
            <div style="grid-column:1/-1"><label class="dj-label">Description & Goal</label><textarea class="review-textarea" id="proj_desc" rows="2" placeholder="What is this project about?"></textarea></div>
          </div>
          <button class="add-event-btn" style="margin-top:0.75rem" onclick="addProject()">Create Project</button>
        </div>
        <div id="projectsList"></div>
      </div>
    </div></div>

    <!-- ══ EMERGENCY CONTACTS ═════════════════════════════════ -->
    <div class="big-modal" id="emergencyModal"><div class="big-modal-box" style="max-width:820px">
      <div class="big-modal-header"><h2>🚨 Emergency Contacts</h2><button class="close-modal-btn" onclick="closeModal('emergencyModal')">✕</button></div>
      <div class="win-body">
        <div class="fin-quick-add">
          <div class="fin-qa-title">➕ Add Contact</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem">
            <div><label class="dj-label">Full Name</label><input class="fin-input-sm" id="ec_name" placeholder="Name" style="width:100%"></div>
            <div><label class="dj-label">Relation</label><input class="fin-input-sm" id="ec_relation" placeholder="e.g. Father, Doctor, Neighbour" style="width:100%"></div>
            <div><label class="dj-label">Phone (Primary)</label><input class="fin-input-sm" id="ec_phone1" placeholder="+91 XXXXX XXXXX" style="width:100%"></div>
            <div><label class="dj-label">Phone (Secondary)</label><input class="fin-input-sm" id="ec_phone2" placeholder="Alternate number" style="width:100%"></div>
            <div><label class="dj-label">Email</label><input type="email" class="fin-input-sm" id="ec_email" placeholder="email@example.com" style="width:100%"></div>
            <div><label class="dj-label">Location / Address</label><input class="fin-input-sm" id="ec_location" placeholder="City or address" style="width:100%"></div>
            <div><label class="dj-label">Blood Group</label><input class="fin-input-sm" id="ec_blood" placeholder="e.g. O+" style="width:100%"></div>
            <div><label class="dj-label">Notes</label><input class="fin-input-sm" id="ec_notes" placeholder="Any special note" style="width:100%"></div>
          </div>
          <button class="add-event-btn" style="margin-top:0.75rem" onclick="addEmergencyContact()">Add Contact</button>
        </div>
        <div class="lock-note" style="margin-bottom:0.75rem">🔒 Emergency contacts permanently stored</div>
        <div id="emergencyGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:0.85rem"></div>
      </div>
    </div></div>

    <!-- ══ AI COACH ════════════════════════════════════════════ -->
    <div class="big-modal" id="coachModal"><div class="big-modal-box" style="max-width:820px">
      <div class="big-modal-header"><h2>🎯 Personal AI Coach</h2><button class="close-modal-btn" onclick="closeModal('coachModal')">✕</button></div>
      <div id="coachSelect" style="padding:1.5rem">
        <p style="color:#a0a0b0;text-align:center;margin-bottom:1.25rem;font-size:0.875rem">Choose your coach for today:</p>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:0.85rem">
          <div class="coach-card" onclick="startCoach('study')"><div class="coach-icon">👨‍🏫</div><div class="coach-name">Study Coach</div><div class="coach-desc">Focus, learning, exams</div></div>
          <div class="coach-card" onclick="startCoach('career')"><div class="coach-icon">💼</div><div class="coach-name">Career Coach</div><div class="coach-desc">Jobs, skills, growth</div></div>
          <div class="coach-card" onclick="startCoach('finance')"><div class="coach-icon">💰</div><div class="coach-name">Finance Coach</div><div class="coach-desc">Money, savings, invest</div></div>
          <div class="coach-card" onclick="startCoach('mental')"><div class="coach-icon">🧘</div><div class="coach-name">Mental Coach</div><div class="coach-desc">Mindset, stress, calm</div></div>
          <div class="coach-card" onclick="startCoach('fitness')"><div class="coach-icon">🏋️</div><div class="coach-name">Fitness Coach</div><div class="coach-desc">Exercise, diet, energy</div></div>
        </div>
      </div>
      <div id="coachChatWrap" style="display:none">
        <div class="big-modal-header" style="border-top:1px solid rgba(255,215,140,0.1)">
          <span id="coachActiveTitle" style="font-size:0.9rem;color:#ffd78c;font-weight:700"></span>
          <button class="doc-btn" onclick="document.getElementById('coachSelect').style.display='block';document.getElementById('coachChatWrap').style.display='none'">← Back</button>
        </div>
        <div class="coach-chat-body" id="coachChatBody"></div>
        <div class="coach-input-row">
          <input class="fin-input-sm" id="coachInput" placeholder="Ask your coach…" style="flex:1" onkeydown="if(event.key==='Enter')sendCoachMsg()">
          <button class="add-event-btn" onclick="sendCoachMsg()">Send</button>
        </div>
      </div>
    </div></div>

    <!-- ══ REVIEW SYSTEM ══════════════════════════════════════ -->
    <div class="big-modal" id="reviewModal"><div class="big-modal-box" style="max-width:860px">
      <div class="big-modal-header"><h2>📆 Review System</h2><button class="close-modal-btn" onclick="closeModal('reviewModal')">✕</button></div>
      <div class="win-tabs" id="reviewTabs">
        <button class="win-tab wt-active" onclick="switchWinTab('review','daily')">📆 Daily</button>
        <button class="win-tab" onclick="switchWinTab('review','weekly')">🗓️ Weekly</button>
        <button class="win-tab" onclick="switchWinTab('review','monthly')">📅 Monthly</button>
        <button class="win-tab" onclick="switchWinTab('review','yearly')">🎯 Yearly Audit</button>
        <button class="win-tab" onclick="switchWinTab('review','history')">📚 History</button>
      </div>
      <div class="win-body">
        <div class="win-page wp-active" id="review-daily">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
            <span style="color:#ffd78c;font-weight:700" id="reviewDailyDate"></span>
            <input type="date" class="fin-input-sm" id="reviewDatePick" onchange="loadReviewForDate()">
          </div>
          <div class="review-section"><div class="review-q">🌟 What went well today?</div><textarea class="review-textarea" id="rev_d_well" oninput="autoSaveReview('daily')"></textarea></div>
          <div class="review-section"><div class="review-q">📉 What could have been better?</div><textarea class="review-textarea" id="rev_d_improve" oninput="autoSaveReview('daily')"></textarea></div>
          <div class="review-section"><div class="review-q">🙏 Gratitude — 3 things I'm grateful for</div><textarea class="review-textarea" id="rev_d_gratitude" oninput="autoSaveReview('daily')"></textarea></div>
          <div class="review-section"><div class="review-q">🎯 Tomorrow's top priority</div><textarea class="review-textarea" id="rev_d_tomorrow" oninput="autoSaveReview('daily')"></textarea></div>
          <div class="review-section"><div class="review-q">⭐ Rate today (1–10)</div>
            <div class="rating-stars" id="revDayRating">${[1,2,3,4,5,6,7,8,9,10].map(i=>`<span class="rating-star" data-v="${i}" onclick="setRating('daily',${i})">★</span>`).join('')}</div>
          </div>
        </div>
        <div class="win-page" id="review-weekly">
          <div class="review-section"><div class="review-q">🏆 Biggest win this week</div><textarea class="review-textarea" id="rev_w_win" oninput="autoSaveReview('weekly')"></textarea></div>
          <div class="review-section"><div class="review-q">📚 What did I learn?</div><textarea class="review-textarea" id="rev_w_learn" oninput="autoSaveReview('weekly')"></textarea></div>
          <div class="review-section"><div class="review-q">🔄 What habit did I stick to?</div><textarea class="review-textarea" id="rev_w_habit" oninput="autoSaveReview('weekly')"></textarea></div>
          <div class="review-section"><div class="review-q">⚠️ What drained my energy?</div><textarea class="review-textarea" id="rev_w_drain" oninput="autoSaveReview('weekly')"></textarea></div>
          <div class="review-section"><div class="review-q">🎯 Focus for next week</div><textarea class="review-textarea" id="rev_w_focus" oninput="autoSaveReview('weekly')"></textarea></div>
        </div>
        <div class="win-page" id="review-monthly">
          <div class="review-section"><div class="review-q">📊 Goals achieved this month</div><textarea class="review-textarea" id="rev_m_achieved" oninput="autoSaveReview('monthly')"></textarea></div>
          <div class="review-section"><div class="review-q">💔 Goals missed & why</div><textarea class="review-textarea" id="rev_m_missed" oninput="autoSaveReview('monthly')"></textarea></div>
          <div class="review-section"><div class="review-q">💰 Financial health this month</div><textarea class="review-textarea" id="rev_m_finance" oninput="autoSaveReview('monthly')"></textarea></div>
          <div class="review-section"><div class="review-q">🧠 Personal growth</div><textarea class="review-textarea" id="rev_m_growth" oninput="autoSaveReview('monthly')"></textarea></div>
          <div class="review-section"><div class="review-q">🎯 Next month's theme</div><input class="fin-input-sm" id="rev_m_theme" placeholder="e.g. Month of Focus" style="width:100%" oninput="autoSaveReview('monthly')"></div>
        </div>
        <div class="win-page" id="review-yearly">
          <div class="review-section"><div class="review-q">🏆 Top 10 wins of the year</div><textarea class="review-textarea" id="rev_y_wins" rows="4" oninput="autoSaveReview('yearly')"></textarea></div>
          <div class="review-section"><div class="review-q">😔 Biggest regrets / lessons</div><textarea class="review-textarea" id="rev_y_regrets" rows="3" oninput="autoSaveReview('yearly')"></textarea></div>
          <div class="review-section"><div class="review-q">🌱 How I grew as a person</div><textarea class="review-textarea" id="rev_y_grow" rows="3" oninput="autoSaveReview('yearly')"></textarea></div>
          <div class="review-section"><div class="review-q">👥 Most important relationships</div><textarea class="review-textarea" id="rev_y_people" rows="2" oninput="autoSaveReview('yearly')"></textarea></div>
          <div class="review-section"><div class="review-q">🔮 Vision for next year</div><textarea class="review-textarea" id="rev_y_vision" rows="3" oninput="autoSaveReview('yearly')"></textarea></div>
          <div class="review-section"><div class="review-q">⭐ Rate this year (1–10)</div>
            <div class="rating-stars" id="revYearRating">${[1,2,3,4,5,6,7,8,9,10].map(i=>`<span class="rating-star" data-v="${i}" onclick="setRating('yearly',${i})">★</span>`).join('')}</div>
          </div>
        </div>
        <div class="win-page" id="review-history">
          <div id="reviewHistoryList"></div>
        </div>
        <div style="margin-top:1.25rem;display:flex;gap:0.75rem;justify-content:flex-end">
          <span id="reviewSavedMsg" style="color:#34c759;font-size:0.82rem;align-self:center"></span>
          <button class="save-btn" onclick="saveReview()">💾 Save Review</button>
        </div>
      </div>
    </div></div>

    <!-- ══ MONTHLY PERFORMANCE REPORT ════════════════════════ -->
    <div class="big-modal" id="reportModal"><div class="big-modal-box" style="max-width:900px">
      <div class="big-modal-header"><h2>📊 Monthly Performance Report</h2>
        <div style="display:flex;gap:0.5rem">
          <select class="fin-sel" id="reportMonth"></select>
          <button class="add-event-btn" onclick="generateReport()">Generate</button>
          <button class="close-modal-btn" onclick="closeModal('reportModal')">✕</button>
        </div>
      </div>
      <div class="win-body" id="reportBody">
        <p style="color:#7a7a8c;text-align:center;padding:2rem">Select a month and click Generate to see your full report.</p>
      </div>
      <div class="download-btns" style="padding:0 1.5rem 1.5rem">
        <button class="dl-btn dl-pdf" onclick="downloadReportPdf()">📄 Download PDF</button>
        <button class="dl-btn dl-excel" onclick="downloadReportExcel()">📊 Download Excel</button>
      </div>
    </div></div>

    <script>
        // ═══════════════════════════════════════════════
        //  SUPABASE CONFIG — replace with your own values
        //  Get these from: supabase.com → your project → Settings → API
        // ═══════════════════════════════════════════════
        const SUPABASE_URL  = 'https://sdqxuggknilzxnyzbzao.supabase.co';
        const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkcXh1Z2drbmlsenhueXpiemFvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEzNTQ4NTcsImV4cCI6MjA4NjkzMDg1N30.di7l75Mz5HREtW5lnOM3-03A-rDoiBbZRFf1zu5HVBQ';

        // Init Supabase client
        // Safe init — UMD build exposes window.supabase
        let _sb;
        try {
            const lib = window.supabase || window.Supabase;
            if (!lib) throw new Error('Supabase SDK not loaded — check internet connection');
            _sb = lib.createClient(SUPABASE_URL, SUPABASE_ANON);
        } catch(e) {
            document.addEventListener('DOMContentLoaded', () => {
                const lp = document.getElementById('loginPage');
                if (lp) lp.innerHTML = '<div style="color:#ff6b6b;text-align:center;padding:3rem">❌ <b>Supabase failed to load</b><br><br>' + e.message + '<br><br>Reload the page.</div>';
            });
        }

        // ── localStorage SHIM ─────────────────────────────────────
        // All existing code uses localStorage — we intercept it and
        // sync to Supabase "kv_store" table transparently.
        let _kvCache   = {};
        let _kvTimer   = null;
        let _sbUserId  = null;
        let _isSignup  = false;

        const _lsShim = {
            getItem(key)      { return _kvCache[key] !== undefined ? String(_kvCache[key]) : null; },
            setItem(key, val) { _kvCache[key] = val; _scheduleKvSave(); },
            removeItem(key)   { delete _kvCache[key]; _scheduleKvSave(); },
            clear()           { _kvCache = {}; _scheduleKvSave(); },
            key(i)            { return Object.keys(_kvCache)[i] || null; },
            get length()      { return Object.keys(_kvCache).length; }
        };
        try {
            Object.defineProperty(window, 'localStorage', { get: () => _lsShim, configurable: true });
        } catch(e) {
            window.localStorage = _lsShim;
        }

        function _scheduleKvSave() {
            clearTimeout(_kvTimer);
            _kvTimer = setTimeout(_saveKv, 200);
        }

        async function _saveKv() {
            if (!_sbUserId) return;
            const { error } = await _sb.from('kv_store').upsert({
                user_id: _sbUserId,
                data: _kvCache,
                updated_at: new Date().toISOString()
            }, { onConflict: 'user_id' });
            if (error) console.error('kv_store save error:', error.message);
        }

        async function _loadKv() {
            if (!_sbUserId) return;
            // maybeSingle() won't error if no row exists yet (unlike single())
            const { data, error } = await _sb.from('kv_store').select('data').eq('user_id', _sbUserId).maybeSingle();
            if (error) { console.error('kv_store load error:', error.message); return; }
            if (data && data.data) _kvCache = data.data;
        }

        // ── Login / Signup ────────────────────────────────────────
        function toggleEye() {
            const p = document.getElementById('loginPass');
            p.type = p.type === 'password' ? 'text' : 'password';
        }

        async function doLogin(isSignup) {
            const email = document.getElementById('loginUser').value.trim();
            const pass  = document.getElementById('loginPass').value;

            if (!email)        { showLoginError('⚠️ Please enter your email address'); return; }
            if (!pass)         { showLoginError('⚠️ Please enter your password'); return; }
            if (pass.length < 6) { showLoginError('⚠️ Password must be at least 6 characters'); return; }

            setLoading(true);
            hideLoginError();

            try {
                let result;
                if (isSignup) {
                    // SIGN UP
                    result = await _sb.auth.signUp({ email, password: pass,
                        options: { emailRedirectTo: window.location.href }
                    });

                    if (result.error) {
                        setLoading(false);
                        showLoginError('❌ ' + result.error.message);
                        return;
                    }

                    // If email confirmation is OFF → session exists immediately
                    if (result.data.session) {
                        _sbUserId = result.data.user.id;
                        await _loadKv();
                        setLoading(false);
                        loginSuccess(result.data.user.email.split('@')[0]);
                    } else {
                        // Email confirmation is ON → ask user to verify
                        setLoading(false);
                        showLoginError('✅ Account created! Check your inbox for a confirmation email, then come back and Sign In.');
                    }
                } else {
                    // SIGN IN
                    result = await _sb.auth.signInWithPassword({ email, password: pass });

                    if (result.error) {
                        setLoading(false);
                        if (result.error.message.includes('Invalid login')) {
                            showLoginError('❌ Wrong email or password. Try again, or click Create Account if you are new.');
                        } else if (result.error.message.includes('Email not confirmed')) {
                            showLoginError('📧 Please confirm your email first — check your inbox for the confirmation link.');
                        } else {
                            showLoginError('❌ ' + result.error.message);
                        }
                        return;
                    }

                    _sbUserId = result.data.user.id;
                    await _loadKv();
                    setLoading(false);
                    loginSuccess(result.data.user.email.split('@')[0]);
                }
            } catch(e) {
                setLoading(false);
                showLoginError('❌ Error: ' + e.message + '. Check your Supabase URL and key.');
            }
        }

        function setLoading(on) {
            document.getElementById('loginSpinner').style.display = on ? 'block' : 'none';
            document.getElementById('loginBtn').style.display      = on ? 'none' : 'block';
            document.getElementById('signupBtn').style.display     = on ? 'none' : 'block';
        }

        function loginSuccess(username) {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('appWrapper').style.display = 'block';
            startQuoteSlideshow();
            loadWotd();
            loadMood();
            loadStreak();
            loadQuickNote();
            // _kvCache fully loaded from Supabase — populate every section
            loadBio();
            loadPersonalInfo();
            if (typeof renderFamily    === 'function') renderFamily();
            if (typeof renderHabits    === 'function') renderHabits();
            if (typeof renderIdeas     === 'function') renderIdeas();
            if (typeof renderGroceries === 'function') renderGroceries();
            if (typeof renderDecisions === 'function') renderDecisions();
            if (typeof renderProjects  === 'function') renderProjects();
            if (typeof renderEmergencyContacts === 'function') renderEmergencyContacts();
            renderSlideshow();
            renderGallery();
            (document.getElementById('navUsername')||{}).textContent = username;
            initDB();
            _loadBanksFromSupabase().catch(e => console.warn('Bank load:', e));
        }

        async function doLogout() {
            if (!confirm('Log out?')) return;
            // Cancel any pending debounce and save immediately
            clearTimeout(_kvTimer);
            await _saveKv();
            await _sb.auth.signOut();
            _sbUserId = null;
            _kvCache  = {};
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('appWrapper').style.display = 'none';
            document.getElementById('loginPass').value = '';
            document.getElementById('loginUser').value = '';
            hideLoginError();
        }

        function showLoginError(msg) {
            const el = document.getElementById('loginError');
            el.textContent = msg;
            el.classList.add('show');
        }
        function hideLoginError() {
            const el = document.getElementById('loginError');
            el.classList.remove('show');
        }

        // Auto-restore session (Supabase keeps token in sessionStorage)
        window.addEventListener('DOMContentLoaded', async () => {
            const { data: { session } } = await _sb.auth.getSession();
            if (session) {
                _sbUserId = session.user.id;
                await _loadKv();
                loginSuccess(session.user.email.split('@')[0]);
            }
        });

        // ═══════════════════════════════════════════════
        //  MAIN APP
        // ═══════════════════════════════════════════════
        let allMessages = [];
        let allMemories = [];
        let filteredMessages = [];
        let currentFilter = 'all';

        // ── Supabase replaces IndexedDB ──────────────────────────
        async function initDB() {
            (document.getElementById('status')||{}).innerHTML = '⏳ Loading from Supabase…';

            // Clear the messages area immediately — removes any placeholder HTML
            const messagesDiv = document.getElementById('messages');
            if (messagesDiv) messagesDiv.innerHTML = '<div class="empty-state"><div style="font-size:2rem;margin-bottom:0.5rem">⏳</div><p>Loading your entries…</p></div>';

            try {
                const [msgsResp, memsResp] = await Promise.all([
                    _sb.from('messages').select('*').eq('user_id', _sbUserId).order('timestamp', { ascending: true }),
                    _sb.from('memories').select('*').eq('user_id', _sbUserId).order('timestamp', { ascending: true })
                ]);

                if (msgsResp.error) throw new Error('Messages: ' + msgsResp.error.message);
                if (memsResp.error) throw new Error('Memories: ' + memsResp.error.message);

                allMessages = msgsResp.data || [];
                allMemories = memsResp.data || [];

                (document.getElementById('status')||{}).innerHTML = '✅ Supabase connected';
                applyDateFilter();   // this calls renderMessages() which clears and redraws
                updateMemoriesList();
                updateStats();
            } catch(e) {
                (document.getElementById('status')||{}).innerHTML = '❌ ' + e.message;
                if (messagesDiv) messagesDiv.innerHTML = `<div class="empty-state"><p style="color:#ff6b6b">❌ Load error: ${e.message}<br>Check your Supabase tables exist.</p></div>`;
                console.error('initDB error:', e);
            }
        }

        function loadData() { initDB(); }

        // Apply date filter
        function applyDateFilter() {
            const filter = document.getElementById('dateFilter').value;
            currentFilter = filter;
            
            // Show/hide custom date range
            document.getElementById('customDateRange').style.display = 
                filter === 'custom' ? 'flex' : 'none';
            
            const now = new Date();
            let startDate;
            
            switch(filter) {
                case 'today':
                    startDate = new Date(now.setHours(0, 0, 0, 0));
                    break;
                case 'yesterday':
                    const yesterday = new Date(now);
                    yesterday.setDate(yesterday.getDate() - 1);
                    startDate = new Date(yesterday.setHours(0, 0, 0, 0));
                    const endOfYesterday = new Date(yesterday.setHours(23, 59, 59, 999));
                    filteredMessages = allMessages.filter(m => {
                        const msgDate = new Date(m.timestamp);
                        return msgDate >= startDate && msgDate <= endOfYesterday;
                    });
                    renderMessages();
                    updateFilterInfo();
                    return;
                case '2days':
                    startDate = new Date(now.setDate(now.getDate() - 2));
                    break;
                case '7days':
                    startDate = new Date(now.setDate(now.getDate() - 7));
                    break;
                case '30days':
                    startDate = new Date(now.setDate(now.getDate() - 30));
                    break;
                case 'custom':
                    return; // Wait for user to select dates
                case 'all':
                default:
                    filteredMessages = [...allMessages];
                    renderMessages();
                    updateFilterInfo();
                    return;
            }
            
            filteredMessages = allMessages.filter(m => 
                new Date(m.timestamp) >= startDate
            );
            
            renderMessages();
            updateFilterInfo();
        }

        // Apply custom date filter
        function applyCustomDateFilter() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            endDate.setHours(23, 59, 59, 999);
            
            if (!document.getElementById('startDate').value || !document.getElementById('endDate').value) {
                alert('Please select both start and end dates');
                return;
            }
            
            filteredMessages = allMessages.filter(m => {
                const msgDate = new Date(m.timestamp);
                return msgDate >= startDate && msgDate <= endDate;
            });
            
            renderMessages();
            updateFilterInfo();
        }

        // Update filter info
        function updateFilterInfo() {
            const info = document.getElementById('filterInfo');
            const count = filteredMessages.length;
            const total = allMessages.length;
            
            if (currentFilter === 'all') {
                info.textContent = `Showing all ${total} messages`;
            } else {
                info.textContent = `Showing ${count} of ${total} messages`;
            }
            
            (document.getElementById('filteredCount')||{}).textContent = count;
        }

        // Render messages — always wipes and redraws (called on filter change or load)
        function renderMessages() {
            const messagesDiv = document.getElementById('messages');

            // Always clear everything first — removes old placeholder text too
            messagesDiv.innerHTML = '';

            if (filteredMessages.length === 0) {
                messagesDiv.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">📭</div>
                        <h2>No entries yet</h2>
                        <p>Type something below and press Enter to save your first diary entry</p>
                    </div>`;
                return;
            }

            messagesDiv.innerHTML = filteredMessages.map(msg => `
                <div class="message">
                    <div class="avatar user">👤</div>
                    <div class="message-content">
                        <div class="bubble user">${escapeHtml(msg.content)}</div>
                        <div class="timestamp">💾 Saved · ${formatDate(msg.timestamp)}</div>
                    </div>
                </div>
            `).join('');

            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Update statistics
        function updateStats() {
            (document.getElementById('totalMessages')||{}).textContent = allMessages.length;
            (document.getElementById('totalMemories')||{}).textContent = allMemories.length;
            
            if (allMessages.length > 0) {
                const first = new Date(allMessages[0].timestamp);
                const last = new Date(allMessages[allMessages.length - 1].timestamp);
                
                (document.getElementById('firstMessage')||{}).textContent = first.toLocaleDateString();
                (document.getElementById('lastActivity')||{}).textContent = formatTimeAgo(last);
            }
            
            (document.getElementById('filteredCount')||{}).textContent = filteredMessages.length;
        }

        // Update memories list
        function updateMemoriesList() {
            const list = document.getElementById('memoriesList');
            const recent = allMemories.slice(-5).reverse();
            
            if (recent.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #7a7a8c; font-size: 0.875rem;">No memories yet</p>';
                return;
            }
            
            list.innerHTML = recent.map(mem => `
                <div class="memory-item">
                    <div class="memory-text">${escapeHtml(mem.content.substring(0, 100))}${mem.content.length > 100 ? '...' : ''}</div>
                    <div class="memory-time">💾 ${formatTimeAgo(new Date(mem.timestamp))}</div>
                </div>
            `).join('');
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            if (!text) return;

            // Clear input immediately so user can type next entry
            input.value = '';
            input.focus();

            const now = new Date().toISOString();
            const userMsg = { content: text, timestamp: now, user_id: _sbUserId };

            try {
                await addMessage(userMsg);
            } catch(e) {
                console.error('Message save error:', e);
                alert('Failed to save entry: ' + e.message);
                input.value = text; // restore on failure
                return;
            }

            // Always save as memory (any length)
            try {
                await addMemory({ content: text, timestamp: now });
            } catch(e) {
                console.warn('Memory save error:', e);
            }
        }

        // Generate UUID without crypto.randomUUID() (works in all browsers/file://)
        function _uuid() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // ── Image Upload Helper ───────────────────────────────────
        // Uploads to "images" bucket and returns a public URL
        // Requires: images bucket set to PUBLIC in Supabase Storage
        async function _uploadImage(file, folder) {
            const ext  = file.name.split('.').pop().toLowerCase();
            const path = `${_sbUserId}/${folder}/${_uuid()}.${ext}`;
            const { error } = await _sb.storage.from('images').upload(path, file, { upsert: true });
            if (error) throw new Error('Upload failed: ' + error.message);
            // Public URL — works when bucket is set to Public in Supabase
            const { data } = _sb.storage.from('images').getPublicUrl(path);
            return { url: data.publicUrl, path };
        }

        // Add message → Supabase
        async function addMessage(message) {
            // Always generate a fresh UUID — never rely on Supabase auto-gen
            const insertData = {
                id: _uuid(),
                user_id: _sbUserId,
                content: message.content,
                timestamp: message.timestamp
            };
            const { data, error } = await _sb.from('messages').insert(insertData).select().maybeSingle();
            if (error) throw new Error(error.message);
            const saved = data || message;
            allMessages.push(saved);
            // Append new message to UI directly — don't re-render all
            _appendMessageToUI(saved);
            applyDateFilter();
            updateStats();
        }

        // Append a single message bubble to the messages div
        function _appendMessageToUI(msg) {
            const messagesDiv = document.getElementById('messages');
            // Remove empty state if present
            const emptyState = messagesDiv.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            const el = document.createElement('div');
            el.className = 'message';
            el.innerHTML = `
                <div class="avatar user">👤</div>
                <div class="message-content">
                    <div class="bubble user">${escapeHtml(msg.content)}</div>
                    <div class="timestamp">💾 Saved · ${formatDate(msg.timestamp)}</div>
                </div>`;
            messagesDiv.appendChild(el);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Add memory → Supabase
        async function addMemory(memory) {
            const insertData = {
                id: _uuid(),
                user_id: _sbUserId,
                content: memory.content,
                timestamp: memory.timestamp
            };
            const { data, error } = await _sb.from('memories').insert(insertData).select().maybeSingle();
            if (error) throw new Error(error.message);
            allMemories.push(data || memory);
            updateMemoriesList();
            updateStats();
        }

        // Show loading dots (temporary, not saved)
        function showLoading() {
            const messagesDiv = document.getElementById('messages');
            const loadingEl = document.createElement('div');
            loadingEl.className = 'message';
            loadingEl.id = 'loadingBubble';
            loadingEl.innerHTML = `
                <div class="avatar assistant">🤖</div>
                <div class="message-content">
                    <div class="bubble assistant">
                        <div class="loading">
                            <div class="dot"></div>
                            <div class="dot"></div>
                            <div class="dot"></div>
                        </div>
                    </div>
                </div>
            `;
            messagesDiv.appendChild(loadingEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Show bot reply in UI ONLY — never stored in DB
        function showBotReply(response) {
            const messagesDiv = document.getElementById('messages');
            
            // Remove loading bubble
            const loading = document.getElementById('loadingBubble');
            if (loading) loading.remove();
            
            // Add bot reply to UI only (not in allMessages array, not in DB)
            const replyEl = document.createElement('div');
            replyEl.className = 'message';
            replyEl.innerHTML = `
                <div class="avatar assistant">🤖</div>
                <div class="message-content">
                    <div class="bubble assistant">${escapeHtml(response)}</div>
                    <div class="timestamp" style="color: #5a5a6c; font-style: italic;">
                        🔒 Not saved to database
                    </div>
                </div>
            `;
            messagesDiv.appendChild(replyEl);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Generate response
        function generateResponse(userInput) {
            const responses = [
                "Got it! Saved to IndexedDB with timestamp. You can filter by date anytime!",
                "Noted! I've recorded this with the current date and time.",
                "I've stored that in the database. Use the date filter to find it later!",
                "Saved! You can view this in 'Last 2 Days', 'Last 7 Days', or any custom range.",
                "Remembered! Try the date filters to see how your conversations evolve over time."
            ];
            
            if (userInput.toLowerCase().includes('remember') || 
                userInput.toLowerCase().includes('what did i')) {
                if (allMemories.length > 0) {
                    const recent = allMemories.slice(-3).map((m, i) => 
                        `${i + 1}. ${m.content} (${formatTimeAgo(new Date(m.timestamp))})`
                    ).join('\n');
                    return `Here are your recent memories:\n\n${recent}\n\nTip: Use the date filter to see older memories!`;
                } else {
                    return "No memories yet. Start sharing things with me!";
                }
            }
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        // Show export modal
        function showExportModal() {
            document.getElementById('exportModal').classList.add('show');
        }

        // Close export modal
        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('show');
        }

        // Execute export
        function executeExport() {
            const type = document.querySelector('input[name="exportType"]:checked').value;
            let data;
            
            switch(type) {
                case 'all':
                    data = {
                        messages: allMessages,
                        memories: allMemories,
                        exportDate: new Date().toISOString(),
                        totalMessages: allMessages.length,
                        totalMemories: allMemories.length
                    };
                    break;
                case 'filtered':
                    data = {
                        messages: filteredMessages,
                        memories: allMemories,
                        exportDate: new Date().toISOString(),
                        filterApplied: currentFilter,
                        totalMessages: filteredMessages.length,
                        totalMemories: allMemories.length
                    };
                    break;
                case 'memories':
                    data = {
                        memories: allMemories,
                        exportDate: new Date().toISOString(),
                        totalMemories: allMemories.length
                    };
                    break;
            }
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `assistant-${type}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            closeExportModal();
        }

        // Import data
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (confirm('This will replace all existing data. Continue?')) {
                        await _sb.from('messages').delete().eq('user_id', _sbUserId);
                        await _sb.from('memories').delete().eq('user_id', _sbUserId);
                        allMessages = [];
                        allMemories = [];
                        for (const msg of data.messages || []) { await addMessage(msg); }
                        for (const mem of data.memories || []) { await addMemory(mem); }
                        alert('Data imported successfully!');
                    }
                } catch (error) {
                    alert('Failed to import: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Clear all
        async function clearAll() {
            if (!confirm('Clear everything? This cannot be undone.')) return;
            await _sb.from('messages').delete().eq('user_id', _sbUserId);
            await _sb.from('memories').delete().eq('user_id', _sbUserId);
            allMessages = [];
            allMemories = [];
            filteredMessages = [];
            renderMessages();
            updateStats();
            updateMemoriesList();
        }

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return 'Today at ' + date.toLocaleTimeString();
            } else if (diffDays === 1) {
                return 'Yesterday at ' + date.toLocaleTimeString();
            } else if (diffDays < 7) {
                return diffDays + ' days ago at ' + date.toLocaleTimeString();
            } else {
                return date.toLocaleString();
            }
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return diffMins + 'm ago';
            if (diffHours < 24) return diffHours + 'h ago';
            if (diffDays < 7) return diffDays + 'd ago';
            return date.toLocaleDateString();
        }

        // ═══════════════════════════════════════════════
        //  PERSONAL INFO
        // ═══════════════════════════════════════════════
        const PI_FIELDS = ['name','dob','phone','email','aadhar','pan','blood','emergency','address','passport','licence','bank','ifsc','notes'];

        function openPersonalInfo() {
            loadPersonalInfo();
            document.getElementById('personalInfoModal').classList.add('show');
        }
        function closePersonalInfo() {
            document.getElementById('personalInfoModal').classList.remove('show');
        }

        async function savePersonalInfo() {
            PI_FIELDS.forEach(f => {
                const el = document.getElementById('pi_' + f);
                if (el) localStorage.setItem('pi_' + f, el.value); clearTimeout(_kvTimer); _saveKv();
            });
            clearTimeout(_kvTimer);
            await _saveKv();
            const toast = document.getElementById('infoSavedToast');
            if (toast) { toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 2500); }
        }

        function loadPersonalInfo() {
            PI_FIELDS.forEach(f => {
                const el = document.getElementById('pi_' + f);
                const saved = localStorage.getItem('pi_' + f);
                if (el && saved) el.value = saved;
            });
        }

        // ═══════════════════════════════════════════════
        //  DOCUMENTS — stored in Supabase Storage bucket
        //  Bucket name: "documents"
        //  Path per file: {user_id}/{filename}
        //  Metadata (name, size, date) stored in kv_store via localStorage shim
        // ═══════════════════════════════════════════════
        const DOC_KEY      = 'personal_docs_meta'; // stores metadata only (no base64)
        const DOC_BUCKET   = 'documents';

        function getDocs() {
            try { return JSON.parse(localStorage.getItem(DOC_KEY) || '[]'); } catch { return []; }
        }
        function saveDocs(docs) {
            localStorage.setItem(DOC_KEY, JSON.stringify(docs)); clearTimeout(_kvTimer); _saveKv();
        }

        function openDocuments() {
            renderDocList();
            document.getElementById('documentsModal').classList.add('show');
        }
        function closeDocuments() {
            document.getElementById('documentsModal').classList.remove('show');
        }

        function getFileIcon(name) {
            const ext = name.split('.').pop().toLowerCase();
            const map = {
                pdf:'🧾', doc:'📝', docx:'📝', xls:'📊', xlsx:'📊',
                ppt:'📋', pptx:'📋', txt:'📄', jpg:'🖼️', jpeg:'🖼️',
                png:'🖼️', gif:'🖼️', mp4:'🎬', zip:'📦', rar:'📦'
            };
            return map[ext] || '📎';
        }

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1048576) return (bytes/1024).toFixed(1) + ' KB';
            return (bytes/1048576).toFixed(1) + ' MB';
        }

        // Upload file → Supabase Storage
        async function handleDocUpload(event) {
            const files = Array.from(event.target.files);
            if (!files.length) return;

            const docs = getDocs();
            let uploadCount = 0;

            for (const file of files) {
                if (file.size > 50 * 1024 * 1024) {
                    alert(`"${file.name}" is over 50 MB — skipped.`);
                    continue;
                }

                // Show uploading status
                const statusEl = document.getElementById('docList');
                statusEl.innerHTML = `<div style="text-align:center;padding:2rem;color:#ffd78c">⏳ Uploading "${file.name}"…</div>`;

                // Unique path per user per file
                const filePath = `${_sbUserId}/${Date.now()}_${file.name}`;

                const { error } = await _sb.storage.from(DOC_BUCKET).upload(filePath, file, {
                    cacheControl: '3600',
                    upsert: false
                });

                if (error) {
                    alert(`Failed to upload "${file.name}": ${error.message}

Make sure you created the "documents" bucket in Supabase Storage.`);
                    continue;
                }

                // Save metadata only (no base64 in DB)
                docs.push({
                    id: Date.now() + Math.random(),
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    date: new Date().toISOString(),
                    path: filePath   // path in Supabase Storage
                });
                uploadCount++;
            }

            saveDocs(docs);
            renderDocList();
            event.target.value = '';
            if (uploadCount > 0) alert(`✅ ${uploadCount} file(s) uploaded to Supabase Storage!`);
        }

        function renderDocList() {
            const query = (document.getElementById('docSearch').value || '').toLowerCase();
            const docs = getDocs().filter(d => d.name.toLowerCase().includes(query));
            const el = document.getElementById('docList');

            if (!docs.length) {
                el.innerHTML = `<div class="no-docs"><div class="emoji">📂</div><p>${query ? 'No documents match your search.' : 'No documents yet. Click "Upload Document" to add files.'}</p></div>`;
                return;
            }

            el.innerHTML = docs.map((doc, i) => `
                <div class="doc-card">
                    <div class="doc-icon" style="background:rgba(255,215,140,0.1)">${getFileIcon(doc.name)}</div>
                    <div class="doc-meta">
                        <div class="doc-name" title="${escapeHtml(doc.name)}">${escapeHtml(doc.name)}</div>
                        <div class="doc-info">${formatSize(doc.size)} &nbsp;·&nbsp; ${new Date(doc.date).toLocaleDateString(undefined,{day:'numeric',month:'short',year:'numeric'})}</div>
                    </div>
                    <div class="doc-btns">
                        <button class="doc-btn" onclick="viewDoc(${i})">👁️ View</button>
                        <button class="doc-btn" onclick="downloadDoc(${i})">⬇️ Download</button>
                        <button class="doc-btn del" onclick="deleteDoc(${i})">🗑️</button>
                    </div>
                </div>
            `).join('');
        }

        // Get a signed URL for viewing/downloading from Supabase Storage
        async function _getDocUrl(doc) {
            const { data, error } = await _sb.storage.from(DOC_BUCKET).createSignedUrl(doc.path, 3600);
            if (error) throw new Error(error.message);
            return data.signedUrl;
        }

        async function viewDoc(index) {
            const docs = getDocs();
            const doc = docs[index];
            if (!doc) return;

            (document.getElementById('viewerTitle')||{}).textContent = doc.name;
            const body = document.getElementById('viewerBody');
            const dlBtn = document.getElementById('viewerDownloadBtn');
            dlBtn.onclick = () => downloadDoc(index);

            body.innerHTML = `<div style="text-align:center;padding:3rem;color:#ffd78c">⏳ Loading…</div>`;
            document.getElementById('docViewer').classList.add('show');

            try {
                const url = await _getDocUrl(doc);
                const ext = doc.name.split('.').pop().toLowerCase();

                if (['jpg','jpeg','png','gif','webp'].includes(ext)) {
                    body.innerHTML = `<img src="${url}" alt="${escapeHtml(doc.name)}" style="max-width:100%">`;
                } else if (ext === 'pdf') {
                    body.innerHTML = `<iframe src="${url}" title="${escapeHtml(doc.name)}" style="width:100%;height:70vh;border:none"></iframe>`;
                } else if (ext === 'txt') {
                    const resp = await fetch(url);
                    const text = await resp.text();
                    body.innerHTML = `<div class="text-view">${escapeHtml(text)}</div>`;
                } else {
                    body.innerHTML = `<div class="text-view" style="text-align:center;padding:3rem">
                        <div style="font-size:4rem;margin-bottom:1rem">${getFileIcon(doc.name)}</div>
                        <p style="color:#aaa;margin-bottom:1rem">"${escapeHtml(doc.name)}" cannot be previewed in the browser.</p>
                        <a href="${url}" download="${escapeHtml(doc.name)}">
                            <button class="doc-btn" style="padding:0.7rem 1.5rem;font-size:0.9rem">⬇️ Download to view</button>
                        </a>
                    </div>`;
                }
            } catch(e) {
                body.innerHTML = `<div style="text-align:center;padding:2rem;color:#ff6b6b">❌ Failed to load file: ${e.message}</div>`;
            }
        }

        function closeViewer() {
            document.getElementById('docViewer').classList.remove('show');
            (document.getElementById('viewerBody')||{}).innerHTML = '';
        }

        async function downloadDoc(index) {
            const docs = getDocs();
            const doc = docs[index];
            if (!doc) return;
            try {
                const url = await _getDocUrl(doc);
                const a = document.createElement('a');
                a.href = url;
                a.download = doc.name;
                a.target = '_blank';
                a.click();
            } catch(e) {
                alert('Download failed: ' + e.message);
            }
        }

        async function deleteDoc(index) {
            const docs = getDocs();
            const doc = docs[index];
            if (!doc) return;
            if (!confirm(`Delete "${doc.name}"? This cannot be undone.`)) return;

            // Delete from Supabase Storage
            const { error } = await _sb.storage.from(DOC_BUCKET).remove([doc.path]);
            if (error) {
                alert('Failed to delete from storage: ' + error.message);
                return;
            }

            docs.splice(index, 1);
            saveDocs(docs);
            renderDocList();
        }

        // ═══════════════════════════════════════════════
        //  BANK DETAILS — stored in kv_store via localStorage shim
        //  Syncs to Supabase automatically with all other app data
        // ═══════════════════════════════════════════════
        const BANK_KEY = 'personal_banks';

        function getBanks() {
            try { return JSON.parse(localStorage.getItem(BANK_KEY) || '[]'); } catch { return []; }
        }

        function _loadBanksFromSupabase() {
            // Banks load automatically from kv_store via localStorage shim on login
            // No separate table needed
        }

        function saveBanks() {
            const cards = document.querySelectorAll('.bank-card');
            const banks = [];
            cards.forEach(card => {
                const b = { id: card.dataset.id };
                card.querySelectorAll('[data-field]').forEach(el => {
                    b[el.dataset.field] = el.value || el.dataset.val || '';
                });
                const img = card.querySelector('.atm-preview');
                if (img && img.src && img.src.startsWith('http')) b.cardImg = img.src;
                banks.push(b);
            });
            // Saves to kv_store automatically via localStorage shim
            localStorage.setItem(BANK_KEY, JSON.stringify(banks)); clearTimeout(_kvTimer); _saveKv();
            alert('✅ Bank details saved!');
        }

        function openBankModal() {
            renderBanks();
            document.getElementById('bankModal').classList.add('show');
        }

        function renderBanks() {
            const banks = getBanks();
            const scroll = document.getElementById('bankScroll');
            if (!banks.length) {
                scroll.innerHTML = '';
                addBankCard();
            } else {
                scroll.innerHTML = '';
                banks.forEach(b => appendBankCard(b));
            }
        }

        function addBankCard(b = {}) {
            const id = b.id || Date.now();
            const card = document.createElement('div');
            card.className = 'bank-card';
            card.dataset.id = id;
            card.innerHTML = `
                <div class="bank-card-header">
                    <span class="bank-card-title">🏦 ${b.bankName || 'New Bank Account'}</span>
                    <button class="del-bank-btn" onclick="this.closest('.bank-card').remove()">🗑️ Remove</button>
                </div>
                <div class="bank-grid">
                    <div class="bank-field"><label>Bank Name</label><input data-field="bankName" value="${b.bankName||''}" placeholder="e.g. SBI, HDFC" oninput="this.closest('.bank-card').querySelector('.bank-card-title').textContent='🏦 '+(this.value||'Bank Account')"></div>
                    <div class="bank-field"><label>Account Holder Name</label><input data-field="holderName" value="${b.holderName||''}" placeholder="Your full name"></div>
                    <div class="bank-field"><label>Account Number</label><input data-field="accNo" value="${b.accNo||''}" placeholder="Account number"></div>
                    <div class="bank-field"><label>IFSC Code</label><input data-field="ifsc" value="${b.ifsc||''}" placeholder="IFSC code"></div>
                    <div class="bank-field"><label>Registered Phone</label><input data-field="phone" value="${b.phone||''}" placeholder="+91 XXXXX XXXXX"></div>
                    <div class="bank-field"><label>Registered Email</label><input data-field="email" value="${b.email||''}" placeholder="bank@email.com"></div>
                    <div class="bank-field"><label>ATM Card Number</label><input data-field="atmNo" value="${b.atmNo||''}" placeholder="XXXX XXXX XXXX XXXX" maxlength="19"></div>
                    <div class="bank-field"><label>ATM PIN <span class="pin-toggle" onclick="togglePin(this)">👁️ Show</span></label><input data-field="atmPin" type="password" value="${b.atmPin||''}" placeholder="XXXX" maxlength="6"></div>
                    <div class="bank-field"><label>Expiry Date</label><input data-field="expiry" value="${b.expiry||''}" placeholder="MM/YY" maxlength="5"></div>
                    <div class="bank-field"><label>CVV</label><input data-field="cvv" type="password" value="${b.cvv||''}" placeholder="XXX" maxlength="4"></div>
                    <div class="bank-field"><label>Internet Banking Username</label><input data-field="netUser" value="${b.netUser||''}" placeholder="Username"></div>
                    <div class="bank-field"><label>Internet Banking Password</label><input data-field="netPass" type="password" value="${b.netPass||''}" placeholder="Password"></div>
                    <div class="bank-field"><label>Mobile App Password/PIN</label><input data-field="appPass" type="password" value="${b.appPass||''}" placeholder="App PIN or password"></div>
                    <div class="bank-field bank-full">
                        <label>ATM Card Image <small style="color:#7a7a8c">(upload photo of your card)</small></label>
                        <input type="file" accept="image/*" onchange="previewAtmCard(this,'atm_${id}')">
                        ${b.cardImg ? `<img class="atm-preview" id="atm_${id}" src="${b.cardImg}">` : `<img class="atm-preview" id="atm_${id}" style="display:none">`}
                    </div>
                </div>`;
            document.getElementById('bankScroll').appendChild(card);
        }

        function appendBankCard(b) { addBankCard(b); }

        async function previewAtmCard(input, imgId) {
            const file = input.files[0];
            if (!file) return;
            if (file.size > 5 * 1024 * 1024) { alert('Image must be under 5MB'); return; }
            try {
                const { url, path } = await _uploadImage(file, 'bank');
                const img = document.getElementById(imgId);
                if (img) { img.src = url; img.style.display = 'block'; img.dataset.storagePath = path; }
            } catch(err) { alert(err.message); }
        }

        function togglePin(el) {
            const inp = el.closest('.bank-field').querySelector('input');
            inp.type = inp.type === 'password' ? 'text' : 'password';
            el.textContent = inp.type === 'password' ? '👁️ Show' : '🙈 Hide';
        }

        // ═══════════════════════════════════════════════
        //  FAMILY TREE
        // ═══════════════════════════════════════════════
        const FAMILY_KEY = 'personal_family';
        const GENERATIONS = [
            { key: 'great_grandparents', label: '🌳 Great Grandparents', gen: 'Generation 1 (Your Ancestors)' },
            { key: 'grandparents', label: '👴👵 Grandparents', gen: 'Generation 2' },
            { key: 'parents_uncles', label: '👨👩 Parents, Uncles & Aunties', gen: 'Generation 3' },
            { key: 'siblings_cousins', label: '👫 Siblings & Cousins', gen: 'Generation 4' },
            { key: 'me', label: '⭐ Me', gen: 'Generation 5 — Your Generation', isMe: true },
            { key: 'children', label: '👶 Children', gen: 'Generation 6' },
        ];

        function getFamily() {
            try { return JSON.parse(localStorage.getItem(FAMILY_KEY) || '{}'); } catch { return {}; }
        }

        function openFamilyModal() {
            renderFamily();
            document.getElementById('familyModal').classList.add('show');
        }

        function renderFamily() {
            const family = getFamily();
            const scroll = document.getElementById('familyScroll');
            scroll.innerHTML = '';

            GENERATIONS.forEach(gen => {
                const members = family[gen.key] || (gen.isMe ? [{ name: '', edu: '', photo: '', isMe: true }] : []);
                const section = document.createElement('div');
                section.className = 'gen-section';
                section.innerHTML = `
                    <div class="gen-label">${gen.label} <small style="font-size:0.65rem;opacity:0.7">${gen.gen}</small></div>
                    <div class="member-cards" id="mc_${gen.key}">
                        ${members.map((m, i) => memberCardHTML(gen.key, i, m, gen.isMe)).join('')}
                        ${!gen.isMe ? `<div class="add-member-btn" onclick="addMember('${gen.key}')">＋</div>` : ''}
                    </div>`;
                scroll.appendChild(section);
            });
        }

        function memberCardHTML(genKey, idx, m, isMe) {
            return `<div class="member-card" data-gen="${genKey}" data-idx="${idx}">
                ${!isMe ? `<button class="del-member-btn" onclick="deleteMember('${genKey}',${idx})">✕</button>` : ''}
                <div class="member-photo" onclick="pickMemberPhoto('${genKey}',${idx})">
                    ${m.photo ? `<img src="${m.photo}" alt="">` : '👤'}
                </div>
                <input class="member-name-input" placeholder="${isMe ? 'Your Name' : 'Name'}" value="${escapeHtml(m.name||'')}" onchange="updateMemberField('${genKey}',${idx},'name',this.value)">
                <textarea class="member-edu-input" rows="2" placeholder="Education / Qualification" onchange="updateMemberField('${genKey}',${idx},'edu',this.value)">${escapeHtml(m.edu||'')}</textarea>
                ${isMe ? `<span class="my-gen-badge">⭐ This is You</span>` : ''}
                <input type="hidden" id="mpf_${genKey}_${idx}">
            </div>`;
        }

        function addMember(genKey) {
            const family = getFamily();
            if (!family[genKey]) family[genKey] = [];
            family[genKey].push({ name: '', edu: '', photo: '' });
            localStorage.setItem(FAMILY_KEY, JSON.stringify(family)); clearTimeout(_kvTimer); _saveKv();
            renderFamily();
        }

        function deleteMember(genKey, idx) {
            if (!confirm('Remove this family member?')) return;
            const family = getFamily();
            family[genKey].splice(idx, 1);
            localStorage.setItem(FAMILY_KEY, JSON.stringify(family)); clearTimeout(_kvTimer); _saveKv();
            renderFamily();
        }

        function updateMemberField(genKey, idx, field, value) {
            const family = getFamily();
            if (!family[genKey]) family[genKey] = [];
            if (!family[genKey][idx]) family[genKey][idx] = {};
            family[genKey][idx][field] = value;
            localStorage.setItem(FAMILY_KEY, JSON.stringify(family)); clearTimeout(_kvTimer); _saveKv();
        }

        function pickMemberPhoto(genKey, idx) {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = 'image/*';
            input.onchange = async e => {
                const file = e.target.files[0];
                if (!file) return;
                if (file.size > 5 * 1024 * 1024) { alert('Photo must be under 5MB'); return; }
                try {
                    const { url, path } = await _uploadImage(file, 'family');
                    const family = getFamily();
                    if (!family[genKey]) family[genKey] = [];
                    if (!family[genKey][idx]) family[genKey][idx] = {};
                    family[genKey][idx].photo = url;
                    family[genKey][idx].photoPath = path;
                    localStorage.setItem(FAMILY_KEY, JSON.stringify(family)); clearTimeout(_kvTimer); _saveKv();
                    renderFamily();
                } catch(err) { alert(err.message); }
            };
            input.click();
        }

        function saveFamily() {
            // Collect all name/edu inputs not yet persisted (they update on change, but just re-save)
            const family = getFamily();
            document.querySelectorAll('.member-card').forEach(card => {
                const genKey = card.dataset.gen;
                const idx = parseInt(card.dataset.idx);
                if (!family[genKey]) family[genKey] = [];
                if (!family[genKey][idx]) family[genKey][idx] = {};
                const nameEl = card.querySelector('.member-name-input');
                const eduEl = card.querySelector('.member-edu-input');
                if (nameEl) family[genKey][idx].name = nameEl.value;
                if (eduEl)  family[genKey][idx].edu  = eduEl.value;
            });
            localStorage.setItem(FAMILY_KEY, JSON.stringify(family)); clearTimeout(_kvTimer); _saveKv();
            const t = document.getElementById('familyToast');
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2500);
        }

        // ═══════════════════════════════════════════════
        //  LIFE GRAPH
        // ═══════════════════════════════════════════════
        const LG_KEY = 'life_graph_events';
        let lifeChartInstance = null;

        function getLifeEvents() {
            try { return JSON.parse(localStorage.getItem(LG_KEY) || '[]'); } catch { return []; }
        }
        function saveLifeEvents(events) { localStorage.setItem(LG_KEY, JSON.stringify(events)); } clearTimeout(_kvTimer); _saveKv();

        function openLifeGraph() {
            document.getElementById('lifeGraphModal').classList.add('show');
            // Set today as default date
            document.getElementById('lg_date').value = new Date().toISOString().split('T')[0];
            renderLifeGraph();
        }

        function addLifeEvent() {
            const date = document.getElementById('lg_date').value;
            const type = document.getElementById('lg_type').value;
            const score = parseInt(document.getElementById('lg_score').value);
            const desc = document.getElementById('lg_desc').value.trim();

            if (!date || !score || score < 1 || score > 250 || !desc) {
                alert('Please fill in date, score (1-250) and description.'); return;
            }

            const events = getLifeEvents();
            const value = type === 'positive' ? score : -score;
            events.push({ date, type, score, value, desc, ts: Date.now() });
            events.sort((a, b) => a.date.localeCompare(b.date));
            saveLifeEvents(events);

            document.getElementById('lg_score').value = '';
            document.getElementById('lg_desc').value = '';
            renderLifeGraph();
        }

        function deleteLifeEvent(ts) {
            if (!confirm('Remove this event?')) return;
            const events = getLifeEvents().filter(e => e.ts !== ts);
            saveLifeEvents(events);
            renderLifeGraph();
        }

        function renderLifeGraph() {
            const events = getLifeEvents();

            // ── Build cumulative life score (starts at 125 = midpoint of 0-250)
            let cum = 125;
            const closes = [125]; // store all close values for stats
            const candleData = [];
            const labels = [];

            events.forEach((e, i) => {
                const prev = cum;
                const change = e.type === 'positive' ? e.score * 0.5 : -(e.score * 0.5);
                cum = Math.max(0, Math.min(250, cum + change));

                // Candlestick OHLC values
                const open  = prev;
                const close = cum;
                const isGreen = close >= open;
                // Wick: extend beyond body by ~20% of body height
                const bodyH = Math.abs(close - open) || 2;
                const high  = Math.max(open, close) + bodyH * 0.4;
                const low   = Math.min(open, close) - bodyH * 0.4;

                candleData.push({ o: open, h: high, l: low, c: close, desc: e.desc, type: e.type, score: e.score });
                labels.push(e.date);
                closes.push(close);
            });

            // ── Stats
            if (closes.length > 1) {
                const allClose = closes.slice(1); // skip initial 125
                const maxV = Math.max(...allClose); const maxI = allClose.indexOf(maxV);
                const minV = Math.min(...allClose); const minI = allClose.indexOf(minV);
                const last3 = allClose.slice(-3);
                const trend = last3.length < 2 ? '—' :
                    last3[last3.length-1] > last3[0] ? '📈 Rising' :
                    last3[last3.length-1] < last3[0] ? '📉 Falling' : '➡️ Stable';
                (document.getElementById('gs_high')||{}).textContent  = `${maxV.toFixed(0)} pts (${labels[maxI]})`;
                (document.getElementById('gs_low')||{}).textContent   = `${minV.toFixed(0)} pts (${labels[minI]})`;
                (document.getElementById('gs_trend')||{}).textContent = trend;
            }
            (document.getElementById('gs_total')||{}).textContent = events.length;

            // ── Destroy old chart
            const canvas = document.getElementById('lifeChart');
            if (lifeChartInstance) lifeChartInstance.destroy();

            if (!events.length) {
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
            } else {
                // ── Custom candlestick draw via Chart.js bar + custom plugin
                const GREEN = '#26a69a';
                const RED   = '#ef5350';
                const GREEN_FILL = 'rgba(38,166,154,0.75)';
                const RED_FILL   = 'rgba(239,83,80,0.75)';

                lifeChartInstance = new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [
                            // Body dataset (bar from open to close)
                            {
                                label: 'Body',
                                data: candleData.map(c => [Math.min(c.o, c.c), Math.max(c.o, c.c)]),
                                backgroundColor: candleData.map(c => c.c >= c.o ? GREEN_FILL : RED_FILL),
                                borderColor:     candleData.map(c => c.c >= c.o ? GREEN : RED),
                                borderWidth: 1.5,
                                borderSkipped: false,
                                barPercentage: 0.5,
                                categoryPercentage: 0.6,
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: { duration: 400 },
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(12,12,22,0.97)',
                                borderColor: 'rgba(255,215,140,0.3)',
                                borderWidth: 1,
                                titleColor: '#ffd78c',
                                bodyColor: '#e8e8e8',
                                padding: 12,
                                callbacks: {
                                    title: (items) => labels[items[0].dataIndex],
                                    label: (item) => {
                                        const c = candleData[item.dataIndex];
                                        return [
                                            `Open:  ${c.o.toFixed(1)}`,
                                            `Close: ${c.c.toFixed(1)}`,
                                            `High:  ${c.h.toFixed(1)}`,
                                            `Low:   ${c.l.toFixed(1)}`,
                                            `${c.type === 'positive' ? '😊 +' : '😔 −'}${c.score} pts`,
                                            `📝 ${c.desc}`
                                        ];
                                    }
                                }
                            },
                            // Zoom plugin config
                            zoom: {
                                pan: {
                                    enabled: true,
                                    mode: 'x',
                                    threshold: 5,
                                },
                                zoom: {
                                    wheel: { enabled: true, speed: 0.1 },
                                    pinch: { enabled: true },
                                    mode: 'x',
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { color: '#7a7a8c', maxRotation: 45, font: { size: 11 } },
                                grid: { color: 'rgba(255,255,255,0.04)' },
                            },
                            y: {
                                min: 0, max: 250,
                                ticks: {
                                    color: '#7a7a8c',
                                    stepSize: 25,
                                    callback: v => v
                                },
                                grid: {
                                    color: (ctx) => {
                                        if (ctx.tick.value === 125) return 'rgba(255,215,140,0.25)'; // midline
                                        return 'rgba(255,255,255,0.04)';
                                    }
                                },
                                title: { display: true, text: 'Life Score (0–250)', color: '#a0a0b0', font: { size: 11 } }
                            }
                        }
                    },
                    // Custom plugin: draws the wicks (high/low lines) on each candle
                    plugins: [{
                        id: 'wickDrawer',
                        afterDatasetsDraw(chart) {
                            const { ctx, scales: { x, y } } = chart;
                            candleData.forEach((c, i) => {
                                const xPos = x.getPixelForValue(i);
                                const yHigh = y.getPixelForValue(c.h);
                                const yLow  = y.getPixelForValue(c.l);
                                const yTop  = y.getPixelForValue(Math.max(c.o, c.c));
                                const yBot  = y.getPixelForValue(Math.min(c.o, c.c));
                                const color = c.c >= c.o ? GREEN : RED;
                                ctx.save();
                                ctx.strokeStyle = color;
                                ctx.lineWidth = 1.5;
                                ctx.beginPath();
                                // Upper wick
                                ctx.moveTo(xPos, yTop);
                                ctx.lineTo(xPos, yHigh);
                                // Lower wick
                                ctx.moveTo(xPos, yBot);
                                ctx.lineTo(xPos, yLow);
                                ctx.stroke();
                                ctx.restore();
                            });
                        }
                    }]
                });
            }

            // ── Events list
            const list = document.getElementById('eventsList');
            if (!events.length) {
                list.innerHTML = '<p style="color:#7a7a8c;font-size:0.85rem;padding:0.5rem 0">No events yet. Add your first life event above!</p>';
                return;
            }
            list.innerHTML = [...events].reverse().map(e => `
                <div class="event-row">
                    <span class="event-dot" style="background:${e.type==='positive'?'#26a69a':'#ef5350'}"></span>
                    <span class="event-date">${e.date}</span>
                    <span style="flex:1;color:#e8e8e8;font-size:0.85rem">${escapeHtml(e.desc)}</span>
                    <span class="event-score" style="color:${e.type==='positive'?'#26a69a':'#ef5350'}">${e.type==='positive'?'+':'−'}${e.score}</span>
                    <button class="event-del" onclick="deleteLifeEvent(${e.ts})">✕</button>
                </div>
            `).join('');
        }

        // ── Zoom / Pan helpers
        function zoomLifeChart(dir) {
            if (!lifeChartInstance) return;
            dir === 'in' ? lifeChartInstance.zoom(1.3) : lifeChartInstance.zoom(0.77);
        }
        function panLifeChart(dir) {
            if (!lifeChartInstance) return;
            lifeChartInstance.pan({ x: dir === 'left' ? -60 : 60 }, undefined, 'active');
        }
        function resetLifeZoom() {
            if (!lifeChartInstance) return;
            lifeChartInstance.resetZoom();
        }

        // ═══════════════════════════════════════════════
        //  MYDIARY UI — TABS, QUOTES, CLOCK, SLIDESHOW, BIO, GALLERY
        // ═══════════════════════════════════════════════

        // ── Tab Navigation ──────────────────────────────
        function showTab(name) {
            document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active-tab'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById('tab-' + name).classList.add('active-tab');
            document.querySelector(`.nav-link[data-tab="${name}"]`)?.classList.add('active');
            if (name === 'journal') applyDateFilter();
        }

        // ── Live Clock ──────────────────────────────────
        function tickClock() {
            const now = new Date();
            const h = String(now.getHours()).padStart(2,'0');
            const m = String(now.getMinutes()).padStart(2,'0');
            const s = String(now.getSeconds()).padStart(2,'0');
            (document.getElementById('clockTime')||{}).textContent = `${h}:${m}:${s}`;
            const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            (document.getElementById('clockDate')||{}).textContent =
                `${days[now.getDay()]}, ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
        }
        setInterval(tickClock, 1000);
        tickClock();

        // ── Motivational Quotes ─────────────────────────
        const QUOTES = [
            { text: "The secret of getting ahead is getting started.", author: "Mark Twain" },
            { text: "It always seems impossible until it's done.", author: "Nelson Mandela" },
            { text: "Believe you can and you're halfway there.", author: "Theodore Roosevelt" },
            { text: "Your life is your story. Write it well.", author: "Unknown" },
            { text: "Do something today that your future self will thank you for.", author: "Sean Patrick Flanery" },
            { text: "Small steps every day lead to big changes over time.", author: "Unknown" },
            { text: "You are never too old to set another goal.", author: "C.S. Lewis" },
            { text: "The best time to plant a tree was 20 years ago. The second best time is now.", author: "Chinese Proverb" },
            { text: "Don't watch the clock; do what it does. Keep going.", author: "Sam Levenson" },
            { text: "Keep your face always toward the sunshine — shadows will fall behind you.", author: "Walt Whitman" },
            { text: "Every day is a new beginning. Take a deep breath and start again.", author: "Unknown" },
            { text: "The future belongs to those who believe in the beauty of their dreams.", author: "Eleanor Roosevelt" },
        ];
        let currentQuote = 0;
        let quoteTimer;

        function showQuote(idx) {
            currentQuote = (idx + QUOTES.length) % QUOTES.length;
            const q = QUOTES[currentQuote];
            (document.getElementById('quoteText')||{}).textContent = q.text;
            (document.getElementById('quoteAuthor')||{}).textContent = '— ' + q.author;
            // dots
            const dots = document.getElementById('quoteDots');
            dots.innerHTML = QUOTES.slice(0,8).map((_,i) =>
                `<span class="qdot ${i===currentQuote%8?'active':''}" onclick="showQuote(${i})"></span>`
            ).join('');
        }

        function startQuoteSlideshow() {
            showQuote(Math.floor(Math.random() * QUOTES.length));
            quoteTimer = setInterval(() => showQuote(currentQuote + 1), 6000);
        }

        // ── Mood Tracker ────────────────────────────────
        function setMood(emoji, label) {
            const today = new Date().toDateString();
            localStorage.setItem('mood_today', JSON.stringify({ date: today, emoji, label })); clearTimeout(_kvTimer); _saveKv();
            (document.getElementById('moodSelected')||{}).textContent = `${emoji} ${label}`;
            document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
            event.target.classList.add('selected');
            updateStreak();
        }

        function loadMood() {
            const saved = JSON.parse(localStorage.getItem('mood_today') || 'null');
            const today = new Date().toDateString();
            if (saved && saved.date === today) {
                (document.getElementById('moodSelected')||{}).textContent = `${saved.emoji} ${saved.label}`;
            }
        }

        function updateStreak() {
            let streak = parseInt(localStorage.getItem('diary_streak') || '0');
            const lastDay = localStorage.getItem('diary_last_day') || '';
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            if (lastDay === today) {
                // already counted
            } else if (lastDay === yesterday) {
                streak++;
            } else {
                streak = 1;
            }
            localStorage.setItem('diary_streak', streak); clearTimeout(_kvTimer); _saveKv();
            localStorage.setItem('diary_last_day', today); clearTimeout(_kvTimer); _saveKv();
            (document.getElementById('streakCount')||{}).textContent = streak;
        }

        function loadStreak() {
            const streak = localStorage.getItem('diary_streak') || '0';
            (document.getElementById('streakCount')||{}).textContent = streak;
        }

        // ── Word of the Day ─────────────────────────────
        const WORDS = [
            { word:'Serendipity', pos:'noun', def:'The occurrence of happy events by chance.' },
            { word:'Ephemeral', pos:'adjective', def:'Lasting for a very short time.' },
            { word:'Resilience', pos:'noun', def:'The ability to recover quickly from difficulties.' },
            { word:'Luminous', pos:'adjective', def:'Full of light; bright and shining.' },
            { word:'Tenacity', pos:'noun', def:'The quality of being very determined and persistent.' },
            { word:'Wanderlust', pos:'noun', def:'A strong desire to travel and explore the world.' },
            { word:'Fortitude', pos:'noun', def:'Courage in pain or adversity.' },
            { word:'Euphoria', pos:'noun', def:'A feeling of intense happiness and excitement.' },
            { word:'Perspicacious', pos:'adjective', def:'Having a ready insight into things; shrewd.' },
            { word:'Equanimity', pos:'noun', def:'Mental calmness under stress.' },
        ];

        function loadWotd() {
            const todayIdx = new Date().getDate() % WORDS.length;
            const w = WORDS[Math.floor(Math.random() * WORDS.length)];
            (document.getElementById('wotdWord')||{}).textContent = w.word;
            (document.getElementById('wotdPos')||{}).textContent = w.pos;
            (document.getElementById('wotdDef')||{}).textContent = w.def;
        }

        // ── Quick Note ──────────────────────────────────
        let noteTimer;
        function autoSaveNote() {
            clearTimeout(noteTimer);
            noteTimer = setTimeout(() => {
                localStorage.setItem('quick_note', document.getElementById('quickNoteInput').value); clearTimeout(_kvTimer); _saveKv();
                const el = document.getElementById('quickNoteSaved');
                el.textContent = '✅ Saved';
                setTimeout(() => el.textContent = '', 2000);
            }, 800);
        }

        function loadQuickNote() {
            const note = localStorage.getItem('quick_note') || '';
            const el = document.getElementById('quickNoteInput');
            if (el) el.value = note;
        }

        // ── Achievements Slideshow ──────────────────────
        const SLIDES_KEY = 'diary_slides';
        let slideIndex = 0;

        function getSlides() {
            try { return JSON.parse(localStorage.getItem(SLIDES_KEY) || '[]'); } catch { return []; }
        }

        async function handleSlideUpload(event) {
            const files = Array.from(event.target.files);
            if (!files.length) return;
            const slides = getSlides();
            for (const file of files) {
                try {
                    const { url, path } = await _uploadImage(file, 'slides');
                    slides.push({ id: _uuid(), src: url, path, name: file.name });
                } catch(err) { alert('Upload failed: ' + err.message); }
            }
            localStorage.setItem(SLIDES_KEY, JSON.stringify(slides)); clearTimeout(_kvTimer); _saveKv();
            renderSlideshow();
            event.target.value = '';
        }

        function renderSlideshow() {
            const slides = getSlides();
            const track = document.getElementById('slidesTrack');
            const wrap = document.getElementById('slideshowWrap');
            const empty = document.getElementById('emptySlides');
            const inds = document.getElementById('slideIndicators');

            if (!slides.length) {
                wrap.style.display = 'none';
                empty.style.display = 'block';
                inds.innerHTML = '';
                return;
            }
            wrap.style.display = 'block';
            empty.style.display = 'none';

            track.innerHTML = slides.map((s, i) => `
                <div class="slide-item" onclick="openFullscreen('${s.src}')">
                    <img src="${s.src}" alt="${s.name}" loading="lazy">
                    <div class="slide-caption">${s.name}</div>
                    <button class="slide-del-btn" onclick="event.stopPropagation();deleteSlide(${i})">✕</button>
                </div>
            `).join('');

            inds.innerHTML = slides.map((_, i) =>
                `<span class="slide-ind ${i===slideIndex?'active':''}" onclick="goSlide(${i})"></span>`
            ).join('');
        }

        function slideMove(dir) {
            const slides = getSlides();
            slideIndex = (slideIndex + dir + slides.length) % slides.length;
            const item = document.querySelector('.slide-item');
            if (item) {
                const w = item.offsetWidth + 16;
                document.getElementById('slidesTrack').style.transform = `translateX(-${slideIndex * w}px)`;
                renderSlideIndicators();
            }
        }

        function goSlide(i) { slideIndex = i; slideMove(0); }

        function renderSlideIndicators() {
            const slides = getSlides();
            (document.getElementById('slideIndicators')||{}).innerHTML = slides.map((_, i) =>
                `<span class="slide-ind ${i===slideIndex?'active':''}" onclick="goSlide(${i})"></span>`
            ).join('');
        }

        function deleteSlide(i) {
            const slides = getSlides();
            if (!confirm('Remove this image?')) return;
            slides.splice(i, 1);
            localStorage.setItem(SLIDES_KEY, JSON.stringify(slides)); clearTimeout(_kvTimer); _saveKv();
            renderSlideshow();
        }

        // Auto-slide every 4 seconds
        setInterval(() => { if (getSlides().length > 1) slideMove(1); }, 4000);

        // ── Biography ───────────────────────────────────
        // Map: storage key → exact element ID in HTML
        const BIO_FIELD_MAP = {
            'bio_name':         'bioNameInput',
            'bio_tagline':      'bioTagline',
            'bio_profession':   'bioProfession',
            'bio_location':     'bioLocation',
            'bio_about':        'bioAbout',
            'bio_hobbies':      'bioHobbies',
            'bio_goal':         'bioGoal',
            'bio_achievements': 'bioAchievements'
        };

        async function saveBio() {
            Object.entries(BIO_FIELD_MAP).forEach(([key, elId]) => {
                const el = document.getElementById(elId);
                if (el) localStorage.setItem(key, el.value); clearTimeout(_kvTimer); _saveKv();
            });
            loadBioDisplay();
            clearTimeout(_kvTimer);
            await _saveKv();
            const msg = document.getElementById('bioSavedMsg');
            if (msg) { msg.textContent = '✅ Saved!'; setTimeout(() => { if(msg) msg.textContent = ''; }, 2500); }
        }

        function loadBio() {
            Object.entries(BIO_FIELD_MAP).forEach(([key, elId]) => {
                const el = document.getElementById(elId);
                if (el) el.value = localStorage.getItem(key) || '';
            });
            loadBioDisplay();
        }

        function loadBioDisplay() {
            const name       = localStorage.getItem('bio_name') || 'Your Name';
            const tagline    = localStorage.getItem('bio_tagline') || 'Add your tagline...';
            const profession = localStorage.getItem('bio_profession') || '';
            const location   = localStorage.getItem('bio_location') || '';
            const photo      = localStorage.getItem('bio_photo') || '';

            (document.getElementById('bioName')||{}).textContent = name;
            (document.getElementById('bioTaglineDisplay')||{}).textContent = tagline;
            (document.getElementById('navUsername')||{}).textContent = name.split(' ')[0] || 'MyDiary';

            const badges = document.getElementById('bioBadges');
            if (badges) badges.innerHTML = [profession, location].filter(Boolean)
                .map(b => `<span class="bio-badge">📍 ${b}</span>`).join('');

            if (photo) {
                const img   = document.getElementById('bioAvatarImg');
                const emoji = document.getElementById('bioAvatarEmoji');
                const navAv = document.getElementById('navAvatar');
                if (img)   { img.src = photo; img.style.display = 'block'; }
                if (emoji) emoji.style.display = 'none';
                if (navAv) navAv.innerHTML = `<img src="${photo}" style="width:100%;height:100%;object-fit:cover;border-radius:50%">`;
            }
        }

        async function pickProfilePic() {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = 'image/*';
            input.onchange = async e => {
                const file = e.target.files[0];
                if (!file) return;
                if (file.size > 5 * 1024 * 1024) { alert('Photo must be under 5MB'); return; }
                try {
                    const oldPath = localStorage.getItem('bio_photo_path');
                    if (oldPath) await _sb.storage.from('images').remove([oldPath]);
                    const { url, path } = await _uploadImage(file, 'bio');
                    localStorage.setItem('bio_photo', url); clearTimeout(_kvTimer); _saveKv();
                    localStorage.setItem('bio_photo_path', path); clearTimeout(_kvTimer); _saveKv();
                    loadBioDisplay();
                } catch(err) {
                    alert(err.message);
                }
            };
            input.click();
        }

        // ── Gallery → Supabase Storage ───────────────────
        const GALLERY_KEY = 'diary_gallery_meta'; // stores metadata only

        function getGallery() {
            try { return JSON.parse(localStorage.getItem(GALLERY_KEY) || '[]'); } catch { return []; }
        }

        async function handleGalleryUpload(event) {
            const files = Array.from(event.target.files);
            if (!files.length) return;
            const gallery = getGallery();
            const grid = document.getElementById('galleryGrid');
            if (grid) grid.innerHTML = '<div class="gallery-empty"><span style="font-size:2rem">⏳</span><p>Uploading photos…</p></div>';

            for (const file of files) {
                if (file.size > 20 * 1024 * 1024) { alert(`"${file.name}" over 20MB — skipped`); continue; }
                try {
                    const { url, path } = await _uploadImage(file, 'gallery');
                    gallery.push({ id: _uuid(), src: url, path, name: file.name });
                } catch(err) {
                    alert(`Failed: ${file.name} — ${err.message}`);
                }
            }

            localStorage.setItem(GALLERY_KEY, JSON.stringify(gallery)); clearTimeout(_kvTimer); _saveKv();
            renderGallery();
            event.target.value = '';
        }

        function renderGallery() {
            const gallery = getGallery();
            const grid = document.getElementById('galleryGrid');
            if (!grid) return;
            if (!gallery.length) {
                grid.innerHTML = '<div class="gallery-empty"><span style="font-size:3rem">📷</span><p>Add your photos, certificates, and memories</p></div>';
                (document.getElementById('docCount')||{}).textContent = 0;
                return;
            }
            grid.innerHTML = gallery.map((item, i) => `
                <div class="gallery-item" onclick="openFullscreen('${item.src}')">
                    <img src="${item.src}" alt="${escapeHtml(item.name)}" loading="lazy"
                         onerror="this.style.opacity='0.2';this.title='Image not available'">
                    <button class="gal-del" onclick="event.stopPropagation();deleteGalleryItem(${i})">✕</button>
                </div>
            `).join('');
            (document.getElementById('docCount')||{}).textContent = gallery.length;
        }

        async function deleteGalleryItem(i) {
            const gallery = getGallery();
            if (!confirm('Remove this photo?')) return;
            const item = gallery[i];
            if (item.path) await _sb.storage.from('images').remove([item.path]);
            gallery.splice(i, 1);
            localStorage.setItem(GALLERY_KEY, JSON.stringify(gallery)); clearTimeout(_kvTimer); _saveKv();
            renderGallery();
        }

        // ── Fullscreen viewer ────────────────────────────
        function openFullscreen(src) {
            document.getElementById('imgFullscreenSrc').src = src;
            document.getElementById('imgFullscreen').classList.add('show');
        }

        // ── Update nav username on login ─────────────────

        // ═══════════════════════════════════════════════
        //  DAILY TRACKER
        // ═══════════════════════════════════════════════
        const DT_KEY = 'daily_tracker_data';
        const DT_CUSTOM_KEY = 'dt_custom_tasks';

        const DEFAULT_TASKS = {
            Morning: [
                { label:'☀️ Wake up on time', done:false },
                { label:'💧 Drink water', done:false },
                { label:'🧘 5–10 min silence / meditation', done:false },
                { label:'📝 Write Top 3 tasks', done:false },
                { label:'🏃 Light exercise', done:false },
            ],
            Day: [
                { label:'💪 Finish hardest task first', done:false },
                { label:'📚 Learn something new', done:false },
                { label:'💵 Track money spent today', done:false },
                { label:'🚶 Move body (walk/stretch)', done:false },
                { label:'🥗 Eat one healthy item', done:false },
                { label:'📵 Avoid Instagram / social media', done:false },
            ],
            Evening: [
                { label:'🧹 Clean one small area', done:false },
                { label:'💬 Talk to someone you care about', done:false },
                { label:'🤝 Help one person today', done:false },
                { label:'🌅 Evening walk', done:false },
            ],
            Night: [
                { label:'🌙 Reflect — write 3 lines', done:false },
                { label:'📅 Plan tomorrow', done:false },
                { label:'📵 No phone 30 min before sleep', done:false },
                { label:'🛌 Sleep on time', done:false },
            ],
        };

        let dtCurrentDate = new Date().toISOString().split('T')[0];

        function getDtData() {
            try { return JSON.parse(localStorage.getItem(DT_KEY) || '{}'); } catch { return {}; }
        }
        function saveDtData(data) { localStorage.setItem(DT_KEY, JSON.stringify(data)); } clearTimeout(_kvTimer); _saveKv();

        function getDayTasks(dateStr) {
            const data = getDtData();
            if (!data[dateStr]) {
                // Deep copy defaults + custom tasks
                const custom = JSON.parse(localStorage.getItem(DT_CUSTOM_KEY) || '[]');
                data[dateStr] = JSON.parse(JSON.stringify(DEFAULT_TASKS));
                custom.forEach(t => {
                    if (!data[dateStr][t.section]) data[dateStr][t.section] = [];
                    data[dateStr][t.section].push({ label: t.label, done: false, custom: true });
                });
                saveDtData(data);
            }
            return data[dateStr];
        }

        function openDailyTracker() {
            dtCurrentDate = new Date().toISOString().split('T')[0];
            renderDailyTracker();
            document.getElementById('dailyTrackerModal').classList.add('show');
        }

        function renderDailyTracker() {
            const tasks = getDayTasks(dtCurrentDate);
            const d = new Date(dtCurrentDate + 'T12:00:00');
            (document.getElementById('dtDate')||{}).textContent = d.toDateString();

            // Count progress
            let total = 0, done = 0;
            Object.values(tasks).forEach(arr => arr.forEach(t => { total++; if(t.done) done++; }));
            const pct = total ? Math.round(done / total * 100) : 0;
            document.getElementById('dtProgressFill').style.width = pct + '%';
            (document.getElementById('dtProgressLabel')||{}).textContent = `${done} / ${total} done (${pct}%)`;

            // Streak
            (document.getElementById('dtStreak')||{}).textContent = calcDtStreak();

            // Sections
            const ICONS = { Morning:'🌅', Day:'☀️', Evening:'🌆', Night:'🌙', Custom:'⚙️' };
            const sections = document.getElementById('dtSections');
            sections.innerHTML = Object.entries(tasks).map(([sec, items]) => `
                <div class="dt-section">
                    <div class="dt-section-title">${ICONS[sec]||'📌'} ${sec}</div>
                    ${items.map((t, i) => `
                        <div class="dt-task ${t.done?'done':''}" onclick="toggleDtTask('${sec}',${i})">
                            <input type="checkbox" ${t.done?'checked':''} onclick="event.stopPropagation();toggleDtTask('${sec}',${i})">
                            <span class="dt-task-label">${t.label}</span>
                            ${t.custom ? `<button class="dt-task-del" onclick="event.stopPropagation();removeDtTask('${sec}',${i})">✕</button>` : ''}
                        </div>
                    `).join('')}
                </div>
            `).join('');

            renderDtHeatmap();
        }

        function toggleDtTask(section, idx) {
            const data = getDtData();
            if (data[dtCurrentDate] && data[dtCurrentDate][section] && data[dtCurrentDate][section][idx]) {
                data[dtCurrentDate][section][idx].done = !data[dtCurrentDate][section][idx].done;
                saveDtData(data);
                renderDailyTracker();
            }
        }

        function saveDailyTracker() {
            alert('✅ Day saved! Keep going 🔥');
        }

        function addCustomTask() {
            const label = document.getElementById('dtNewTask').value.trim();
            const section = document.getElementById('dtNewSection').value;
            if (!label) return;

            // Save to custom list so it appears on future days
            const custom = JSON.parse(localStorage.getItem(DT_CUSTOM_KEY) || '[]');
            custom.push({ label, section });
            localStorage.setItem(DT_CUSTOM_KEY, JSON.stringify(custom)); clearTimeout(_kvTimer); _saveKv();

            // Add to today
            const data = getDtData();
            if (!data[dtCurrentDate]) data[dtCurrentDate] = {};
            if (!data[dtCurrentDate][section]) data[dtCurrentDate][section] = [];
            data[dtCurrentDate][section].push({ label, done: false, custom: true });
            saveDtData(data);

            document.getElementById('dtNewTask').value = '';
            renderDailyTracker();
        }

        function removeDtTask(section, idx) {
            const data = getDtData();
            data[dtCurrentDate][section].splice(idx, 1);
            saveDtData(data);
            renderDailyTracker();
        }

        function dtNavigate(dir) {
            const d = new Date(dtCurrentDate + 'T12:00:00');
            d.setDate(d.getDate() + dir);
            dtCurrentDate = d.toISOString().split('T')[0];
            renderDailyTracker();
        }

        function calcDtStreak() {
            const data = getDtData();
            let streak = 0;
            const d = new Date();
            for (let i = 0; i < 365; i++) {
                const key = d.toISOString().split('T')[0];
                const tasks = data[key];
                if (!tasks) break;
                const all = Object.values(tasks).flat();
                const done = all.filter(t => t.done).length;
                if (done === 0 && i > 0) break;
                if (done > 0) streak++;
                d.setDate(d.getDate() - 1);
            }
            return streak;
        }

        function renderDtHeatmap() {
            const data = getDtData();
            const hm = document.getElementById('dtHeatmap');
            const cells = [];
            const d = new Date();
            for (let i = 29; i >= 0; i--) {
                const dd = new Date(d);
                dd.setDate(dd.getDate() - i);
                const key = dd.toISOString().split('T')[0];
                const tasks = data[key];
                let pct = 0;
                if (tasks) {
                    const all = Object.values(tasks).flat();
                    const done = all.filter(t => t.done).length;
                    pct = all.length ? done / all.length : 0;
                }
                const color = pct === 0 ? 'rgba(255,255,255,0.06)' :
                              pct < 0.4 ? 'rgba(255,215,140,0.25)' :
                              pct < 0.7 ? 'rgba(255,215,140,0.55)' : '#34c759';
                cells.push(`<div class="dt-hm-cell" style="background:${color}" title="${key}: ${Math.round(pct*100)}% done"></div>`);
            }
            hm.innerHTML = cells.join('');
        }

        // ═══════════════════════════════════════════════
        //  FINANCE / MONEY MANAGER
        // ═══════════════════════════════════════════════
        const FIN_TX_KEY   = 'fin_transactions';
        const FIN_NW_KEY   = 'fin_networth';
        const FIN_LOAN_KEY = 'fin_loans';
        const FIN_CAP_KEY  = 'fin_initial_capital';
        const FIN_CARRY_KEY = 'fin_carry_forward';

        function fmt(n) { return '₹' + Number(n).toLocaleString('en-IN', {minimumFractionDigits:0}); }

        function getTransactions() { try{return JSON.parse(localStorage.getItem(FIN_TX_KEY)||'[]');}catch{return[];} }
        function saveTransactions(d){ localStorage.setItem(FIN_TX_KEY, JSON.stringify(d)); } clearTimeout(_kvTimer); _saveKv();
        function getNetWorth() { try{return JSON.parse(localStorage.getItem(FIN_NW_KEY)||'[]');}catch{return[];} }
        function saveNetWorth(d){ localStorage.setItem(FIN_NW_KEY, JSON.stringify(d)); } clearTimeout(_kvTimer); _saveKv();
        function getLoans() { try{return JSON.parse(localStorage.getItem(FIN_LOAN_KEY)||'[]');}catch{return[];} }
        function saveLoans(d){ localStorage.setItem(FIN_LOAN_KEY, JSON.stringify(d)); } clearTimeout(_kvTimer); _saveKv();

        function openFinance() {
            document.getElementById('financeModal').classList.add('show');
            loadInitCapital();
            renderFinDashboard();
            renderNetWorth();
            renderLoans();
            populateTxMonthFilter();
        }

        function switchFinTab(tab) {
            document.querySelectorAll('.fin-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.fin-page').forEach(p => p.classList.remove('active-fin'));
            document.querySelector(`.fin-tab[data-ft="${tab}"]`).classList.add('active');
            document.getElementById('fp-' + tab).classList.add('active-fin');
            if (tab === 'transactions') renderTransactions();
            if (tab === 'networth') renderNetWorth();
            if (tab === 'loans') renderLoans();
            if (tab === 'export') _populateExportSelects();
        }

        function setInitCapital() {
            const val = parseFloat(document.getElementById('finInitCapital').value) || 0;
            localStorage.setItem(FIN_CAP_KEY, val); clearTimeout(_kvTimer); _saveKv();
            (document.getElementById('finInitSet')||{}).textContent = `✅ Set to ${fmt(val)}`;
            renderFinDashboard();
        }

        function loadInitCapital() {
            const cap = parseFloat(localStorage.getItem(FIN_CAP_KEY) || 0);
            document.getElementById('finInitCapital').value = cap || '';
            if (cap) (document.getElementById('finInitSet')||{}).textContent = `Current: ${fmt(cap)}`;
        }

        function getMonthKey(dateStr) {
            return dateStr ? dateStr.substring(0,7) : new Date().toISOString().substring(0,7);
        }

        function addTransaction() {
            const type   = document.getElementById('qa_type').value;
            const amount = parseFloat(document.getElementById('qa_amount').value);
            const desc   = document.getElementById('qa_desc').value.trim();
            const cat    = document.getElementById('qa_cat').value;
            if (!amount || !desc) { alert('Please enter amount and description'); return; }

            const txns = getTransactions();
            txns.push({
                id: Date.now(),
                type, amount, desc, cat,
                date: new Date().toISOString(),
                month: getMonthKey(new Date().toISOString())
            });
            saveTransactions(txns);
            document.getElementById('qa_amount').value = '';
            document.getElementById('qa_desc').value = '';
            renderFinDashboard();
        }

        function deleteTransaction(id) {
            const txns = getTransactions().filter(t => t.id !== id);
            saveTransactions(txns);
            renderFinDashboard();
            renderTransactions();
        }

        function renderFinDashboard() {
            const txns = getTransactions();
            const thisMonth = getMonthKey();
            const monthTxns = txns.filter(t => t.month === thisMonth);

            const income  = monthTxns.filter(t => t.type === 'income').reduce((s,t) => s + t.amount, 0);
            const expense = monthTxns.filter(t => t.type === 'expense').reduce((s,t) => s + t.amount, 0);
            const net = income - expense;

            // Carry forward from previous months
            const allMonths = [...new Set(txns.map(t => t.month))].sort();
            let carryForward = parseFloat(localStorage.getItem(FIN_CAP_KEY) || 0);
            allMonths.forEach(m => {
                if (m < thisMonth) {
                    const mTxns = txns.filter(t => t.month === m);
                    const mInc = mTxns.filter(t => t.type === 'income').reduce((s,t) => s+t.amount, 0);
                    const mExp = mTxns.filter(t => t.type === 'expense').reduce((s,t) => s+t.amount, 0);
                    carryForward += mInc - mExp;
                }
            });

            const cashInHand = carryForward + net;

            (document.getElementById('fc_cash')||{}).textContent    = fmt(cashInHand);
            (document.getElementById('fc_income')||{}).textContent  = fmt(income);
            (document.getElementById('fc_expense')||{}).textContent = fmt(expense);
            (document.getElementById('fc_net')||{}).textContent     = fmt(net);
            (document.getElementById('fc_cash_sub')||{}).textContent = `Carry: ${fmt(carryForward)} + Net: ${fmt(net)}`;

            // Recent transactions (last 8)
            const recent = [...txns].reverse().slice(0, 8);
            const recentEl = document.getElementById('finRecentList');
            recentEl.innerHTML = recent.length ? recent.map(t => txnHTML(t)).join('') : '<p style="color:#7a7a8c;font-size:0.85rem;padding:0.5rem">No transactions yet</p>';

            // Monthly summary
            const monthGrid = document.getElementById('finMonthGrid');
            const grouped = {};
            txns.forEach(t => {
                if (!grouped[t.month]) grouped[t.month] = {income:0, expense:0};
                grouped[t.month][t.type] += t.amount;
            });
            const sortedMonths = Object.keys(grouped).sort().reverse().slice(0,6);
            monthGrid.innerHTML = sortedMonths.map(m => {
                const mg = grouped[m];
                const n = mg.income - mg.expense;
                return `<div class="fin-month-card">
                    <div class="fin-mc-month">📅 ${m}</div>
                    <div class="fin-mc-net" style="color:${n>=0?'#26a69a':'#ef5350'}">${fmt(n)}</div>
                    <div style="font-size:0.72rem;color:#7a7a8c">+${fmt(mg.income)} / -${fmt(mg.expense)}</div>
                </div>`;
            }).join('') || '<p style="color:#7a7a8c;font-size:0.85rem">No monthly data yet</p>';
        }

        function txnHTML(t) {
            const isInc = t.type === 'income';
            const d = new Date(t.date);
            return `<div class="fin-tx-item">
                <div class="fin-tx-icon" style="background:${isInc?'rgba(38,166,154,0.15)':'rgba(239,83,80,0.15)'}">
                    ${isInc?'💚':'❤️'}
                </div>
                <div class="fin-tx-desc">
                    <div class="fin-tx-name">${escapeHtml(t.desc)}</div>
                    <div class="fin-tx-meta">${t.cat} · ${d.toLocaleDateString()} ${d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div>
                </div>
                <div class="fin-tx-amt" style="color:${isInc?'#26a69a':'#ef5350'}">${isInc?'+':'−'}${fmt(t.amount)}</div>
                <button class="fin-tx-del" onclick="deleteTransaction(${t.id})">✕</button>
            </div>`;
        }

        function renderTransactions() {
            const type   = document.getElementById('tx_filter_type').value;
            const month  = document.getElementById('tx_filter_month').value;
            const search = document.getElementById('tx_search').value.toLowerCase();
            let txns = getTransactions();
            if (type !== 'all') txns = txns.filter(t => t.type === type);
            if (month) txns = txns.filter(t => t.month === month);
            if (search) txns = txns.filter(t => t.desc.toLowerCase().includes(search) || t.cat.toLowerCase().includes(search));
            txns = [...txns].reverse();
            (document.getElementById('finTxList')||{}).innerHTML = txns.length
                ? txns.map(t => txnHTML(t)).join('')
                : '<p style="color:#7a7a8c;font-size:0.85rem;padding:1rem">No transactions found</p>';
        }

        function populateTxMonthFilter() {
            const months = [...new Set(getTransactions().map(t => t.month))].sort().reverse();
            const sel = document.getElementById('tx_filter_month');
            sel.innerHTML = '<option value="">All Months</option>' + months.map(m => `<option value="${m}">${m}</option>`).join('');
        }

        function addNetWorthItem() {
            const kind  = document.getElementById('nw_kind').value;
            const cat   = document.getElementById('nw_cat').value;
            const name  = document.getElementById('nw_name').value.trim();
            const value = parseFloat(document.getElementById('nw_value').value);
            if (!name || !value) { alert('Enter name and value'); return; }

            const nw = getNetWorth();
            nw.push({ id: Date.now(), kind, cat, name, value, date: new Date().toISOString() });
            saveNetWorth(nw);
            document.getElementById('nw_name').value = '';
            document.getElementById('nw_value').value = '';
            renderNetWorth();
        }

        function deleteNwItem(id) {
            saveNetWorth(getNetWorth().filter(i => i.id !== id));
            renderNetWorth();
        }

        function renderNetWorth() {
            const nw = getNetWorth();
            const assets = nw.filter(i => i.kind === 'asset').reduce((s,i) => s+i.value, 0);
            const liabs  = nw.filter(i => i.kind === 'liability').reduce((s,i) => s+i.value, 0);
            const total  = assets - liabs;

            (document.getElementById('nw_total')||{}).textContent     = fmt(total) + ' Net Worth';
            (document.getElementById('nw_assets')||{}).textContent    = fmt(assets);
            (document.getElementById('nw_liabilities')||{}).textContent = fmt(liabs);

            const listEl = document.getElementById('finNwList');
            if (!nw.length) { listEl.innerHTML = '<p style="color:#7a7a8c;font-size:0.85rem;padding:0.5rem">No items yet. Add your assets and liabilities above.</p>'; return; }

            const assetItems = nw.filter(i => i.kind === 'asset');
            const liabItems  = nw.filter(i => i.kind === 'liability');

            const renderGroup = (items, label, color) => items.length ? `
                <div style="font-size:0.75rem;color:${color};font-weight:700;text-transform:uppercase;letter-spacing:0.06em;padding:0.5rem 0 0.3rem">${label}</div>
                ${items.map(i => `<div class="fin-nw-item">
                    <span class="fin-nw-cat">${i.cat}</span>
                    <span class="fin-nw-name">${escapeHtml(i.name)}</span>
                    <span class="fin-nw-val" style="color:${color}">${fmt(i.value)}</span>
                    <span class="fin-nw-date">${new Date(i.date).toLocaleDateString()}</span>
                    <button class="fin-nw-del" onclick="deleteNwItem(${i.id})">✕</button>
                </div>`).join('')}` : '';

            listEl.innerHTML = renderGroup(assetItems, '✅ Assets', '#26a69a') + renderGroup(liabItems, '❌ Liabilities', '#ef5350');
        }

        function addLoan() {
            const name      = document.getElementById('loan_name').value.trim();
            const principal = parseFloat(document.getElementById('loan_principal').value);
            const emi       = parseFloat(document.getElementById('loan_emi').value);
            const remaining = parseInt(document.getElementById('loan_remaining').value);
            const date      = document.getElementById('loan_date').value;
            if (!name || !principal) { alert('Enter loan name and amount'); return; }

            const loans = getLoans();
            loans.push({ id: Date.now(), name, principal, emi: emi||0, remaining: remaining||0, date: date||new Date().toISOString().split('T')[0], added: new Date().toISOString() });
            saveLoans(loans);
            ['loan_name','loan_principal','loan_emi','loan_remaining','loan_date'].forEach(id => document.getElementById(id).value='');
            renderLoans();
        }

        function deleteLoan(id) {
            saveLoans(getLoans().filter(l => l.id !== id));
            renderLoans();
        }

        function renderLoans() {
            const loans = getLoans();
            const el = document.getElementById('finLoanList');
            if (!loans.length) { el.innerHTML = '<p style="color:#7a7a8c;font-size:0.85rem;padding:0.5rem">No loans added yet.</p>'; return; }
            el.innerHTML = loans.map(l => {
                const paid = l.remaining && l.emi ? Math.max(0, l.principal - l.emi * l.remaining) : 0;
                const pct = l.principal ? Math.round(paid / l.principal * 100) : 0;
                return `<div class="fin-loan-card">
                    <div class="fin-loan-info">
                        <div class="fin-loan-name">🏦 ${escapeHtml(l.name)}</div>
                        <div class="fin-loan-detail">
                            Total: ${fmt(l.principal)} · EMI: ${fmt(l.emi)}/mo · ${l.remaining} months left · Started: ${l.date}
                        </div>
                        <div class="fin-loan-detail" style="margin-top:3px">Outstanding: ${fmt(l.emi * l.remaining)} · Added: ${new Date(l.added).toLocaleDateString()}</div>
                        <div class="fin-loan-progress"><div class="fin-loan-fill" style="width:${pct}%"></div></div>
                        <div style="font-size:0.7rem;color:#7a7a8c;margin-top:2px">${pct}% paid off</div>
                    </div>
                    <button class="fin-loan-del" onclick="deleteLoan(${l.id})">🗑️ Remove</button>
                </div>`;
            }).join('');
        }

        // ═══════════════════════════════════════════════
        //  📥 EXCEL EXPORT — no external library needed
        //  Pure CSV-based XLS that opens in Excel/Sheets
        // ═══════════════════════════════════════════════

        function _populateExportSelects() {
            const txns = getTransactions();
            const months = [...new Set(txns.map(t => t.month))].sort().reverse();
            const years  = [...new Set(months.map(m => m.substring(0,4)))].sort().reverse();

            const mSel = document.getElementById('exp_month_sel');
            const ySel = document.getElementById('exp_year_sel');
            if (mSel) mSel.innerHTML = months.map(m => `<option value="${m}">${m}</option>`).join('') || '<option>No data yet</option>';
            if (ySel) ySel.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('')  || '<option>No data yet</option>';

            const prev = document.getElementById('exp_preview');
            if (prev) prev.textContent = `Total transactions: ${txns.length} · From ${months[months.length-1]||'—'} to ${months[0]||'—'} · ${years.length} year(s) of data`;
        }

        // Build CSV string from rows array
        function _buildCSV(headers, rows) {
            const esc = v => {
                const s = String(v === null || v === undefined ? '' : v);
                return s.includes(',') || s.includes('"') || s.includes('\n') ? `"${s.replace(/"/g,'""')}"` : s;
            };
            return [headers, ...rows].map(r => r.map(esc).join(',')).join('\r\n');
        }

        // Trigger download of CSV file
        function _downloadCSV(csv, filename) {
            const bom = '\uFEFF'; // UTF-8 BOM so Excel shows ₹ symbol correctly
            const blob = new Blob([bom + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = filename; a.click();
            setTimeout(() => URL.revokeObjectURL(url), 1000);
        }

        // Monthly export — all transactions for one month
        function exportMonthlyExcel() {
            const month = document.getElementById('exp_month_sel')?.value;
            if (!month) { alert('No data to export'); return; }
            const txns = getTransactions().filter(t => t.month === month);
            if (!txns.length) { alert('No transactions for ' + month); return; }

            const headers = ['Date','Type','Category','Description','Amount (₹)'];
            const rows = txns.map(t => [
                new Date(t.date).toLocaleDateString('en-IN'),
                t.type.toUpperCase(),
                t.cat,
                t.desc,
                t.amount
            ]);

            // Summary rows at bottom
            const income  = txns.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
            const expense = txns.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
            rows.push([]);
            rows.push(['','','','TOTAL INCOME', income]);
            rows.push(['','','','TOTAL EXPENSE', expense]);
            rows.push(['','','','NET BALANCE', income - expense]);

            _downloadCSV(_buildCSV(headers, rows), `Finance_${month}.csv`);
        }

        // Yearly export — month-by-month summary for one year
        function exportYearlyExcel() {
            const year = document.getElementById('exp_year_sel')?.value;
            if (!year) { alert('No data to export'); return; }
            const txns = getTransactions().filter(t => t.month?.startsWith(year));
            if (!txns.length) { alert('No data for ' + year); return; }

            const months = [...new Set(txns.map(t => t.month))].sort();
            const headers = ['Month','Income (₹)','Expense (₹)','Net Balance (₹)','Transactions'];
            const rows = months.map(m => {
                const mTxns = txns.filter(t=>t.month===m);
                const inc = mTxns.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
                const exp = mTxns.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
                return [m, inc, exp, inc-exp, mTxns.length];
            });

            const totalInc = txns.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
            const totalExp = txns.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
            rows.push([]);
            rows.push([`TOTAL ${year}`, totalInc, totalExp, totalInc-totalExp, txns.length]);

            _downloadCSV(_buildCSV(headers, rows), `Finance_Year_${year}.csv`);
        }

        // Complete history — every transaction ever
        function exportAllHistoryExcel() {
            const txns = getTransactions();
            if (!txns.length) { alert('No transactions yet'); return; }

            const sorted = [...txns].sort((a,b) => new Date(a.date) - new Date(b.date));
            const headers = ['Date','Month','Year','Type','Category','Description','Amount (₹)'];
            const rows = sorted.map(t => [
                new Date(t.date).toLocaleDateString('en-IN'),
                t.month,
                t.month?.substring(0,4),
                t.type.toUpperCase(),
                t.cat,
                t.desc,
                t.amount
            ]);

            const income  = txns.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
            const expense = txns.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
            rows.push([]);
            rows.push(['GRAND TOTAL','','','','','INCOME', income]);
            rows.push(['','','','','','EXPENSE', expense]);
            rows.push(['','','','','','NET BALANCE', income - expense]);

            const first = new Date(sorted[0].date).getFullYear();
            const last  = new Date(sorted[sorted.length-1].date).getFullYear();
            const label = first === last ? first : `${first}_to_${last}`;
            _downloadCSV(_buildCSV(headers, rows), `Finance_Complete_${label}.csv`);
        }

        // Monthly summary only — all months condensed
        function exportMonthlySummaryExcel() {
            const txns = getTransactions();
            if (!txns.length) { alert('No transactions yet'); return; }

            const months = [...new Set(txns.map(t => t.month))].sort();
            const headers = ['Month','Year','Income (₹)','Expense (₹)','Net Balance (₹)','No. of Transactions'];
            const rows = months.map(m => {
                const mTxns = txns.filter(t=>t.month===m);
                const inc = mTxns.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
                const exp = mTxns.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
                return [m, m.substring(0,4), inc, exp, inc-exp, mTxns.length];
            });

            const totalInc = txns.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
            const totalExp = txns.filter(t=>t.type==='expense').reduce((s,t)=>s+t.amount,0);
            rows.push([]);
            rows.push(['ALL TIME TOTAL','', totalInc, totalExp, totalInc-totalExp, txns.length]);

            _downloadCSV(_buildCSV(headers, rows), `Finance_Monthly_Summary.csv`);
        }
        function openModal(id){
            document.getElementById(id)&&document.getElementById(id).classList.add('show');
            if(id==='ideaBankModal') renderIdeas();
            else if(id==='healthInsModal') renderHiPolicies();
            else if(id==='groceryModal'){ var gd=document.getElementById('groc_date'); if(gd&&!gd.value) gd.value=new Date().toISOString().split('T')[0]; renderGroceries(); }
            else if(id==='decisionModal') renderDecisions();
            else if(id==='timeLeaksModal'){ var td=document.getElementById('tt_date'); if(td) td.value=new Date().toISOString().split('T')[0]; renderTimeTracker(); }
            else if(id==='knowledgeModal') renderKnowledge();
            else if(id==='projectsModal') renderProjects();
            else if(id==='emergencyModal') renderEmergencyContacts();
            else if(id==='reportModal') initReportMonth();
            else if(id==='reviewModal'){ var dp=document.getElementById('reviewDatePick'); if(dp) dp.value=new Date().toISOString().split('T')[0]; loadReviewForDate(); var dl=document.getElementById('reviewDailyDate'); if(dl) dl.textContent=new Date().toDateString(); }
        }
        function closeModal(id){ var el=document.getElementById(id); if(el) el.classList.remove('show'); }
        function toggleMoreMenu(){ var el=document.getElementById('navMoreMenu'); if(el) el.classList.toggle('show'); }
        function closeMoreMenu(){ var el=document.getElementById('navMoreMenu'); if(el) el.classList.remove('show'); }
        document.addEventListener('click', function(e){ if(!e.target.closest('.nav-more-wrap')) closeMoreMenu(); });

        function switchWinTab(prefix,tab){
            var modal=document.getElementById(prefix+'Modal');
            if(!modal) return;
            modal.querySelectorAll('.win-tab').forEach(function(t){t.classList.remove('wt-active');});
            modal.querySelectorAll('.win-page').forEach(function(p){p.classList.remove('wp-active');});
            var tPage=document.getElementById(prefix+'-'+tab); if(tPage) tPage.classList.add('wp-active');
            modal.querySelectorAll('.win-tab').forEach(function(t){ if(t.getAttribute('onclick')&&t.getAttribute('onclick').includes("'"+tab+"'")) t.classList.add('wt-active'); });
        }

        // ═══════════════════════════════════════════════
        //  💡 IDEA BANK
        // ═══════════════════════════════════════════════
        var IDEA_KEY='idea_bank';
        var ideaFilter='all';
        function getIdeas(){ try{return JSON.parse(localStorage.getItem(IDEA_KEY)||'[]');}catch(e){return[];} }
        function saveIdeas(d){ localStorage.setItem(IDEA_KEY,JSON.stringify(d)); } clearTimeout(_kvTimer); _saveKv();
        function addIdea(){
            var title=document.getElementById('idea_title').value.trim();
            var desc=document.getElementById('idea_desc').value.trim();
            var type=document.getElementById('idea_type').value;
            var status=document.getElementById('idea_status').value;
            if(!title){alert('Enter idea title');return;}
            var arr=getIdeas();
            arr.unshift({id:Date.now(),title:title,desc:desc,type:type,status:status,date:new Date().toISOString()});
            saveIdeas(arr); renderIdeas();
            document.getElementById('idea_title').value='';
            document.getElementById('idea_desc').value='';
        }
        function filterIdeas(f){
            ideaFilter=f;
            document.querySelectorAll('[id^="ideaFilter"]').forEach(function(b){b.classList.remove('active');});
            var el=document.getElementById('ideaFilter'+f.charAt(0).toUpperCase()+f.slice(1));
            if(el) el.classList.add('active');
            renderIdeas();
        }
        function deleteIdea(id){ if(!confirm('Delete?'))return; saveIdeas(getIdeas().filter(function(i){return i.id!==id;})); renderIdeas(); }
        function renderIdeas(){
            var ideas=getIdeas();
            if(ideaFilter!=='all') ideas=ideas.filter(function(i){return i.type===ideaFilter;});
            var statusEmoji={new:'🆕',exploring:'🔍',active:'🚀',done:'✅',dropped:'❌'};
            var el=document.getElementById('ideaGrid'); if(!el) return;
            el.innerHTML=ideas.length?ideas.map(function(idea){return '<div class="idea-card"><button class="idea-del" onclick="deleteIdea('+idea.id+')">✕</button><div style="display:flex;gap:0.4rem;margin-bottom:0.5rem;flex-wrap:wrap"><span class="idea-tag '+idea.type+'">'+idea.type+'</span><span class="idea-tag" style="background:rgba(255,255,255,0.05);color:#a0a0b0;border:1px solid rgba(255,255,255,0.08)">'+(statusEmoji[idea.status]||'')+' '+idea.status+'</span></div><div class="idea-title">'+escapeHtml(idea.title)+'</div><div class="idea-body">'+escapeHtml(idea.desc||'')+'</div><div class="idea-footer">💡 '+new Date(idea.date).toLocaleDateString()+'</div></div>';}).join(''):'<p style="color:#7a7a8c;grid-column:1/-1;text-align:center;padding:2rem">No ideas yet — start capturing!</p>';
        }

        // ═══════════════════════════════════════════════
        //  🏥 HEALTH INSURANCE
        // ═══════════════════════════════════════════════
        var HI_KEY='health_insurance';
        function getHiPolicies(){ try{return JSON.parse(localStorage.getItem(HI_KEY)||'[]');}catch(e){return[];} }
        function addHiPolicy(){
            var flds=['hi_name','hi_company','hi_polno','hi_sum','hi_premium','hi_renewal','hi_members','hi_agent','hi_notes'];
            var d={id:Date.now(),added:new Date().toISOString()};
            flds.forEach(function(f){ d[f.replace('hi_','')]=document.getElementById(f)?document.getElementById(f).value:''; });
            if(!d.name){alert('Enter policy name');return;}
            var arr=getHiPolicies(); arr.push(d);
            localStorage.setItem(HI_KEY,JSON.stringify(arr)); clearTimeout(_kvTimer); _saveKv();
            flds.forEach(function(f){ var el=document.getElementById(f); if(el) el.value=''; });
            renderHiPolicies();
        }
        function deleteHiPolicy(i){ if(!confirm('Remove?'))return; var a=getHiPolicies(); a.splice(i,1); localStorage.setItem(HI_KEY,JSON.stringify(a)); renderHiPolicies(); } clearTimeout(_kvTimer); _saveKv();
        function renderHiPolicies(){
            var pols=getHiPolicies();
            var el=document.getElementById('hiPoliciesList'); if(!el) return;
            if(!pols.length){el.innerHTML='<p style="color:#7a7a8c;padding:1rem">No policies yet.</p>';return;}
            el.innerHTML=pols.map(function(p,i){
                return '<div class="hi-policy-card"><button class="idea-del" style="opacity:1" onclick="deleteHiPolicy('+i+')">✕</button><div class="hi-policy-name">🏥 '+escapeHtml(p.name||'')+' <span style="color:#7a7a8c;font-size:0.82rem">— '+escapeHtml(p.company||'')+'</span></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;margin-top:0.6rem">'+(p.polno?'<div><div class="dj-label">Policy No</div><div class="dj-value">'+escapeHtml(p.polno)+'</div></div>':'')+(p.sum?'<div><div class="dj-label">Sum Insured</div><div class="dj-value" style="color:#26a69a;font-weight:700">'+fmt(p.sum)+'</div></div>':'')+(p.premium?'<div><div class="dj-label">Premium/Year</div><div class="dj-value">'+fmt(p.premium)+'</div></div>':'')+(p.renewal?'<div><div class="dj-label">Renewal</div><div class="dj-value" style="color:#ffd78c">'+p.renewal+'</div></div>':'')+(p.members?'<div style="grid-column:1/-1"><div class="dj-label">Members</div><div class="dj-value">'+escapeHtml(p.members)+'</div></div>':'')+(p.agent?'<div style="grid-column:1/-1"><div class="dj-label">Agent</div><div class="dj-value">'+escapeHtml(p.agent)+'</div></div>':'')+(p.notes?'<div style="grid-column:1/-1"><div class="dj-label">Coverage Notes</div><div class="dj-value">'+escapeHtml(p.notes)+'</div></div>':'')+'</div><div style="font-size:0.7rem;color:#5a5a6c;margin-top:0.5rem">Added: '+new Date(p.added).toLocaleDateString()+'</div></div>';
            }).join('');
        }

        // ═══════════════════════════════════════════════
        //  🛒 GROCERY HISTORY
        // ═══════════════════════════════════════════════
        var GROC_KEY='grocery_history';
        var grocImgData='';
        function getGroceries(){ try{return JSON.parse(localStorage.getItem(GROC_KEY)||'[]');}catch(e){return[];} }
        function previewGrocImg(){
            var f=document.getElementById('groc_img'); if(!f||!f.files[0]) return;
            var r=new FileReader();
            r.onload=function(e){ grocImgData=e.target.result; var p=document.getElementById('groc_img_preview'); if(p){p.src=e.target.result;p.style.display='block';} };
            r.readAsDataURL(f.files[0]);
        }
        function addGrocery(){
            var store=document.getElementById('groc_store').value.trim();
            var amount=parseFloat(document.getElementById('groc_amount').value)||0;
            var date=document.getElementById('groc_date').value||new Date().toISOString().split('T')[0];
            var items=document.getElementById('groc_items').value.trim();
            if(!store){alert('Enter store name');return;}
            var g=getGroceries();
            g.unshift({id:Date.now(),store:store,amount:amount,date:date,items:items,img:grocImgData,added:new Date().toISOString()});
            localStorage.setItem(GROC_KEY,JSON.stringify(g)); clearTimeout(_kvTimer); _saveKv();
            ['groc_store','groc_amount','groc_items'].forEach(function(id){ var el=document.getElementById(id); if(el) el.value=''; });
            var p=document.getElementById('groc_img_preview'); if(p) p.style.display='none';
            grocImgData=''; renderGroceries();
        }
        function deleteGrocery(i){ if(!confirm('Remove?'))return; var g=getGroceries(); g.splice(i,1); localStorage.setItem(GROC_KEY,JSON.stringify(g)); renderGroceries(); } clearTimeout(_kvTimer); _saveKv();
        function renderGroceries(){
            var g=getGroceries();
            var el=document.getElementById('groceryList'); if(!el) return;
            if(!g.length){el.innerHTML='<p style="color:#7a7a8c;padding:1rem">No grocery history yet.</p>';return;}
            el.innerHTML=g.map(function(item,i){
                return '<div class="groc-item"><div class="groc-img" onclick="'+(item.img?'openFullscreen(\''+item.img+'\')':'void(0)')+'">'+(item.img?'<img src="'+item.img+'" alt="receipt">':(item.store?'🛒':'🛒'))+'</div><div style="flex:1;min-width:0"><div style="font-size:0.9rem;font-weight:700;color:#e8e8e8">'+escapeHtml(item.store)+'</div><div style="font-size:0.78rem;color:#a0a0b0;margin-top:2px">'+escapeHtml(item.items||'')+'</div><div style="font-size:0.72rem;color:#7a7a8c;margin-top:3px">📅 '+item.date+'</div></div><div style="font-size:1rem;font-weight:800;color:#26a69a;white-space:nowrap;flex-shrink:0">'+(item.amount?fmt(item.amount):'')+'</div><button style="background:none;border:none;color:#ff6b6b;cursor:pointer;font-size:0.8rem;flex-shrink:0" onclick="deleteGrocery('+i+')">✕</button></div>';
            }).join('');
        }

        // ═══════════════════════════════════════════════
        //  🧠 DECISION JOURNAL
        // ═══════════════════════════════════════════════
        var DJ_KEY='decision_journal';
        function getDecisions(){ try{return JSON.parse(localStorage.getItem(DJ_KEY)||'[]');}catch(e){return[];} }
        function addDecision(){
            var decision=document.getElementById('dj_decision').value.trim();
            if(!decision){alert('Enter the decision taken');return;}
            var arr=getDecisions();
            arr.unshift({id:Date.now(),decision:decision,
                expected:document.getElementById('dj_expected').value.trim(),
                why:document.getElementById('dj_why').value.trim(),
                score:parseInt(document.getElementById('dj_score').value)||5,
                reviewDate:document.getElementById('dj_review_date').value,
                actual:'',lessons:'',date:new Date().toISOString()});
            localStorage.setItem(DJ_KEY,JSON.stringify(arr)); clearTimeout(_kvTimer); _saveKv();
            ['dj_decision','dj_expected','dj_why','dj_score','dj_review_date'].forEach(function(id){ var el=document.getElementById(id); if(el) el.value=''; });
            renderDecisions();
        }
        function updateDecision(id,field,val){
            var arr=getDecisions(); var d=arr.find(function(d){return d.id===id;});
            if(d){d[field]=val;localStorage.setItem(DJ_KEY,JSON.stringify(arr));} clearTimeout(_kvTimer); _saveKv();
        }
        function renderDecisions(){
            var arr=getDecisions();
            var el=document.getElementById('decisionList'); if(!el) return;
            if(!arr.length){el.innerHTML='<p style="color:#7a7a8c;padding:1rem">No decisions logged yet.</p>';return;}
            el.innerHTML=arr.map(function(d){
                var scoreColor=d.score>=7?'#26a69a':d.score>=4?'#ffd78c':'#ef5350';
                return '<div class="dj-card"><div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.75rem;gap:0.5rem"><div style="font-size:0.95rem;font-weight:700;color:#ffd78c;flex:1">'+escapeHtml(d.decision)+'</div><div class="dj-q-score" style="color:'+scoreColor+';flex-shrink:0">'+d.score+'/10</div></div><div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem"><div><div class="dj-label">🎯 Expected</div><div class="dj-value">'+escapeHtml(d.expected||'—')+'</div></div><div><div class="dj-label">⚖️ Why</div><div class="dj-value">'+escapeHtml(d.why||'—')+'</div></div><div><div class="dj-label">⏳ Actual Outcome</div><textarea class="review-textarea" rows="2" style="margin-top:0.3rem;width:100%" placeholder="What happened?" onchange="updateDecision('+d.id+',\'actual\',this.value)">'+escapeHtml(d.actual||'')+'</textarea></div><div><div class="dj-label">📚 Lessons Learned</div><textarea class="review-textarea" rows="2" style="margin-top:0.3rem;width:100%" placeholder="What did you learn?" onchange="updateDecision('+d.id+',\'lessons\',this.value)">'+escapeHtml(d.lessons||'')+'</textarea></div></div><div style="display:flex;justify-content:space-between;font-size:0.7rem;color:#5a5a6c;margin-top:0.6rem"><span>📅 '+new Date(d.date).toLocaleDateString()+'</span>'+(d.reviewDate?'<span>🔔 Review by: '+d.reviewDate+'</span>':'')+'</div></div>';
            }).join('');
        }

        // ═══════════════════════════════════════════════
        //  ⏱️ TIME TRACKER
        // ═══════════════════════════════════════════════
        var TT_KEY='time_tracker';
        var focusInterval=null; var focusSecsLeft=25*60; var focusActive=false;
        function getTimeLogs(){ try{return JSON.parse(localStorage.getItem(TT_KEY)||'[]');}catch(e){return[];} }
        function addTimeLog(){
            var app=document.getElementById('tt_app').value.trim();
            var mins=parseInt(document.getElementById('tt_mins').value)||0;
            var type=document.getElementById('tt_type').value;
            var icon=document.getElementById('tt_app_icon').value;
            var date=document.getElementById('tt_date').value||new Date().toISOString().split('T')[0];
            if(!app||!mins){alert('Enter activity name and minutes');return;}
            var logs=getTimeLogs();
            logs.push({id:Date.now(),app:app,mins:mins,type:type,icon:icon,date:date});
            localStorage.setItem(TT_KEY,JSON.stringify(logs)); clearTimeout(_kvTimer); _saveKv();
            document.getElementById('tt_app').value=''; document.getElementById('tt_mins').value='';
            renderTimeTracker();
        }
        function renderTimeTracker(){
            var logs=getTimeLogs();
            var dateEl=document.getElementById('tt_date');
            var date=dateEl?dateEl.value:new Date().toISOString().split('T')[0];
            var dayLogs=logs.filter(function(l){return l.date===date;});
            var leakMins=dayLogs.filter(function(l){return l.type==='leak';}).reduce(function(s,l){return s+l.mins;},0);
            var prodMins=dayLogs.filter(function(l){return l.type==='productive';}).reduce(function(s,l){return s+l.mins;},0);
            var totalMins=dayLogs.reduce(function(s,l){return s+l.mins;},0);
            var rep=document.getElementById('ttReport'); if(!rep) return;
            rep.innerHTML='<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:0.75rem;margin-bottom:1rem"><div class="fin-card green-card"><div class="fin-card-label">✅ Productive</div><div class="fin-card-val">'+Math.floor(prodMins/60)+'h '+(prodMins%60)+'m</div></div><div class="fin-card red-card"><div class="fin-card-label">⚠️ Time Leaks</div><div class="fin-card-val">'+Math.floor(leakMins/60)+'h '+(leakMins%60)+'m</div></div><div class="fin-card gold-card"><div class="fin-card-label">📊 Leak Rate</div><div class="fin-card-val">'+(totalMins?Math.round(leakMins/totalMins*100):0)+'%</div></div></div>'+(leakMins>60?'<div class="lock-note" style="margin-bottom:0.75rem">📉 Time Leak: You lost '+Math.floor(leakMins/60)+'h '+(leakMins%60)+'m to distractions today!</div>':'');
            var appsMap={};
            dayLogs.forEach(function(l){ if(!appsMap[l.app]) appsMap[l.app]={mins:0,type:l.type,icon:l.icon}; appsMap[l.app].mins+=l.mins; });
            var maxMins=Math.max.apply(null,Object.values(appsMap).map(function(a){return a.mins;}).concat([1]));
            var el=document.getElementById('ttList'); if(!el) return;
            var entries=Object.entries(appsMap).sort(function(a,b){return b[1].mins-a[1].mins;});
            el.innerHTML=entries.length?entries.map(function(e){
                var app=e[0],d=e[1];
                var barColor=d.type==='leak'?'#ef5350':d.type==='productive'?'#26a69a':'#ffd78c';
                var timeStr=d.mins<60?d.mins+'m':Math.floor(d.mins/60)+'h '+(d.mins%60)+'m';
                return '<div class="tt-app-row"><span class="tt-app-icon">'+d.icon+'</span><span class="tt-app-name">'+escapeHtml(app)+'</span><div class="tt-bar-wrap"><div class="tt-bar" style="width:'+(d.mins/maxMins*100)+'%;background:'+barColor+'"></div></div><span class="tt-time">'+timeStr+'</span></div>';
            }).join(''):'<p style="color:#7a7a8c;padding:0.75rem 0">No logs for this day yet.</p>';
        }
        function toggleFocusMode(){
            if(focusActive){
                clearInterval(focusInterval); focusActive=false;
                var btn=document.getElementById('focusModeBtn'); if(btn){btn.textContent='🎯 Start Focus Mode';btn.classList.remove('active');}
                var t=document.getElementById('focusTimer'); if(t) t.style.display='none';
                var s=document.getElementById('focusStatus'); if(s) s.textContent='';
            } else {
                focusSecsLeft=25*60; focusActive=true;
                var btn=document.getElementById('focusModeBtn'); if(btn){btn.textContent='⏹ Stop Focus';btn.classList.add('active');}
                var t=document.getElementById('focusTimer'); if(t) t.style.display='block';
                var s=document.getElementById('focusStatus'); if(s) s.textContent='🔕 25-min Pomodoro running…';
                focusInterval=setInterval(function(){
                    focusSecsLeft--;
                    var m=Math.floor(focusSecsLeft/60),sc=focusSecsLeft%60;
                    var t=document.getElementById('focusTimer'); if(t) t.textContent=(m<10?'0':'')+m+':'+(sc<10?'0':'')+sc;
                    if(focusSecsLeft<=0){
                        clearInterval(focusInterval); focusActive=false;
                        var s=document.getElementById('focusStatus'); if(s) s.textContent='✅ Done! Take a 5-min break.';
                        var btn=document.getElementById('focusModeBtn'); if(btn){btn.textContent='🎯 Start Focus Mode';btn.classList.remove('active');}
                    }
                },1000);
            }
        }

        // ═══════════════════════════════════════════════
        //  🧩 KNOWLEDGE GRAPH
        // ═══════════════════════════════════════════════
        var KG_KEY='knowledge_graph';
        function getKnowledgeNotes(){ try{return JSON.parse(localStorage.getItem(KG_KEY)||'[]');}catch(e){return[];} }
        function addKnowledge(){
            var title=document.getElementById('kg_title').value.trim();
            if(!title){alert('Enter note title');return;}
            var notes=getKnowledgeNotes();
            var links=(document.getElementById('kg_links').value||'').split(',').map(function(s){return s.trim();}).filter(Boolean);
            notes.unshift({id:Date.now(),title:title,topic:document.getElementById('kg_topic').value.trim(),content:document.getElementById('kg_content').value.trim(),links:links,level:parseInt(document.getElementById('kg_level').value)||3,date:new Date().toISOString()});
            localStorage.setItem(KG_KEY,JSON.stringify(notes)); clearTimeout(_kvTimer); _saveKv();
            ['kg_title','kg_topic','kg_content','kg_links','kg_level'].forEach(function(id){ var el=document.getElementById(id); if(el) el.value=''; });
            var f=document.getElementById('kgAddForm'); if(f) f.style.display='none';
            renderKnowledge();
        }
        function renderKnowledge(){
            var q=(document.getElementById('kg_search')?document.getElementById('kg_search').value:'').toLowerCase();
            var notes=getKnowledgeNotes();
            if(q) notes=notes.filter(function(n){return (n.title+n.topic+n.content+n.links.join(' ')).toLowerCase().indexOf(q)>=0;});
            var el=document.getElementById('knowledgeGrid'); if(!el) return;
            el.innerHTML=notes.length?notes.map(function(n){
                var stars='★'.repeat(n.level)+'☆'.repeat(5-n.level);
                var excerpt=(n.content||'').substring(0,130)+(n.content&&n.content.length>130?'…':'');
                var linksHtml=n.links.length?'<div class="note-links">'+n.links.map(function(l){return '<span class="note-link-tag" onclick="event.stopPropagation();document.getElementById(\'kg_search\').value=\''+escapeHtml(l)+'\';renderKnowledge()">🔗 '+escapeHtml(l)+'</span>';}).join('')+'</div>':'';
                return '<div class="note-card"><div style="display:flex;justify-content:space-between;align-items:flex-start"><div class="note-title">'+escapeHtml(n.title)+'</div><span style="font-size:0.75rem;color:#9a75ea">'+stars+'</span></div>'+(n.topic?'<div style="font-size:0.72rem;color:#a0a0b0;margin-bottom:0.35rem">🏷️ '+escapeHtml(n.topic)+'</div>':'')+'<div style="font-size:0.82rem;color:#a0a0b0;line-height:1.5">'+escapeHtml(excerpt)+'</div>'+linksHtml+'<div style="font-size:0.7rem;color:#5a5a6c;margin-top:0.5rem">'+new Date(n.date).toLocaleDateString()+'</div></div>';
            }).join(''):'<p style="color:#7a7a8c;grid-column:1/-1;text-align:center;padding:2rem">No notes yet. Build your knowledge graph!</p>';
        }

        // ═══════════════════════════════════════════════
        //  🏗️ LIFE PROJECTS
        // ═══════════════════════════════════════════════
        var PROJ_KEY='life_projects';
        function getProjects(){ try{return JSON.parse(localStorage.getItem(PROJ_KEY)||'[]');}catch(e){return[];} }
        function addProject(){
            var name=document.getElementById('proj_name').value.trim();
            if(!name){alert('Enter project name');return;}
            var projs=getProjects();
            projs.unshift({id:Date.now(),name:name,cat:document.getElementById('proj_cat').value,date:document.getElementById('proj_date').value,desc:document.getElementById('proj_desc').value.trim(),priority:document.getElementById('proj_priority').value,milestones:[],progress:0,status:'active',added:new Date().toISOString()});
            localStorage.setItem(PROJ_KEY,JSON.stringify(projs)); clearTimeout(_kvTimer); _saveKv();
            ['proj_name','proj_date','proj_desc'].forEach(function(id){ var el=document.getElementById(id); if(el) el.value=''; });
            renderProjects();
        }
        function addMilestone(projId){
            var input=document.getElementById('ms_'+projId); if(!input) return;
            var text=input.value.trim(); if(!text) return;
            var projs=getProjects(); var p=projs.find(function(p){return p.id===projId;});
            if(p){p.milestones.push({text:text,done:false});localStorage.setItem(PROJ_KEY,JSON.stringify(projs));renderProjects();} clearTimeout(_kvTimer); _saveKv();
            input.value='';
        }
        function toggleMilestone(projId,idx){
            var projs=getProjects(); var p=projs.find(function(p){return p.id===projId;});
            if(p&&p.milestones[idx]){p.milestones[idx].done=!p.milestones[idx].done;p.progress=p.milestones.length?Math.round(p.milestones.filter(function(m){return m.done;}).length/p.milestones.length*100):0;localStorage.setItem(PROJ_KEY,JSON.stringify(projs));renderProjects();} clearTimeout(_kvTimer); _saveKv();
        }
        function deleteProject(id){ if(!confirm('Delete project?'))return; localStorage.setItem(PROJ_KEY,JSON.stringify(getProjects().filter(function(p){return p.id!==id;}))); renderProjects(); } clearTimeout(_kvTimer); _saveKv();
        function renderProjects(){
            var projs=getProjects(); var el=document.getElementById('projectsList'); if(!el) return;
            var prioColor={high:'#ef5350',medium:'#ffd78c',low:'#26a69a'};
            el.innerHTML=projs.length?projs.map(function(p){
                var milestonesHtml=(p.milestones||[]).map(function(m,i){return '<div class="milestone-item"><input type="checkbox" '+(m.done?'checked':'')+' onclick="toggleMilestone('+p.id+','+i+')"><span style="'+(m.done?'text-decoration:line-through;color:#5a5a6c':'')+'">'+escapeHtml(m.text)+'</span></div>';}).join('');
                return '<div class="proj-card"><div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:0.5rem"><div><div class="proj-title">'+escapeHtml(p.name)+'</div><div style="font-size:0.72rem;color:#7a7a8c">'+p.cat+' · '+(p.date||'Open-ended')+' · <span style="color:'+(prioColor[p.priority]||'#ffd78c')+'">'+((p.priority||'').toUpperCase())+'</span></div></div><div style="display:flex;gap:0.5rem;align-items:center"><span style="font-size:1.1rem;font-weight:800;color:#ffd78c">'+p.progress+'%</span><button class="fin-loan-del" onclick="deleteProject('+p.id+')">🗑️</button></div></div>'+(p.desc?'<div style="font-size:0.82rem;color:#a0a0b0;margin:0.5rem 0">'+escapeHtml(p.desc)+'</div>':'')+'<div class="proj-progress-bar"><div class="proj-fill" style="width:'+p.progress+'%"></div></div><div style="font-size:0.78rem;font-weight:600;color:#a0a0b0;margin:0.5rem 0 0.35rem">🪜 Milestones</div>'+milestonesHtml+'<div style="display:flex;gap:0.5rem;margin-top:0.5rem"><input class="fin-input-sm" id="ms_'+p.id+'" placeholder="Add milestone…" style="flex:1" onkeydown="if(event.key===\'Enter\')addMilestone('+p.id+')"><button class="add-event-btn" style="padding:0.4rem 0.75rem;font-size:0.8rem" onclick="addMilestone('+p.id+')">+</button></div></div>';
            }).join(''):'<p style="color:#7a7a8c;padding:1rem">No projects yet. Create your first life project!</p>';
        }

        // ═══════════════════════════════════════════════
        //  🚨 EMERGENCY CONTACTS
        // ═══════════════════════════════════════════════
        var EC_KEY='emergency_contacts';
        function getEmergencyContacts(){ try{return JSON.parse(localStorage.getItem(EC_KEY)||'[]');}catch(e){return[];} }
        function addEmergencyContact(){
            var flds=['ec_name','ec_relation','ec_phone1','ec_phone2','ec_email','ec_location','ec_blood','ec_notes'];
            var d={id:Date.now(),added:new Date().toISOString()};
            flds.forEach(function(f){ d[f.replace('ec_','')]=document.getElementById(f)?document.getElementById(f).value:''; });
            if(!d.name){alert('Enter contact name');return;}
            var arr=getEmergencyContacts(); arr.push(d);
            localStorage.setItem(EC_KEY,JSON.stringify(arr)); clearTimeout(_kvTimer); _saveKv();
            flds.forEach(function(f){ var el=document.getElementById(f); if(el) el.value=''; });
            renderEmergencyContacts();
        }
        function deleteEmergencyContact(i){ if(!confirm('Remove?'))return; var c=getEmergencyContacts(); c.splice(i,1); localStorage.setItem(EC_KEY,JSON.stringify(c)); renderEmergencyContacts(); } clearTimeout(_kvTimer); _saveKv();
        function renderEmergencyContacts(){
            var contacts=getEmergencyContacts(); var el=document.getElementById('emergencyGrid'); if(!el) return;
            el.innerHTML=contacts.length?contacts.map(function(c,i){
                return '<div class="ec-card"><button class="idea-del" onclick="deleteEmergencyContact('+i+')">✕</button><div class="ec-avatar">👤</div><div class="ec-name">'+escapeHtml(c.name)+'</div><div style="font-size:0.72rem;color:#9a75ea;margin-top:2px">'+escapeHtml(c.relation||'')+'</div>'+(c.phone1?'<div class="ec-phone">📞 '+escapeHtml(c.phone1)+'</div>':'')+(c.phone2?'<div class="ec-detail">📞 '+escapeHtml(c.phone2)+'</div>':'')+(c.email?'<div class="ec-detail">✉️ '+escapeHtml(c.email)+'</div>':'')+(c.location?'<div class="ec-detail">📍 '+escapeHtml(c.location)+'</div>':'')+(c.blood?'<div style="font-size:0.72rem;color:#ef5350;margin-top:4px;font-weight:700">🩸 '+escapeHtml(c.blood)+'</div>':'')+(c.notes?'<div class="ec-detail" style="margin-top:4px;font-style:italic">'+escapeHtml(c.notes)+'</div>':'')+'</div>';
            }).join(''):'<p style="color:#7a7a8c;grid-column:1/-1;text-align:center;padding:2rem">No emergency contacts yet.</p>';
        }

        // ═══════════════════════════════════════════════
        //  🎯 AI COACH
        // ═══════════════════════════════════════════════
        var COACH_PERSONAS={
            study:{name:'👨‍🏫 Study Coach',sys:'You are an expert study coach. Help with focus, learning strategies, memory techniques, and exam prep. Be concise and motivating.'},
            career:{name:'💼 Career Coach',sys:'You are an expert career coach. Help with job search, interview prep, skills, and career growth. Give actionable advice.'},
            finance:{name:'💰 Finance Coach',sys:'You are a personal finance coach. Help with budgeting, saving, investing, and building wealth. Keep advice practical.'},
            mental:{name:'🧘 Mental Health Coach',sys:'You are a compassionate mindset and wellness coach. Help with stress, emotions, resilience, and positive thinking. Be empathetic.'},
            fitness:{name:'🏋️ Fitness Coach',sys:'You are an expert fitness and nutrition coach. Help with workouts, diet, and healthy habits. Give realistic, practical advice.'}
        };
        var currentCoach=null; var coachHistory=[];
        function startCoach(type){
            currentCoach=COACH_PERSONAS[type]; coachHistory=[];
            document.getElementById('coachSelect').style.display='none';
            document.getElementById('coachChatWrap').style.display='block';
            (document.getElementById('coachActiveTitle')||{}).textContent=currentCoach.name;
            var body=document.getElementById('coachChatBody');
            if(body) body.innerHTML='<div class="coach-msg ai">Hello! I\'m your '+currentCoach.name+'. How can I help you today? 😊</div>';
        }
        async function sendCoachMsg(){
            if(!currentCoach) return;
            var input=document.getElementById('coachInput'); if(!input) return;
            var msg=input.value.trim(); if(!msg) return;
            input.value='';
            var body=document.getElementById('coachChatBody'); if(!body) return;
            body.innerHTML+='<div class="coach-msg user">'+escapeHtml(msg)+'</div>';
            body.innerHTML+='<div class="coach-msg ai" id="coachTyping">✍️ Thinking…</div>';
            body.scrollTop=body.scrollHeight;
            coachHistory.push({role:'user',content:msg});
            try{
                var res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:600,system:currentCoach.sys,messages:coachHistory.slice(-10)})});
                var data=await res.json();
                var reply=(data.content&&data.content[0]&&data.content[0].text)||'Sorry, I could not respond.';
                coachHistory.push({role:'assistant',content:reply});
                var t=document.getElementById('coachTyping'); if(t) t.textContent=reply;
            }catch(e){
                var t=document.getElementById('coachTyping'); if(t) t.textContent='Connection error. Please try again.';
            }
            body.scrollTop=body.scrollHeight;
        }

        // ═══════════════════════════════════════════════
        //  📆 REVIEW SYSTEM
        // ═══════════════════════════════════════════════
        var REVIEW_KEY='review_system';
        var reviewRatings={daily:0,yearly:0};
        function getReviews(){ try{return JSON.parse(localStorage.getItem(REVIEW_KEY)||'{}');}catch(e){return {};} }
        function loadReviewForDate(){
            var dp=document.getElementById('reviewDatePick'); if(!dp) return;
            var date=dp.value; var reviews=getReviews(); var d=reviews[date]||{};
            ['rev_d_well','rev_d_improve','rev_d_gratitude','rev_d_tomorrow','rev_w_win','rev_w_learn','rev_w_habit','rev_w_drain','rev_w_focus','rev_m_achieved','rev_m_missed','rev_m_finance','rev_m_growth','rev_m_theme','rev_y_wins','rev_y_regrets','rev_y_grow','rev_y_people','rev_y_vision'].forEach(function(f){ var el=document.getElementById(f); if(el) el.value=d[f]||''; });
            if(d.dailyRating) setRating('daily',d.dailyRating,true);
            if(d.yearlyRating) setRating('yearly',d.yearlyRating,true);
        }
        var reviewSaveTimer;
        function autoSaveReview(){ clearTimeout(reviewSaveTimer); reviewSaveTimer=setTimeout(function(){saveReview(true);},800); }
        function saveReview(silent){
            var reviews=getReviews();
            var date=(document.getElementById('reviewDatePick')?document.getElementById('reviewDatePick').value:null)||new Date().toISOString().split('T')[0];
            if(!reviews[date]) reviews[date]={};
            ['rev_d_well','rev_d_improve','rev_d_gratitude','rev_d_tomorrow','rev_w_win','rev_w_learn','rev_w_habit','rev_w_drain','rev_w_focus','rev_m_achieved','rev_m_missed','rev_m_finance','rev_m_growth','rev_m_theme','rev_y_wins','rev_y_regrets','rev_y_grow','rev_y_people','rev_y_vision'].forEach(function(f){ var el=document.getElementById(f); if(el) reviews[date][f]=el.value; });
            reviews[date].dailyRating=reviewRatings.daily;
            reviews[date].yearlyRating=reviewRatings.yearly;
            reviews[date].saved=new Date().toISOString();
            localStorage.setItem(REVIEW_KEY,JSON.stringify(reviews)); clearTimeout(_kvTimer); _saveKv();
            if(!silent){ var m=document.getElementById('reviewSavedMsg'); if(m){m.textContent='✅ Saved!';setTimeout(function(){m.textContent='';},2000);} }
        }
        function setRating(type,val,silent){
            reviewRatings[type]=val;
            var id=type==='daily'?'revDayRating':'revYearRating';
            var container=document.getElementById(id);
            if(container) container.querySelectorAll('.rating-star').forEach(function(s){s.classList.toggle('lit',parseInt(s.dataset.v)<=val);});
            if(!silent) autoSaveReview();
        }

        // ═══════════════════════════════════════════════
        //  📊 MONTHLY PERFORMANCE REPORT
        // ═══════════════════════════════════════════════
        function initReportMonth(){
            var sel=document.getElementById('reportMonth'); if(!sel) return;
            var opts=[];
            var d=new Date();
            for(var i=0;i<24;i++){
                var dd=new Date(d.getFullYear(),d.getMonth()-i,1);
                var key=dd.toISOString().substring(0,7);
                opts.push('<option value="'+key+'">'+key+'</option>');
            }
            sel.innerHTML=opts.join('');
        }
        function generateReport(){
            var month=document.getElementById('reportMonth')?document.getElementById('reportMonth').value:''; if(!month) return;
            var txns=typeof getTransactions==='function'?getTransactions().filter(function(t){return t.month===month;}):[]; 
            var income=txns.filter(function(t){return t.type==='income';}).reduce(function(s,t){return s+t.amount;},0);
            var expense=txns.filter(function(t){return t.type==='expense';}).reduce(function(s,t){return s+t.amount;},0);
            var dtData=typeof getDtData==='function'?getDtData():{};
            var daysInMonth=Object.keys(dtData).filter(function(d){return d.startsWith(month);});
            var completedDays=daysInMonth.filter(function(d){ var tasks=Object.values(dtData[d]).reduce(function(a,b){return a.concat(b);},[]);return tasks.length&&tasks.filter(function(t){return t.done;}).length/tasks.length>=0.5; });
            var reviews=typeof getReviews==='function'?getReviews():{};
            var monthReviews=Object.keys(reviews).filter(function(d){return d.startsWith(month);});
            var ratings=monthReviews.map(function(d){return reviews[d].dailyRating||0;}).filter(function(r){return r>0;});
            var avgRating=ratings.length?(ratings.reduce(function(s,r){return s+r;},0)/ratings.length).toFixed(1):'—';
            var ttLogs=typeof getTimeLogs==='function'?getTimeLogs().filter(function(l){return l.date.startsWith(month);}):[];
            var leakMins=ttLogs.filter(function(l){return l.type==='leak';}).reduce(function(s,l){return s+l.mins;},0);
            var prodMins=ttLogs.filter(function(l){return l.type==='productive';}).reduce(function(s,l){return s+l.mins;},0);
            var decisions=typeof getDecisions==='function'?getDecisions().filter(function(d){return d.date.startsWith(month);}):[];
            var ideas=typeof getIdeas==='function'?getIdeas().filter(function(i){return i.date.startsWith(month);}):[];
            var knNotes=typeof getKnowledgeNotes==='function'?getKnowledgeNotes().filter(function(n){return n.date.startsWith(month);}):[];
            var groceries=typeof getGroceries==='function'?getGroceries().filter(function(g){return g.date.startsWith(month);}):[];
            var grocTotal=groceries.reduce(function(s,g){return s+g.amount;},0);
            window._lastReport={month:month,income:income,expense:expense,net:income-expense,completedDays:completedDays.length,totalTrackerDays:daysInMonth.length,avgRating:avgRating,leakMins:leakMins,prodMins:prodMins,decisions:decisions.length,ideas:ideas.length,knNotes:knNotes.length,txns:txns,grocTotal:grocTotal};
            var catMap={};
            txns.forEach(function(t){ if(!catMap[t.cat]) catMap[t.cat]={inc:0,exp:0}; catMap[t.cat][t.type==='income'?'inc':'exp']+=t.amount; });
            var catRows=Object.entries(catMap).map(function(e){ var cat=e[0],v=e[1]; return '<div class="report-row"><span class="report-lbl">'+cat+'</span><span class="report-val">'+(v.inc?'<span style="color:#26a69a">+'+fmt(v.inc)+'</span> ':''+(v.exp?'<span style="color:#ef5350">-'+fmt(v.exp)+'</span>':''))+'</span></div>'; }).join('')||'<div class="report-row"><span class="report-lbl" style="color:#7a7a8c">No transactions</span></div>';
            var body=document.getElementById('reportBody'); if(!body) return;
            body.innerHTML='<div style="text-align:center;margin-bottom:1rem"><div style="font-size:1.1rem;font-weight:700;color:#ffd78c">📅 Report for '+month+'</div></div><div class="fin-summary-cards"><div class="fin-card green-card"><div class="fin-card-label">💚 Income</div><div class="fin-card-val">'+fmt(income)+'</div></div><div class="fin-card red-card"><div class="fin-card-label">❤️ Expenses</div><div class="fin-card-val">'+fmt(expense)+'</div></div><div class="fin-card gold-card"><div class="fin-card-label">💰 Net Saved</div><div class="fin-card-val">'+fmt(income-expense)+'</div></div><div class="fin-card blue-card"><div class="fin-card-label">⭐ Avg Rating</div><div class="fin-card-val">'+avgRating+'</div></div></div><div class="report-section"><div class="report-section-title">💳 Income & Expense by Category</div>'+catRows+'</div><div class="report-section"><div class="report-section-title">✅ Daily Habit Tracker</div><div class="report-row"><span class="report-lbl">Days Tracked</span><span class="report-val">'+daysInMonth.length+'</span></div><div class="report-row"><span class="report-lbl">Days 50%+ Completed</span><span class="report-val">'+completedDays.length+'</span></div><div class="report-row"><span class="report-lbl">Habit Score</span><span class="report-val">'+(daysInMonth.length?Math.round(completedDays.length/daysInMonth.length*100):0)+'%</span></div></div><div class="report-section"><div class="report-section-title">⏱️ Time Management</div><div class="report-row"><span class="report-lbl">Productive Time</span><span class="report-val" style="color:#26a69a">'+Math.floor(prodMins/60)+'h '+(prodMins%60)+'m</span></div><div class="report-row"><span class="report-lbl">Time Leaked</span><span class="report-val" style="color:#ef5350">'+Math.floor(leakMins/60)+'h '+(leakMins%60)+'m</span></div></div><div class="report-section"><div class="report-section-title">🧠 Growth & Productivity</div><div class="report-row"><span class="report-lbl">Decisions Logged</span><span class="report-val">'+decisions.length+'</span></div><div class="report-row"><span class="report-lbl">Ideas Captured</span><span class="report-val">'+ideas.length+'</span></div><div class="report-row"><span class="report-lbl">Knowledge Notes</span><span class="report-val">'+knNotes.length+'</span></div><div class="report-row"><span class="report-lbl">Reviews Written</span><span class="report-val">'+monthReviews.length+'</span></div></div><div class="report-section"><div class="report-section-title">🛒 Grocery</div><div class="report-row"><span class="report-lbl">Purchases</span><span class="report-val">'+groceries.length+'</span></div><div class="report-row"><span class="report-lbl">Total Spent</span><span class="report-val" style="color:#ef5350">'+fmt(grocTotal)+'</span></div></div>';
        }
        function downloadReportPdf(){
            if(!window._lastReport){alert('Click Generate first');return;}
            var r=window._lastReport;
            var lines=['MY DIARY — MONTHLY PERFORMANCE REPORT','='.repeat(50),'Month: '+r.month+'  |  Generated: '+new Date().toLocaleString(),'','━━━ FINANCIAL SUMMARY ━━━','Income:    '+fmt(r.income),'Expenses:  '+fmt(r.expense),'Net Saved: '+fmt(r.net),'','━━━ DAILY HABIT TRACKER ━━━','Days Tracked: '+r.totalTrackerDays,'Days 50%+:    '+r.completedDays,'Habit Score:  '+(r.totalTrackerDays?Math.round(r.completedDays/r.totalTrackerDays*100):0)+'%','','━━━ TIME MANAGEMENT ━━━','Productive: '+Math.floor(r.prodMins/60)+'h '+(r.prodMins%60)+'m','Leaked:     '+Math.floor(r.leakMins/60)+'h '+(r.leakMins%60)+'m','','━━━ GROWTH ━━━','Decisions: '+r.decisions,'Ideas: '+r.ideas,'Knowledge Notes: '+r.knNotes,'','━━━ GROCERY ━━━','Total: '+fmt(r.grocTotal),'','━━━ TRANSACTIONS ━━━','Date,Type,Category,Description,Amount'].concat(r.txns.map(function(t){return new Date(t.date).toLocaleDateString()+','+t.type+','+t.cat+',"'+t.desc+'",'+(t.type==='income'?'+':'-')+t.amount;}));
            var blob=new Blob([lines.join('\n')],{type:'text/plain'});
            var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='MyDiary_Report_'+r.month+'.txt'; a.click();
        }
        function downloadReportExcel(){
            if(!window._lastReport){alert('Click Generate first');return;}
            var r=window._lastReport;
            var rows=[['MY DIARY — REPORT: '+r.month],[],['FINANCIAL SUMMARY'],['Income',r.income],['Expenses',r.expense],['Net',r.net],[],['HABIT TRACKER'],['Days Tracked',r.totalTrackerDays],['Completed',r.completedDays],[],['TIME'],['Productive mins',r.prodMins],['Leaked mins',r.leakMins],[],['GROWTH'],['Decisions',r.decisions],['Ideas',r.ideas],['Notes',r.knNotes],[],['GROCERY','',fmt(r.grocTotal)],[],['TRANSACTIONS'],['Date','Type','Category','Description','Amount']].concat(r.txns.map(function(t){return [new Date(t.date).toLocaleDateString(),t.type,t.cat,t.desc,(t.type==='income'?1:-1)*t.amount];}));
            var csv=rows.map(function(row){return row.map(function(c){return '"'+String(c||'').replace(/"/g,'""')+'"';}).join(',');}).join('\n');
            var blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8'});
            var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='MyDiary_Report_'+r.month+'.csv'; a.click();
        }

        // Finance: extend tx month filter with yearly & custom range
        function populateTxMonthFilterExtended(){
            var txns=typeof getTransactions==='function'?getTransactions():[];
            var months=[...new Set(txns.map(function(t){return t.month;}))].sort().reverse();
            var years=[...new Set(months.map(function(m){return m.substring(0,4);}))];
            var sel=document.getElementById('tx_filter_month'); if(!sel) return;
            sel.innerHTML='<option value="">All Time</option><optgroup label="📅 Custom Range"><option value="custom_range">Custom Range…</option></optgroup><optgroup label="📆 By Year">'+years.map(function(y){return '<option value="year_'+y+'">Year '+y+'</option>';}).join('')+'</optgroup><optgroup label="📅 By Month">'+months.map(function(m){return '<option value="'+m+'">'+m+'</option>';}).join('')+'</optgroup>';
        }

        // ═══════════════════════════════════════════════
        //  initDB is called by loginSuccess() after authentication
        // ═══════════════════════════════════════════════
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-zoom/2.0.1/chartjs-plugin-zoom.min.js"></script>
    <!-- Firebase removed — storage handled by Supabase -->
</body>
</html>